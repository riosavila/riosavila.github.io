{
  "hash": "1a4b5b284215f5ab7886627b51017353",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Synthetic Control\nsubtitle: Frankensteining a Clone\nauthor: Fernando Rios-Avila\nformat:\n  revealjs:\n    slide-number: true\n    width: 1500\n    height: 900\n    code-fold: true\n    echo: true\n    css: styles.css\n    theme: simple\n  pdf: default\nexecute:\n  freeze: true\n---\n\n## Introduction\n\n- One more last time. What is the Goal of Causal Analysis?\n\n:::{.callout-important}\n**The goal of Causal Analysis is to identify how a treatment affects the outcome by itself, once all other factors are kept constant or controlled for.**\n:::\n\nFrom a theoretical point of view, that is very easy. You simply compare two Potential outcomes:\n\n$$\nTE_i = y_i(1)- y_i(0)\n$$\n\nand aggregate those outcomes as needed:\n\n$$\nATT=E(TE_i|D=1);ATU=E(TE_i|D=0);ATE=E(TE_i);ATX=E(TE_i|X)\n$$\n\n##\n\nUnfortunately, we only observe one outcome. You are either treated or untreated...So how do we fix this?\n\nYou need to find counterfactuals so both observed ($X$) and unobserved ($e$) are the same (or close) between treated and contro group.\n\n1. **RCT**: Gold Standard, You randomize treatment and compare means. If correctly done, $X's$ and $e's$ will be comparable across groups, and ATE's can be identified.\n  \n2. **Reg + FE**: For other cases, we just work with observational data. First method, Regression (OLS?). Adding covariates controls for their presence, working as a pseudo balancing approach.\n   \n   You could also add *fixed effects*, to control for factors that are fixed (across time), but you do not observe. (requires Panel data).\n\n   It works if Treatment occurs at the same time for everyone treated. and if Unobserved are \"fixed\"\n\n##\n\n3. **Instrumental variables**: 2nd Best to RCT. It uses IV to generate a small randomization process that can be used for estimating ATT. Technically it compares the effect among those potentially affected by the random instrument.\n   Requires Randome instrument, and no-defiers. Its a Local ATE\n\n4. **Matching and Reweigthing**. Similar to Regression, but better to balance characteristics. The goal is to find units with similar characteristics for all treated units. You can estimate ATE, ATT or ATU. Depends on how well Matching is done\n\n5. **RDD**. If you have data where treatment depends on a single variable and a threshold, you can use this to identify TE for those \"Near\" the threshold. They Key assumption, treatment assigment is as good at random at the threshold.\n\n##\n\n6. **DD**. Differences in differences uses variation across time and across individual to identify treatment effects. Under PTA, and SUTVA\n   \n   Dif. within individuals eliminates common time trends, Dif across time, eliminates individual fixed effects. DD provide you with ATT's for the treated, after treatment. \n\n   $$ATT=(Y_{g=1,t=1}-Y_{g=1,t=0}) - [(Y_{g=0,t=1}-Y_{g=0,t=0})]$$\n\n   Can be generalized to Many periods and many groups, but requires stronger assumptions (no anticipation and no change in treatment status), and further aggregation.\n\n   Or combined with Matching for even better results.\n\n## Synthetic Control: Special case\n\nAs previous Cases, Synthetic control aims to identify treatment constructing appropriate \"counterfactuals\".\n\nIt is said that Synthethic controls may be even MORE credible methodology, because the treated group is by construction Exogenous...but how?\n\n> The treated group is a Case Study. \n> \n> An isolated event or unit that is affected by a treatment, and should not affect other units ! \n\nIn this sense, the treatment is exogenous, because it affected a single unit. \n\nBut what about the counterfactual?\n\n## \n\n- In other methods (in particular Matching), our \"conterfactual\" mean to look for observations that had the same characteristics as the treated observation. \n\n- Some times, we needed to settle to use a single \"bad\" control, because we couldnt find one better. (people are very different).\n  - Using Stricter criteria would make it unfeasible.\n  - More relax and we have lots of biases.\n\n- **SC** is different. You have **MANY** controls, so why settle with only one? \n  \n- **SC** is like Dr Frankenstein, where you \"build\" a single comparison group by averaging information of all controls.\n\n- You build the synthetic control getting \"weighted averages\".\n\n- But...we assume you can see all units across time (panel data)\n\n## This is a very popular method\n\nWhere has this method been used: \n\n- effects of right-to-carry laws (Donohue et al., 2019), \n- legalized prostitution (Cunningham and Shah, 2018), \n- immigration policy (Bohn et al., 2014), \n- corporate political connections (Acemoglu et al., 2016), \n- taxation (Kleven et al., 2013), \n- organized crime (Pinotti, 2015) \n\nJust to name a few. \n\n## Assumptions:\n\n1. The Donor Pool should be a good match for the treated unit. Thus, the synthethic control should be Zero before treatment.\n   \n   - This is similar to PTA, but stronger. Before treatment, there should be no difference between Treated and synthetic control\n\n2. SUTVA. Only the treated group is affected by treatment. The control group should be unaffected (no spill over effects).\n\n3. There should be NO other \"event\" in the period of analysis. (Thus we only capture treatment impact)\n\n## How does it work.\n\nRecall, we want to estimate TE for the single untreated unit:\n\n$$ATT_{1t} = Y_{1t}- Y(0)_{1t}\n$$\n\nbut we do not observe $Y(0)_{1t}$. We only know that before treatment \n\n$$ATT_{1t} = Y_{1t}- Y(0)_{1t}=0$$\n\nWe could construct a synthetic control:\n\n$$\\hat Y_{1t}(0) = \\sum_{i = 2}^N w_i Y_{it} \n$$\n\nAt the very least, the weights $w$ should be such that before treatment ($G$):\n\n$$Y_{1t} = \\sum_{i \\neq 1} w_i Y_{it} \\ \\forall \\ t<G $$\n\n## \n\nAt the very least, the weights $w$ should be such that before treatment ($G$):\n\n$$Y_{1t} = \\sum_{i \\neq 1} w_i Y_{it} \\ \\forall \\ t<G $$\n\nHavent we seen seen something like this Before? OLS:\n\n$$y = x\\beta + e$$\n$$y^t_{1} = \\color{red}{a_0} +  y_i^t w + e$$\n\n$$\n\\begin{bmatrix}\ny^1_1 \\\\ y^1_2 \\\\ ... \\\\ y^1_{G-1} \\\\ \n\\end{bmatrix} = \\color{red}{a_0} +\n\\begin{bmatrix}\ny^2_1 & y^3_1 & ... & y^k_1  \\\\ \ny^2_2 & y^3_2 & ... & y^k_2 \\\\\n ...  & ... & ... & ...\\\\\ny^2_{G-1} & y^3_{G-1} & ... & y^k_{G-1}\\\\ \n\\end{bmatrix} \n\\begin{bmatrix}\nw_2 \\\\ w_3 \\\\ ... \\\\ w_k\n\\end{bmatrix} \n + e\n$$\n\n##\n\n$$y^t_{1} = \\color{red}{a_0} +  y_i^t w + e$$\n\n- In this Specification, each row (observation) is a \"pre-treatment\" period of observed data. \n- and each control unit (from the many controls) will be a variable.\n\nOLS can help you find the weights, which can then be used for obtaining the \"Synthetic\" control\n\n## Small Example \n\n::: {#e9f7b3b4 .cell execution_count=1}\n``` {.stata .cell-code code-fold=\"true\"}\nqui:frause smoking, clear\ncolor_style tableau\nbysort year:egen mean_cig=mean(cigsale) if state!=3\ntwo (line cigsale year if state ==3) (line mean_cig year if state==1), ///\n    legend(order(1 \"California\" 2 \"Avg Other States\") pos(6) col(2)) xline(1988)\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<style>div.jp-Notebook .datagrid-container {min-height: 448px; }</style>\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n(31 missing values generated)\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](13SC_files/figure-revealjs/cell-2-output-3.png){}\n:::\n:::\n\n\n## \n\n::: {#1589abe2 .cell execution_count=2}\n``` {.stata .cell-code}\ndrop mean_cig\nqui:reshape wide cigsale lnincome beer age15to24 retprice , i(year) j(state)\nren cigsale1 mcigsale\n```\n:::\n\n\n- Now we have...38 variables, (other States but California)\n- And 31 periods (only 19 Before treatment)\n- Can we estimate the weights using OLS?\n \n...\n\n- Nop. N<K !\n\n## \n\n::: {#bca9bbdc .cell execution_count=3}\n``` {.stata .cell-code code-fold=\"true\"}\nqui:reg mcigsale cigsale* if year<=1988, nocons\npredict mcigh1\nqui: lasso linear  mcigsale cig* if year<=1988, nocons\npredict mcigh2\n two (line mcigsale year, lw(0.5)  ) ///\n  (line mcigh1 mcigh2   year, lw(0.5)  ) , ///\n  legend(order(1 \"California\" 2 \"OLS Synthetic\" 3 \"LASSO Synthetic\")) xline(1988)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(option xb assumed; fitted values)\n(options xb penalized assumed; linear prediction with penalized coefficients)\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](13SC_files/figure-revealjs/cell-4-output-2.png){}\n:::\n:::\n\n\n- OLS Not appropriate (specially if N<K)\n- Lasso Better, because of regularization, but not great.\n- We are not controlling for other factors either (controls)\n- Other Details we cover next\n  \n## Allowing for Covariates:\n\n- As with other methodologies, one should also considered controlling for covariates.\n- Specifically, more covariates can be allowed by Stacking them:\n\n$$\\begin{bmatrix} y^t_{1} \\\\ x^t_{1} \\\\ z^t_{1} \\end{bmatrix}\n= \\color{red}{(a_0=0)} + \n\\begin{bmatrix} y^t_{2} & y^t_{3} ... & y^t_{k} \\\\ \n                x^t_{2} & x^t_{3} ... & x^t_{k} \\\\ \n                z^t_{2} & z^t_{3} ... & z^t_{k} \\end{bmatrix}\n\\begin{bmatrix} w_2 \\\\ w_3 \\\\ ... \\\\ w_k \\end{bmatrix}\n+ e\n$$\n\n##\n\n::: {#b8db1c44 .cell execution_count=4}\n``` {.stata .cell-code code-fold=\"true\"}\nqui:frause smoking, clear\nren (cigsale lnincome beer age15to24 retprice) ///\n\t  (var1    var2     var3 var4      var5)\nqui: reshape long var, i(state year)\tj(new)\nqui: reshape wide var, i(year new)\tj(state)\nlabel define new 1 \"cigsale\" ///\n\t\t\t\t 2 \"lnincome\" ///\n\t\t\t\t 3 \"beer\" ///\n\t\t\t\t 4 \"age15to24\" /// \n\t\t\t\t 5 \"retprice\", modify\nlabel values new new\t\nren var3 cal_out\nqui:reg cal_out var* if year<=1988, nocons\npredict mcigh1\nqui: lasso linear   cal_out var* if year<=1988, nocons\npredict mcigh2\n two (line cal_out year if new==1, lw(0.5)  ) ///\n  (line mcigh1 mcigh2   year if new==1, lw(0.5)  ) , ///\n  legend(order(1 \"California\" 2 \"OLS Synthetic\" 3 \"LASSO Synthetic\")) xline(1988)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(option xb assumed; fitted values)\n(32 missing values generated)\n(options xb penalized assumed; linear prediction with penalized coefficients)\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](13SC_files/figure-revealjs/cell-5-output-2.png){}\n:::\n:::\n\n\n## What else to keep in mind\n\n- With More Variables, the goal is still to be able to choose $w's$ that best explain the observed outcomes (and characteristics) of the \"treated unit\".\n\n$$w = \\min_w \\sum_{m=1}^K \\left[ v_m \\left( X_{1t}-\\sum_{j=2}^J w_j X_{jt}  \\right)^2 \\right] \n$$\n\nHowever, we also need to impose restrictions on Weights:\n\n1. $w_j \\geq 0$ Weights cannot be negative.\n2. $\\sum w_j =1$ They should sum up to 1. \n3. $v_m$ can be used to increase, or reduce the relative importance of factors in the model. (lower bound at 0)\nThe constant is zero.\n\nThis is a maximization problem with constrains. Restrictions ensure the prediction is based on a \"convex\" set, avoiding extrapolation. \n\n## Is it noise? or Causal?\n\n- When using **SC**, you essentially have a sample $n=1$ to estimate an effect. How do you know that effect is significant? and not just noise?\n\n  - You can do a randomization experiment! and answer:\n\n> “how unusual is this estimate under the null hypothesis of no policy effect?”.\n\n- How does this work? \n\n## Randomization\n\n1. Excluding the treated unit, estimate the pseudo effect of every other unit in the dataset. These are placebos, and you should expect the effect to be zero for them...but you may see some positive and negative effects. \n   \n   - This may be consider the sampling distribution of the estimated effect.\n\n2. Calculate the pre- and post- treament *Root mean squared prediction error* for all units (treated and placebos). \n   \n   - Pre-RMSPE provides a statistic of how well the model fits before treatment. \n   - Post-RMSPE provides a statistic of how unusual is the outcome after the \"treatment date\". The largest it is, the more unpredictable (or stronger treatment effect) it would be.\n\n## \n \n  $$\n  \\begin{aligned}\n  RMSPE_i^{pre} &= \\sqrt{ \\frac{1}{g-1}\\sum_{t=1}^{g-1}(y_{i,t}-\\sum_{j\\neq i}w_j^i y_{j,t})^2 } \\\\\n  RMSPE_i^{post} &= \\sqrt{ \\frac{1}{T-g+1}\\sum_{t=g}^{T}(y_{i,t}-\\sum_{j\\neq i}w_j^i y_{j,t})^2 } \n  \\end{aligned}\n  $$\n\n3. Estimate the ratio between Pre and Post RMSPE, and rank them.\n$$Ratio_i = \\frac{RMSPE_i^{post}}{RMSPE_i^{pre}}\n$$\n\n4. The p-value for the treatment is proportional to the Rank:\n   \n   $$pvalue_i = \\frac{rank(i)}{Tot}$$\n  \n## Lets continue the example:\n\n::: {#cb7066b4 .cell execution_count=5}\n``` {.stata .cell-code code-fold=\"true\"}\nqui:frause smoking, clear\nxtset state year\ntempfile sc3\n** For California\nsynth cigsale cigsale(1970) cigsale(1975) cigsale(1980) cigsale(1985) cigsale(1988), trunit(3) trperiod(1989) keep(`sc3') replace\n** Same Specification for All other States excluding California\nforvalues i =1/39{\n\tif `i'!=3 {\n\t\tlocal pool\n\t\tforeach j of local stl {\n\t\t\tif `j'!=3 & `j'!=`i' local pool `pool' `j'\n\t\t}\n\t\ttempfile sc`i'\n\t\tsynth cigsale cigsale(1970) cigsale(1975) cigsale(1980) cigsale(1985) cigsale(1988), ///\n\t\ttrunit(`i') trperiod(1989) keep(`sc`i'') replace counit(`pool')\n\t}\n}\n** Some data cleaning and prepration\nforvalues i =1/39{\n\tuse `sc`i'' , clear\n\tgen tef`i' = _Y_treated - _Y_synthetic\n\tegen sef`i'a =mean( (_Y_treated - _Y_synthetic)^2) if _time<=1988\n\tegen sef`i'b =mean( (_Y_treated - _Y_synthetic)^2) if _time>1988\n  replace sef`i'a=sqrt(sef`i'a[1])\n\treplace sef`i'b=sqrt(sef`i'b[_N])\n\tdrop if _time==.\n\tkeep tef`i' sef`i'* _time\n\tsave `sc`i'', replace\n}\n**\n** Merging all together, and getting ready to plot\n** \n\nuse `sc1', clear\nforvalues i = 2/39 {\n\tmerge 1:1 _time using `sc`i'', nogen\n}\nglobal toplot\nglobal toplot2\n\nforvalues i = 1/39 {\n\tglobal toplot $toplot (line tef`i' _time, color(gs11) )\n  if (sef`i'a[1])<(2*sef3a[1]) {\n\t\tglobal toplot2 $toplot2 (line tef`i' _time, color(gs11) )\n \t}\n}\n```\n:::\n\n\n**All Cases**\n\n::: {#f078e343 .cell execution_count=6}\n``` {.stata .cell-code}\ntwo $toplot (line tef3 _time, lw(1) color(navy*.8)), xline(1989) legend(off)\n```\n\n::: {.cell-output .cell-output-display}\n![](13SC_files/figure-revealjs/cell-7-output-1.png){}\n:::\n:::\n\n\n##\n\n**Good Cases**\nRestricts to States with Good RMSEP (less than 2 California)\n\n::: {#420eff27 .cell execution_count=7}\n``` {.stata .cell-code}\ntwo $toplot2 (line tef3 _time, lw(1) color(navy*.8)), xline(1989) legend(off)\n```\n\n::: {.cell-output .cell-output-display}\n![](13SC_files/figure-revealjs/cell-8-output-1.png){}\n:::\n:::\n\n\n## RMSE Ratio\n\n::: {#d5e10360 .cell execution_count=8}\n``` {.stata .cell-code}\nforvalues i = 1/39 {\n  if (sef`i'a[1])<(2*sef3a[1]) {\n\t\tmatrix rt=nullmat(rt)\\[`i',sef`i'b[1]/sef`i'a[1]]\n \t}\n}\nsvmat rt\negen rnk=rank(rt2)\n \ntwo bar rt2 rnk || bar rt2 rnk if rt1==3 , ///\n legend(order( 2 \"California\")) ///\n  ytitle(RMSE ratio)  xtitle(RMSE rank)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nnumber of observations will be reset to 32\nPress any key to continue, or Break to abort\nNumber of observations (_N) was 31, now 32.\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](13SC_files/figure-revealjs/cell-9-output-2.png){}\n:::\n:::\n\n\n## p-values\n\n::: {#381b9e5c .cell execution_count=9}\n``` {.stata .cell-code}\n gen rnk2=0\nforvalues i = 1/39 {\n\tif   (sef`i'a[1])<(2*sef3a[1]) {\n\t\tlocal t = `t'+1\n\t\treplace rnk2=rnk2+(tef`i'<=tef3)\t\n\t}\n} \ngen pv=rnk2*100/`t'\n \ntwo bar pv _time if _time>1988 & rnk2<32, ylabel(0(2)15) xlabel(1989/2000)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(10 real changes made)\n(6 real changes made)\n(32 real changes made)\n(5 real changes made)\n(9 real changes made)\n(3 real changes made)\n(5 real changes made)\n(4 real changes made)\n(6 real changes made)\n(4 real changes made)\n(4 real changes made)\n(8 real changes made)\n(5 real changes made)\n(4 real changes made)\n(8 real changes made)\n(3 real changes made)\n(5 real changes made)\n(8 real changes made)\n(5 real changes made)\n(5 real changes made)\n(7 real changes made)\n(2 real changes made)\n(4 real changes made)\n(4 real changes made)\n(2 real changes made)\n(6 real changes made)\n(3 real changes made)\n(6 real changes made)\n(8 real changes made)\n(5 real changes made)\n(4 real changes made)\n(6 real changes made)\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](13SC_files/figure-revealjs/cell-10-output-2.png){}\n:::\n:::\n\n\n## Other Falsification Tests\n\n- Change of treatment Year. \n  - In the manual implementation you may want to change the treatment year (to an earler point). \n  One should see no effect between *false* treatment date and the true to be zero.\n  - Using `synth` (Stata) you may want to drop some of the controls, so only \"pre-false\" treatment data is used.\n    - Look also into `synth_runner`\n- Change of Outcome.\n  - One can estimate the effect on alternative outcomes. No effect should be estimated.\n\n\n## Conclusions\n\n- The basic methodology presented here differs from other strategies because one uses a single treated unit, with pletora of treated groups. \n\n- Instead of comparing single units with the treated group, it aims to compare a weighted average \"synthetic control\" to do so.\n- It will work better than matching because you are focusing on getting the best \"weighted\" group for a single unit. \n\n- But this methodology is still under development, with extensions toward using dissagregated data, or a combination with DD approaches. \n\n- This may change how much more one can do with the method\n\n#\n\n![](https://wallpapercave.com/dwp1x/wp8641362.jpg)\n\n# Next week:\nYour papers! \nAnd Goodluck Friday\n\n",
    "supporting": [
      "13SC_files\\figure-revealjs"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}