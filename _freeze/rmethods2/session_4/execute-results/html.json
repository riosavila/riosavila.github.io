{
  "hash": "f1db86880a5c10bffd776e74b52e487d",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Research Methods II\"\nsubtitle: \"Analyzing Gaps\"\nauthor: Fernando Rios-Avila\nformat: \n  revealjs: \n    slide-number: true\n    width: 1600\n    height: 900\n    code-fold: true\n    echo: true\n    css: styles.css \n---\n\n## Introduction\n\n> What do we mean by decomposition?\n\n- In Economics, decomposition refers to the process breaking down an index or aggregate measure into factors that explain it.\n\n- We have done some of this last week with Decomposition by groups and sources.\n\n- But there are other types of decompositions that are useful in Economics.\n\n$$\n\\begin{aligned}\ny &=A L^\\alpha K ^\\beta \\\\\n\\frac{\\Delta y}{y} &=\\frac{\\Delta A}{A} + \\alpha \\frac{\\Delta L}{L} + \\beta \\frac{\\Delta K}{K}\n\\end{aligned}\n$$\n\n- Today we will focus on a different kind of Decomposition: **Decomposition of gaps**.\n\n##\n### Introduction to Oaxaca-Blinder Decomposition\n\n- The most common type of decomposition of gaps is the Oaxaca-Blinder Decomposition.\n\n- The idea behind is as follows:\n\n  - There are two groups you are interested in comparing.\n  - Group A has a higher average value of a variable of interest than Group B.\n    - What explains the difference??\n  - The Oaxaca-Blinder Decomposition allows you to answer this question.\n    - The difference could be due to differences in the characteristics \n    - Or it could be due to differences in the **returns** to those characteristics.\n\n##\n### Introduction to Oaxaca-Blinder Decomposition\n\n- In  1973 Oaxaca and Blinder independently proposed a very similar method to decompose the differences in averages value of a variable of interest between two groups.\n\n>“Male-Female Wage Differentials in Urban Labor Markets” Oaxaca (IER 1973)\n\n>“Wage Discrimination: Reduced Form and Structural Estimates” Blinder (JHR 1973)\n\n- Which become the basis for what is known as the Oaxaca-Blinder Decomposition.\n- Heavily used in Labor Economics, it can be helpful to explain what factors relate to: Union premiums, povery gaps, gender wage gaps, etc.\n \n# Oaxaca-Blinder Decomposition\n\n##\n### General Framework\n\n- Suppose we have two groups: $A$ and $B$, with Data generating processes (DGP) that are defined as:\n\n$$\\begin{aligned}\nY_a = G_a(X_a,\\epsilon_a) \\\\\nY_b = G_b(X_b,\\epsilon_b) \\\\\n\\end{aligned}\n$$  \n\n- Differences between two groups could be explain by:\n  - Differences in observed characteristics $X_a$ and $X_b$\n  - Differences in unobserved $\\epsilon_a$ and $\\epsilon_b$\n  - Differences in the Funcional forms $G_a$ and $G_b$\n  \n- To some extent, this suggests something akin to a **counterfactual**.\n\n##\n### Imposing Restrictions\n\nTo implement OB, we need to impose some restrictions on the model.\n\n**1st** Functional form: Linear in parameters\n$$G_a(X_k,\\epsilon_k) = X_k \\beta_k + \\epsilon_k\n$$\n\n**2nd** Errors are independent by group:\n$$\\varepsilon_i \\perp D | X_i\n$$\n\nThis makes it possible to have other problems in the model (like endogeneity) and still get **aggregate** consistent estimates. (but lets assume Zero Conditional Mean )\n\n**3rd** Homoskedastic (across groups)\n\n**4th** We only care about Differences in means\n\n##\n### OB In Action\n\n- Suppose the models are given by:\n\n$$Y_k = X_k \\beta_k + \\epsilon_k\n$$\n\n- Then, the \"average\" outcome for each group is given by:\n\n$$\\bar Y_k =\\bar X_k \\beta_k\n$$\n\n- This is useful, because we could now use it for creating a counterfactual.\n  - $\\bar X_a \\beta_a$ is the average wage of group A\n  - $\\bar X_b \\beta_a$ is the average wage of group B if \"paid like\" group A.\n    - or  Average Wages of Group A if they had the characteristics of Group B.\n\n- With this, we can now obtain the OB Decomposition.\n\n##\n###\n\n$$\\begin{aligned}\n\\Delta \\bar Y &= \\bar Y_a - \\bar Y_b \\\\\n&= \\bar X_a \\beta_a - \\bar X_b \\beta_b \\\\\n\\end{aligned}\n$$  \n\n- Now we need a Counterfactual: What if Group A were paid as of Group B? $\\bar X_a \\beta_b$\n\n$$\\begin{aligned}\n\\Delta \\bar Y &= \\bar Y_a - \\bar Y_b + \\bar Y^c_a - \\bar Y^c_a\\\\\n&= \\color{blue}{\\bar X_a \\beta_a} - \\color{red}{\\bar X_b \\beta_b + \\bar X_a \\beta_b} - \\color{blue}{\\bar X_a \\beta_b} \\\\\n&= \\color{blue}{(\\bar X_a \\beta_a- \\bar X_a \\beta_b)}  + \\color{red}{ (\\bar X_a \\beta_b - \\bar X_b \\beta_b)} \\\\\n&= \\color{blue}{\\bar X_a (\\beta_a- \\beta_b)}  + \\color{red}{  (\\bar X_a - \\bar X_b) \\beta_b} \\\\\n&= \\color{blue}{\\bar X_a \\Delta \\beta}  + \\color{red}{  \\Delta \\bar X \\beta_b} \\\\\n\\end{aligned}\n$$\n\nThus Differences in averages is decomposed into two parts:\n\n  - Diff in $X's$ and (weighted by $\\beta_b$)\n  - Diff in $\\beta's$. (weighted by $\\bar X_a$)\n\n##\n### OB: From Aggregate to detailed\n\n- The previous decomposition is for Aggregates.\n  - They are robust to endogeneity, (if endogeneity is the same across groups)\n- If the model is correctly specified, we can also decompose the differences in the detailed level.\n\n$$\\begin{aligned}\n\\Delta X \\beta_b &= \\beta_{a0}-\\beta_{b0} + \\sum_{j=1}^k \\bar X_{aj}(\\beta_{aj} - \\beta_{bj}) \\\\\n\\bar X_a \\Delta \\beta &= \\sum_{j=1}^k (\\bar X_{aj} - \\bar X_{bj}) \\beta_{bj}\n\\end{aligned}\n$$\n\n##\n### Note:\n\n- The decomposition is not unique. \n  - Depends on the \"counterfactual\" we choose.\n- The decomposition is not causal, but may be indicative of potential causes.\n- The decomposition is not a test of discrimination.\n  - As it does not assess why the differences in $\\beta$ exist, nor what explains the differences in $\\bar X$.\n\n##\n### In a picture\n\n:::{.panel-tabset} \n\n## Option 1\n\n![](s4_fig1.png)\n\n## Option 2\n\n![](s4_fig2.png)\n\n## note\n\n- Neither option is \"correct\" or \"incorrect\". \n- They are just different ways of measuring the gaps.\n- However, you may want to consider which one is more appropriate for your research question.\n- Or consider other decomposition options \n  - Single Ref group with 3-way Decomposition\n   \n:::\n\n##\n### 3-way Decomposition\n\n::: {.panel-tabset}\n\n## Option 1\n\n![](s4_fig3.png)\n\n## Option 2\n\n![](s4_fig4.png)\n\n## note\n\n- Mathematically:\n\n$$\\begin{aligned}\n\\Delta \\bar Y &= \\bar Y_a - \\bar Y_b \\\\\n&= \\bar X_a \\beta_a - \\bar X_b \\beta_b \\\\\n&= \\bar X_a \\Delta \\beta  +   \\Delta \\bar X \\beta_b +   \\Delta \\bar X \\beta_a - \\Delta \\bar X \\beta_a \\\\ \n&= {\\bar X_a \\Delta \\beta}  + \\Delta \\bar X \\beta_a - \\Delta \\bar X \\Delta \\beta \\\\\n\\text{ or } \\\\\n&= \\bar X_a \\Delta \\beta  +   \\Delta \\bar X \\beta_b +   \\bar X_b \\Delta \\beta - \\bar X_b \\Delta \\beta  \\\\\n&= \\bar X_b \\Delta \\beta + \\Delta \\bar X \\beta_b + \\Delta X \\Delta \\beta\n\\end{aligned}\n$$\n\n:::\n\n## Example: {.scrollable}\n\n::: {#3b0cb851 .cell .larger execution_count=1}\n``` {.stata .cell-code}\nfrause oaxaca, clear\ndrop if lnwage == .\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<style>div.jp-Notebook .datagrid-container {min-height: 448px; }</style>\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n(Excerpt from the Swiss Labor Market Survey 1998)\n(213 observations deleted)\n```\n:::\n:::\n\n\nFirst things first: \n\n- Define your groups of interest: Men vs Women\n- Identify your model of interest: Simple Specification\n- And obtain Summary Statistics\n\n::: {#732577c3 .cell .larger execution_count=2}\n``` {.stata .cell-code}\ntabstat lnwage educ exper age married , by(female)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nSummary statistics: Mean\nGroup variable: female (sex of respondent (1=female))\n\n  female |    lnwage      educ     exper       age   married\n---------+--------------------------------------------------\n       0 |  3.440222  11.81425  14.07684  38.43142  .5219707\n       1 |  3.266761  11.23206  12.13769  39.28697  .4128843\n---------+--------------------------------------------------\n   Total |  3.357604  11.53696  13.15324  38.83891  .4700139\n------------------------------------------------------------\n```\n:::\n:::\n\n\n::: {#de68c974 .cell .larger execution_count=3}\n``` {.stata .cell-code code-fold=\"true\"}\ngen cns = 1\nqui:mean educ exper age married cns if female == 0\nmatrix x_men = e(b)\nqui:mean educ exper age married cns if female == 1\nmatrix x_women = e(b)\n```\n:::\n\n\nSecond, estimate models of interest\n\n::: {#996035f6 .cell .larger execution_count=4}\n``` {.stata .cell-code}\nqui: reg lnwage educ exper age married if female==0\nest sto men\nmatrix b_men = e(b)\nqui: reg lnwage educ exper age married if female==1\nmatrix b_women = e(b)\nest sto women\nesttab men women, nogaps se mtitle(\"Men\" \"Women\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n--------------------------------------------\n                      (1)             (2)   \n                      Men           Women   \n--------------------------------------------\neduc               0.0540***       0.0853***\n                (0.00595)       (0.00871)   \nexper            -0.00495*        0.00776*  \n                (0.00197)       (0.00346)   \nage                0.0216***      0.00808** \n                (0.00202)       (0.00271)   \nmarried             0.173***       -0.121** \n                 (0.0293)        (0.0421)   \n_cons               1.950***        1.947***\n                 (0.0757)         (0.124)   \n--------------------------------------------\nN                     751             683   \n--------------------------------------------\nStandard errors in parentheses\n* p<0.05, ** p<0.01, *** p<0.001\n```\n:::\n:::\n\n\n::: {#5a60874c .cell .larger execution_count=5}\n``` {.stata .cell-code}\nmatrix DX = x_men - x_women \nmatrix DB = b_men - b_women\n\nmatrix DX_bw = DX * b_women'\nmatrix Xm_Db = x_men * DB'\n\nmatrix DX_bm = DX * b_men'\nmatrix Xw_Db = x_women * DB'\n\nmatrix dDX_bw = vecdiag(DX' * b_women)'\nmatrix dXm_Db = vecdiag(x_men' * DB)'\n\nmatrix dDX_bm = vecdiag(DX' * b_men)'\nmatrix dXw_Db = vecdiag(x_women' * DB)'\n\n** Total Gap Returns\nmatrix result = DX_bw + Xm_Db, DX_bw, Xm_Db, DX_bm, Xw_Db\nmatrix result =result\\ dDX_bw + dXm_Db, dDX_bw, dXm_Db, dDX_bm, dXw_Db\nmatrix colname result = DY  DX_bw Xm_Db DX_bm  Xw_Db\nmatrix coleq result = \"\" op1 op1 op2 op2\n\n\nmatrix list result, format(%9.4f)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nresult[6,5]\n                      op1:     op1:     op2:     op2:\n              DY    DX_bw    Xm_Db    DX_bm    Xw_Db\n     y1   0.1735   0.0446   0.1289   0.0222   0.1513\n   educ  -0.3192   0.0496  -0.3689   0.0315  -0.3507\n  exper  -0.1638   0.0150  -0.1789  -0.0096  -0.1542\n    age   0.5141  -0.0069   0.5210  -0.0185   0.5326\nmarried   0.1401  -0.0132   0.1533   0.0189   0.1213\n  _cons   0.0023   0.0000   0.0023   0.0000   0.0023\n```\n:::\n:::\n\n\n- Negative numbers \"Contract\" the gap,\n- Positive,  \"Expand\" the gap.\n\n## The `oaxaca` way {.scrollable}\n\n::: {#84c5fc4a .cell execution_count=6}\n``` {.stata .cell-code}\nssc install oaxaca\nqui:oaxaca lnwage educ exper age married, by(female) w(0)  \nest sto m1\nqui:oaxaca lnwage educ exper age married, by(female) w(1)  \nest sto m2\nesttab m1 m2, wide mtitle(bw_Xm Xm_bw)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nchecking oaxaca consistency and verifying not already installed...\nall files already exist and are up to date.\n\n----------------------------------------------------------------------\n                      (1)                          (2)                \n                    bw_Xm                        Xm_bw                \n----------------------------------------------------------------------\noverall                                                               \ngroup_1             3.440***     (196.70)        3.440***     (196.70)\ngroup_2             3.267***     (149.41)        3.267***     (149.41)\ndifference          0.173***       (6.20)        0.173***       (6.20)\nexplained          0.0446*         (2.50)       0.0222          (1.28)\nunexplained         0.129***       (4.63)        0.151***       (5.69)\n----------------------------------------------------------------------\nexplained                                                             \neduc               0.0496***       (4.15)       0.0315***       (4.09)\nexper              0.0150          (1.92)     -0.00960*        (-2.08)\nage              -0.00691         (-1.32)      -0.0185         (-1.46)\nmarried           -0.0132*        (-2.36)       0.0189***       (3.40)\n----------------------------------------------------------------------\nunexplained                                                           \neduc               -0.369**       (-2.96)       -0.351**       (-2.96)\nexper              -0.179**       (-3.17)       -0.154**       (-3.18)\nage                 0.521***       (4.00)        0.533***       (4.00)\nmarried             0.153***       (5.62)        0.121***       (5.54)\n_cons             0.00234          (0.02)      0.00234          (0.02)\n----------------------------------------------------------------------\nN                    1434                         1434                \n----------------------------------------------------------------------\nt statistics in parentheses\n* p<0.05, ** p<0.01, *** p<0.001\n```\n:::\n:::\n\n\n## Choosing the Counterfactual\n\n- What should be a good counterfactual? \n  - The one that is most relevant to your research question.\n  - The one that is most likely to be true.\n  - The one that is not affected by discrimination.\n- While most of the time, decomposition results do not change much respect to the counterfactual, some times they do.\n\n- What to do?\n\n##  \n### Choosing the Counterfactual\n\n- Default counterfactual is to use predict wages for group A, using Wage structure of group B.\n\n- Some times it may make more sense choosing something in between:\n\n$$\\beta_c = \\omega \\beta_a + (1-\\omega) \\beta_b\n$$\n\nThis is the meaning of `w()` in `Oaxaca`\n\n- Some times, you may want to use $\\beta's$ from a pool model (`omega` option in `Oaxaca`)\n\n## OB Cheat Sheet {.scrollable}\n\n- `Stata` Implementation: `oaxaca` by Jann (2008) \n- Types of Decompositions\n  - Trifold Decomposition: `oaxaca y x1 x2 x3 x4, by(group)`\n  - Standard Decompositions: `oaxaca y x1 x2 x3 x4, by(group) w(0)  [w(1) ]`\n  - Reimiers (1983) Decomposition: `oaxaca y x1 x2 x3 x4, by(group) w(0.5)`\n  - Cotton(1983) Decomposition: `oaxaca y x1 x2 x3 x4, by(group) w(#=Share)`\n  - Oaxaca Ransom (1988,1994) and Neumark (1988) Decomposition: `oaxaca y x1 x2 x3 x4, by(group) omega`\n  - Cain (1986): `oaxaca y x1 x2 x3 x4, by(group) pool`\n\n## Beyond Microdata - a note\n\n- The principles of OB decomposition can also be applied to other types of data, including Macro Data.\n- Consider: Between 1990 and 2000 poverty rates fell from 20 to 10%.\n- What factors explain this change?\n  - Composition changes (Populations with lower poverty rates grew faster)\n  - Povery rates within groups (Poverty rates within groups fell)\n\n$$\\begin{aligned}\nP_t - P_s &= \\sum_{j=1}^K w_{jt} P_{jt} - \\sum_{j=1}^K w_{js} P_{js} \\\\\n\\Delta P &= \\sum_{j=1}^K w_{jt} ( P_{jt} -  P_{js}) + \\sum_{j=1}^K (w_{jt}-w_{js}) P_{js} \n\\end{aligned}\n$$\n\n# OB Decomposition: Extensions\n\n## OB Decomposition: Extensions\n\n- OB Decompositions have two drawbacks\n  - Its meant to analyze differences in average differences \n  - It uses differences in mean characteristics\n  - Its based on a linear model (OLS)\n  - Strong assumptions on error terms \n- There are various extensions (discussed in Firpo, Fortin, Lemieux (2010)) that can be used to address some of this limitations.\n\n## Linearity Assumption\n\n- Barsky at al (2002) and Dinardo Fortin and Limeux (1996) \n- A strong assumption behind OB is that the model is linear in parameters. \n  - This is important because the decomposition assumes we can make good \"extrapolations\" of the model.\n  - This is a problem of model misspecification. (what to do?)\n- One option is to improve model specification\n  - Consider using quadratic terms, interactions, with CENTERED variables.\n- However if Detailed decomposition is not of interest, one could use Re-weighting to get Counterfactuals\n\n## \n### Re-weighting\n\n- Considered a more general model: $Y_k = G_k(X) + \\epsilon_k$ and $E(Y|X,k) = G_k(X)$\n\n- The overall mean, in this case could be written as:\n\n$$\\begin{aligned}\nE_k(Y)&=\\int y f_k(y) dy = \\iint (g_k(x) + \\epsilon) f_k(x,\\epsilon) dx d\\epsilon \\\\\n      &= \\int g_k(x) f_k(x) dx  \\\\\n      &= \\bar Y_{g=k, X=k}\n\\end{aligned}\n$$\n\n##\n\n- Now lets define a counterfactual:  $\\bar Y^c_{x=A, g=B} = \\int g_B(x) f_A(x) dx$\n\n  - this is defined as the average outcome of group A if they face the market of group B.\n\n- Then, the nonlinear decomposition can be written as:\n\n$$\\begin{aligned}\n\\Delta \\bar Y &= \\bar Y_{G=A, X=A} - \\bar Y_{G=B, X=B} \\\\\n&= \\bar Y_{G=A, X=A} - \\bar Y_{G=B, X=B} + \\bar Y^c_{G=A, X=B} - \\bar Y^c_{G=A, X=B} \\\\\n&= \\bar Y_{G=A, X=A} - \\bar Y^c_{G=A, X=B} + \\bar Y^c_{G=A, X=B} - \\bar Y_{G=B, X=B} \\\\\n&=                   \\Delta X + \\Delta G\n\\end{aligned}\n$$\n\n## \n### But how are the counterfactuals weights identified?\n \nThen the counterfactual can be written as:\n\n$$\n\\begin{aligned}\n\\bar Y^c_{G=A, X=B} &= \\int g_A(x) f_B(x) dx  = \\int g_A(x) \\frac{f_B(x)}{f_A(x)} f_A(x) dx \\\\\n&= \\int g_A(x) \\frac{1-P_A(X)}{P_A(X)} f_A(x) dx \\\\\n&= \\int g_A(x) \\widehat{IPW}(X) f_A(x) dx \\\\\n\\end{aligned}\n$$\n\n##\n### Example\n\n::: {#be218fc2 .cell .larger execution_count=7}\n``` {.stata .cell-code}\nfrause oaxaca, clear\ndrop if lnwage==.\nqui:logit female c.(educ exper age married)##c.(educ exper age married), nolog\npredict pr_b, pr\n\ngen ipw1 = (1-pr_b)/pr_b if female==1\ngen ipw2 = pr_b/(1-pr_b) if female==0\nqui:{\nmean lnwage educ exper age married if female==0\nest sto m1\nmean lnwage educ exper age married if female==0 [pw=ipw2] \nest sto m2a\nmean lnwage educ exper age married if female==1 [pw=ipw1]\nest sto m2b\nmean lnwage educ exper age married if female==1\nest sto m3\n \n}\nesttab m1 m2a m2b m3, nogaps se ///\nmtitle(Men Men_as_w Wmen_as_m Women)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(Excerpt from the Swiss Labor Market Survey 1998)\n(213 observations deleted)\n(751 missing values generated)\n(683 missing values generated)\n\n----------------------------------------------------------------------------\n                      (1)             (2)             (3)             (4)   \n                      Men        Men_as_w       Wmen_as_m           Women   \n----------------------------------------------------------------------------\nlnwage              3.440***        3.475***        3.277***        3.267***\n                 (0.0175)        (0.0247)        (0.0280)        (0.0218)   \neduc                11.81***        11.35***        11.82***        11.23***\n                 (0.0895)         (0.112)         (0.154)        (0.0900)   \nexper               14.08***        12.26***        15.23***        12.14***\n                  (0.408)         (0.432)         (1.621)         (0.319)   \nage                 38.43***        39.46***        39.47***        39.29***\n                  (0.413)         (0.725)         (1.160)         (0.411)   \nmarried             0.522***        0.393***        0.523***        0.413***\n                 (0.0182)        (0.0252)        (0.0408)        (0.0189)   \n----------------------------------------------------------------------------\nN                     751             751             683             683   \n----------------------------------------------------------------------------\nStandard errors in parentheses\n* p<0.05, ** p<0.01, *** p<0.001\n```\n:::\n:::\n\n\nDecomposition:\n\n`(1,2,4)`:\n  - $DX$ = (1) vs (2)= 3.440-3.475=-0.035\n  - $DB$ = (2) vs (4)= 3.475-3.267 =0.208\n`(1,3,4)`\n  - $DX$ = (3) vs (4) = 3.277-3.267 = 0.010\n  - $DB$ = (1) vs (3) = 3.440-3.277 = 0.163\n\n",
    "supporting": [
      "session_4_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}