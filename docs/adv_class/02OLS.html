<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Fernando Rios-Avila">

<title>Econometrics MSC Levy - Linear Regression Model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Econometrics MSC Levy</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../adv_class.html" rel="" target="">
 <span class="menu-text">Adv Methods and Causal Effects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../rmethods/index.html" rel="" target="">
 <span class="menu-text">Research Methods: Econometrics I</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../rm2_return.html" rel="" target="">
 <span class="menu-text">Research Methods II: Applied Methods</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-math-refresher" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Math Refresher</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-math-refresher">    
        <li>
    <a class="dropdown-item" href="../mathref/math_1.html" rel="" target="">
 <span class="dropdown-text">Math Refresher: Basic Calculus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../mathref/math_2.html" rel="" target="">
 <span class="dropdown-text">Math Refresher: Basic Linear Algebra</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../mathref/math_3.html" rel="" target="">
 <span class="dropdown-text">Math Refresher: Basic Statistics and Probability</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../resources.html" rel="" target="">
 <span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#estimation" id="toc-estimation" class="nav-link" data-scroll-target="#estimation">Estimation</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  <li><a href="#mata-ols-estimator" id="toc-mata-ols-estimator" class="nav-link" data-scroll-target="#mata-ols-estimator">Mata: OLS Estimator</a></li>
  <li><a href="#inference---distribution-of-betas" id="toc-inference---distribution-of-betas" class="nav-link" data-scroll-target="#inference---distribution-of-betas">Inference - Distribution of <span class="math inline">\(\beta's\)</span></a></li>
  <li><a href="#inference-estimating-se" id="toc-inference-estimating-se" class="nav-link" data-scroll-target="#inference-estimating-se">Inference: Estimating SE</a></li>
  <li><a href="#homoskedasticity-and-independent-samples" id="toc-homoskedasticity-and-independent-samples" class="nav-link" data-scroll-target="#homoskedasticity-and-independent-samples">Homoskedasticity and independent samples</a></li>
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1"></a></li>
  <li><a href="#lifting-assumptions-heteroscedasticity" id="toc-lifting-assumptions-heteroscedasticity" class="nav-link" data-scroll-target="#lifting-assumptions-heteroscedasticity">Lifting Assumptions: Heteroscedasticity</a></li>
  <li><a href="#but-error-is-not-the-same-as-residual" id="toc-but-error-is-not-the-same-as-residual" class="nav-link" data-scroll-target="#but-error-is-not-the-same-as-residual">But error is not the same as residual!</a></li>
  <li><a href="#coding-robust-se" id="toc-coding-robust-se" class="nav-link" data-scroll-target="#coding-robust-se">Coding Robust SE</a></li>
  <li><a href="#lifting-even-more-assumptions-correlation" id="toc-lifting-even-more-assumptions-correlation" class="nav-link" data-scroll-target="#lifting-even-more-assumptions-correlation">Lifting Even more Assumptions: Correlation</a></li>
  <li><a href="#addressing-correlation" id="toc-addressing-correlation" class="nav-link" data-scroll-target="#addressing-correlation">Addressing Correlation</a></li>
  <li><a href="#section-2" id="toc-section-2" class="nav-link" data-scroll-target="#section-2"></a></li>
  <li><a href="#beware-of-over-clustering" id="toc-beware-of-over-clustering" class="nav-link" data-scroll-target="#beware-of-over-clustering">Beware of over-clustering</a></li>
  <li><a href="#role-of-clusters" id="toc-role-of-clusters" class="nav-link" data-scroll-target="#role-of-clusters">Role of clusters</a></li>
  <li><a href="#section-3" id="toc-section-3" class="nav-link" data-scroll-target="#section-3"></a></li>
  <li><a href="#the-bootstrap" id="toc-the-bootstrap" class="nav-link" data-scroll-target="#the-bootstrap">The Bootstrap</a>
  <ul class="collapse">
  <li><a href="#if-you-cant-sandwich-you-can-re-sample" id="toc-if-you-cant-sandwich-you-can-re-sample" class="nav-link" data-scroll-target="#if-you-cant-sandwich-you-can-re-sample">If you can‚Äôt Sandwich ü•™, you can re-Sample</a></li>
  <li><a href="#a-brief-reviewagain" id="toc-a-brief-reviewagain" class="nav-link" data-scroll-target="#a-brief-reviewagain">A Brief Review‚Ä¶again üòá</a></li>
  <li><a href="#but-we-only-get-1-sample" id="toc-but-we-only-get-1-sample" class="nav-link" data-scroll-target="#but-we-only-get-1-sample">But we only get 1 Sample!</a></li>
  <li><a href="#bootstrapping" id="toc-bootstrapping" class="nav-link" data-scroll-target="#bootstrapping">Bootstrapping</a></li>
  <li><a href="#bootstrap-types" id="toc-bootstrap-types" class="nav-link" data-scroll-target="#bootstrap-types">Bootstrap Types:</a></li>
  <li><a href="#section-4" id="toc-section-4" class="nav-link" data-scroll-target="#section-4"></a></li>
  <li><a href="#how-to-bootstrap-in-stata" id="toc-how-to-bootstrap-in-stata" class="nav-link" data-scroll-target="#how-to-bootstrap-in-stata">How to Bootstrap? in <code>Stata</code></a></li>
  <li><a href="#section-5" id="toc-section-5" class="nav-link" data-scroll-target="#section-5"></a></li>
  <li><a href="#final-words-on-bootstrap" id="toc-final-words-on-bootstrap" class="nav-link" data-scroll-target="#final-words-on-bootstrap">Final words on Bootstrap:</a></li>
  </ul></li>
  <li><a href="#small-diversion-the-delta-method" id="toc-small-diversion-the-delta-method" class="nav-link" data-scroll-target="#small-diversion-the-delta-method">Small Diversion ü¶å: The Delta Method</a>
  <ul class="collapse">
  <li><a href="#variance-of-nonlinear-functions" id="toc-variance-of-nonlinear-functions" class="nav-link" data-scroll-target="#variance-of-nonlinear-functions">Variance of nonlinear functions</a></li>
  <li><a href="#section-6" id="toc-section-6" class="nav-link" data-scroll-target="#section-6"></a></li>
  <li><a href="#delta-method-visualization" id="toc-delta-method-visualization" class="nav-link" data-scroll-target="#delta-method-visualization">Delta Method: Visualization</a></li>
  <li><a href="#section-7" id="toc-section-7" class="nav-link" data-scroll-target="#section-7"></a></li>
  <li><a href="#so-why-do-we-care" id="toc-so-why-do-we-care" class="nav-link" data-scroll-target="#so-why-do-we-care">So why do we care:</a></li>
  </ul></li>
  <li><a href="#linear-model-selection-and-regularization" id="toc-linear-model-selection-and-regularization" class="nav-link" data-scroll-target="#linear-model-selection-and-regularization">Linear Model Selection and Regularization</a>
  <ul class="collapse">
  <li><a href="#what-happens-when-k-is-too-big" id="toc-what-happens-when-k-is-too-big" class="nav-link" data-scroll-target="#what-happens-when-k-is-too-big">What happens when K is too big?</a></li>
  <li><a href="#ml-we-let-the-choose-for-you" id="toc-ml-we-let-the-choose-for-you" class="nav-link" data-scroll-target="#ml-we-let-the-choose-for-you">ML: We let the üíªChoose for you</a></li>
  <li><a href="#ridge-and-lasso-and-elasticnet" id="toc-ridge-and-lasso-and-elasticnet" class="nav-link" data-scroll-target="#ridge-and-lasso-and-elasticnet">Ridge and Lasso and ElasticNet</a></li>
  <li><a href="#section-8" id="toc-section-8" class="nav-link" data-scroll-target="#section-8"></a></li>
  <li><a href="#lasso-and-elastic-net" id="toc-lasso-and-elastic-net" class="nav-link" data-scroll-target="#lasso-and-elastic-net">Lasso and Elastic Net</a></li>
  <li><a href="#lasso-vs-ridge" id="toc-lasso-vs-ridge" class="nav-link" data-scroll-target="#lasso-vs-ridge">Lasso vs Ridge</a></li>
  <li><a href="#considerations" id="toc-considerations" class="nav-link" data-scroll-target="#considerations">Considerations:</a></li>
  <li><a href="#brief-example" id="toc-brief-example" class="nav-link" data-scroll-target="#brief-example">Brief Example:</a></li>
  <li><a href="#shrinking-coefficients" id="toc-shrinking-coefficients" class="nav-link" data-scroll-target="#shrinking-coefficients">Shrinking Coefficients</a></li>
  </ul></li>
  <li><a href="#next-non-semi-parametric-models" id="toc-next-non-semi-parametric-models" class="nav-link" data-scroll-target="#next-non-semi-parametric-models">Next: Non &amp; Semi Parametric models</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="02OLS.html"><i class="bi bi-file-slides"></i>RevealJS</a></li><li><a href="02OLS.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Linear Regression Model</h1>
<p class="subtitle lead">Statistical Inference and Extensions</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Fernando Rios-Avila </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="introduction">Introduction</h2>
<ul>
<li><p>Linear Regression (usually estimated via OLS) is the most basic, and still most useful, tool for analyzing data.</p></li>
<li><p>The goal is to find what the relationship between the outcome <span class="math inline">\(y\)</span> and explanatory variables <span class="math inline">\(X's\)</span> is.</p></li>
<li><p>Say that we start with a very simple ‚Äú<strong><em>model</em></strong>‚Äù that states tries to describe the population function as the following:</p></li>
</ul>
<p><span class="math display">\[
y = h(X,\varepsilon)
\]</span></p>
<p>Here, <span class="math inline">\(X\)</span> represents a set of observed covariates and <span class="math inline">\(\varepsilon\)</span> the set of unobserved characteristics, and for now, we assume that there is no pre-define relationship between these components.</p>
<ul>
<li>For now, we will make standard exogeneity assumptions for the identification of the model</li>
</ul>
</section>
<section id="estimation" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="estimation">Estimation</h2>
<ul>
<li>The functional form, however, is unknowable. However, under the <strong><em>small</em></strong> assumption that <span class="math inline">\(X\)</span> and <span class="math inline">\(\varepsilon\)</span> are unrelated, if we would have access to the population data, we could instead consider the Conditional Expectation function (CEF):</li>
</ul>
<p><span class="math display">\[
E(y_i|X_i=x) = \int t f_y(t|X_i=x)dx
\]</span></p>
<ul>
<li><p>Notice that this implies a fully <strong>non-parametric</strong> estimation of the Linear function (because it does not impose any functional form).</p></li>
<li><p>With this, we can ‚Äúdecompose‚Äù the outcome <span class="math inline">\(y\)</span> into two components, one that depends on observation characteristics (CEF) and one that depends on the error <span class="math inline">\(\varepsilon\)</span>.</p></li>
</ul>
<p><span class="math display">\[
y = E(y|X) + \varepsilon
\]</span></p>
<ul>
<li>This has the nice property that the error is unrelated to any functional form of <span class="math inline">\(X\)</span>, while providing a summary of the relationship between <span class="math inline">\(X\)</span> and <span class="math inline">\(y\)</span>.</li>
</ul>
</section>
<section id="section" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="section"></h2>
<ul>
<li><p>The CEF is a convenient abstract, but to estimate it, we require assumptions. (Recall the assumptions for unbiased OLS?)</p></li>
<li><p>Namely, we need to impose a linearity assumption, namely:</p></li>
</ul>
<p><span class="math display">\[
E(y_i|X_i=x) = \beta_0 + \beta_1 x_1 +\beta_2 x_2 + ... +
\beta_k x_k = X_i'\beta
\]</span></p>
<ul>
<li>And the solution for <span class="math inline">\(\beta\)</span> is given by:</li>
</ul>
<p><span class="math display">\[
\beta = \underset{b}{arg} \ E(L(y_i-X'_i b))
\]</span></p>
<p>Where the loss function <span class="math inline">\(L(x)=x^2\)</span>. (Square loss function)</p>
<ul>
<li>This implies the following condition:</li>
</ul>
<p><span class="math display">\[
E[X_i (y_i-X_i'b)]=0 \rightarrow \beta = E[X_i'X_i]^{-1}E[X_i'y_i]
\]</span></p>
<ul>
<li>This population terms must be substituted by the sample equivalent: <span class="math inline">\(E(X_i) =\frac{1}{N} \sum_i^NX_i\)</span></li>
</ul>
</section>
<section id="mata-ols-estimator" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="mata-ols-estimator">Mata: OLS Estimator</h2>
<p>The estimator using Sample equivalents become:</p>
<p><span class="math display">\[
\hat \beta =
\left(\frac{1}{N} \sum_i X_i'X_i \right)^{-1}
\frac{1}{N} \sum_i X_i'y_i=(X'X)^{-1}X'y
\]</span></p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>frause oaxaca, <span class="kw">clear</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> lnwage !=.</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">mata</span>:</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">y</span> = st_data(.,<span class="st">"lnwage"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  n = <span class="bn">rows</span>(<span class="fu">y</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  x = st_data(.,<span class="st">"female age educ"</span>),<span class="fu">J</span>(n,1,1)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  exx = <span class="kw">cross</span>(x,x)/n</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  exy = <span class="kw">cross</span>(x,<span class="fu">y</span>)/n</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  b   = <span class="fu">invsym</span>(exx)*exy</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  b</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>div.jp-Notebook .datagrid-container {min-height: 448px; }</style>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>(Excerpt from the Swiss Labor Market Survey 1998)
(213 observations deleted)

. mata:
------------------------------------------------- mata (type end to exit) -----
:   y = st_data(.,"lnwage")

:   n = rows(y)

:   x = st_data(.,"female age educ"),J(n,1,1)

:   exx = cross(x,x)/n

:   exy = cross(x,y)/n

:   b = invsym(exx)*exy

:   b
                 1
    +---------------+
  1 |  -.145393595  |
  2 |  .0161424301  |
  3 |  .0719321873  |
  4 |  1.970020725  |
    +---------------+

: end
-------------------------------------------------------------------------------

. </code></pre>
</div>
</div>
</section>
<section id="inference---distribution-of-betas" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="inference---distribution-of-betas">Inference - Distribution of <span class="math inline">\(\beta's\)</span></h2>
<p>so: <span class="math display">\[
\begin{aligned}
y &amp;= X\beta + \varepsilon \\
\sqrt N (\hat\beta - \beta) &amp;=\frac{1}{N}\Big[\sum (X_iX_i')\Big]^{-1} \frac{1}{\sqrt N} \sum(X_i\varepsilon_i)
\end{aligned}
\]</span></p>
<ul>
<li><p>Here <span class="math inline">\(\varepsilon\)</span> is the true population error. <span class="math inline">\(\hat\beta\)</span> is unbiased if the second term has an expectation of Zero. (the error is independent from <span class="math inline">\(X\)</span>).</p></li>
<li><p>Asymptotically, the first term is assumed fixed <span class="math inline">\(E(X_i X_i')\)</span>. And, because <span class="math inline">\(E(X_i\varepsilon)=0\)</span>, and <span class="math inline">\(\frac{1}{\sqrt N} \sum(X_i\varepsilon)\)</span> is normalized, by CLT we have that:</p></li>
</ul>
<p><span class="math display">\[
\sqrt N (\hat\beta-\beta)\sim N(0,E(X_iX_i')^{-1} \ E(X_iX_i'\varepsilon ^2) \ E(X_iX_i')^{-1})
\]</span></p>
<ul>
<li>From here, the main question is : How do we estimate <span class="math inline">\(E(X_iX'\varepsilon_i^2)\)</span>?</li>
</ul>
</section>
<section id="inference-estimating-se" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="inference-estimating-se">Inference: Estimating SE</h2>
<ul>
<li>Lets First Rewrite the last expression:</li>
</ul>
<p><span class="math display">\[
Var(\hat\beta)=(X'X)^{-1} X'\Omega X (X'X)^{-1}
\]</span></p>
<p>where:</p>
<p><span class="math display">\[
\Omega=
\left(
\begin{matrix}
\sigma_1^2 &amp; \sigma_{12} &amp;  ... &amp; \sigma_{1N}\\
\sigma_{21} &amp; \sigma_{2}^2 &amp; ... &amp; \sigma_{2N} \\
...&amp;...&amp;...&amp;...\\
\sigma_{N1} &amp; \sigma_{N2} &amp; ... &amp; \sigma_{NN}^2 \\
\end{matrix}
\right)
\]</span></p>
<p>In other words, the variance of <span class="math inline">\(\hat\beta\)</span> allows for arbitrary relationship among the errors, as well as heteroskedasticity. This, however is impossible to estimate!, thus we require assumptions</p>
</section>
<section id="homoskedasticity-and-independent-samples" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="homoskedasticity-and-independent-samples">Homoskedasticity and independent samples</h2>
<p>The easiest route is to assume homoskedastic errors <span class="math inline">\(\sigma^2 = \sigma_i^2 \ \forall i \in 1,...,N\)</span> . (the error is spread equally around the mean)</p>
<p>With independent samples <span class="math inline">\(\sigma_{ij}=0 \ \forall \ i\neq j\)</span> . (A persons unobserved is completely independent from anybody else)</p>
<p><span class="math display">\[
\Omega_00=
\left(
\begin{matrix}
\sigma_1^2 &amp; \sigma_{12} &amp;  ... &amp; \sigma_{1N}\\
\sigma_{21} &amp; \sigma_{2}^2 &amp; ... &amp; \sigma_{2N} \\
...&amp;...&amp;...&amp;...\\
\sigma_{N1} &amp; \sigma_{N2} &amp; ... &amp; \sigma_{NN}^2 \\
\end{matrix}
\right)=I(N)*\sigma^2
\]</span></p>
<p>Thus <span class="math display">\[
\begin{aligned}
Var(\hat\beta)_{00} &amp;=(X'X)^{-1} X'I(N)\sigma^2 X (X'X)^{-1} \\
&amp;=\sigma^2 (X'X)^{-1} \\
\sigma^2 &amp;= E(\varepsilon^2)
\end{aligned}
\]</span></p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">mata</span>: <span class="fu">e</span>=err = <span class="fu">y</span>:-x*b</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mata</span>: var_b_000 = <span class="kw">mean</span>(err:^2) * <span class="fu">invsym</span>(x'x)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">mata</span>: b,<span class="fu">sqrt</span>(diagonal(var_b_000))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 1             2
    +-----------------------------+
  1 |  -.145393595   .0243547399  |
  2 |  .0161424301   .0010962465  |
  3 |  .0719321873    .005029506  |
  4 |  1.970020725   .0724744138  |
    +-----------------------------+</code></pre>
</div>
</div>
</section>
<section id="section-1" class="level2">
<h2 class="anchored" data-anchor-id="section-1"></h2>
<p>But, <span class="math inline">\(\sigma^2\)</span> is not known, so we have to use <span class="math inline">\(\hat\sigma^2\)</span> instead, which depends on the sample residuals: <span class="math display">\[
\hat\sigma^2 = \frac{1}{N-k-1}\sum \hat e^2
\]</span></p>
<p>Where we account for the fact true errors are not observed, but rather residuals are estimated, adjusting the degrees of freedom.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">mata</span>:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">N</span> = <span class="bn">rows</span>(<span class="fu">y</span>); <span class="kw">k</span> = <span class="bn">cols</span>(x)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    var_b_00 = <span class="kw">sum</span>(err:^2)/(<span class="kw">N</span>-<span class="kw">k</span>) * <span class="fu">invsym</span>(x'x)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    b,<span class="fu">sqrt</span>(diagonal(var_b_00))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
. mata:
------------------------------------------------- mata (type end to exit) -----
:     N = rows(y); k = cols(x)

:     var_b_00 = sum(err:^2)/(N-k) * invsym(x'x)

:     b,sqrt(diagonal(var_b_00))
                 1             2
    +-----------------------------+
  1 |  -.145393595   .0243887787  |
  2 |  .0161424301   .0010977786  |
  3 |  .0719321873   .0050365354  |
  4 |  1.970020725   .0725757058  |
    +-----------------------------+

: end
-------------------------------------------------------------------------------

. </code></pre>
</div>
</div>
</section>
<section id="lifting-assumptions-heteroscedasticity" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="lifting-assumptions-heteroscedasticity">Lifting Assumptions: Heteroscedasticity</h2>
<ul>
<li>We start by lifting this assumption, which implies the following:</li>
</ul>
<p><span class="math display">\[
\sigma^2_i \neq \sigma^2_j \  \forall \ i\neq j
\]</span></p>
<p>But to estimate this, we need an approximation for <span class="math inline">\(\sigma^2_i = E(\varepsilon_i^2) = \varepsilon_i^2\)</span>.</p>
<ul>
<li>With this, we can obtain what is known as th White or Eicker-White or Heteroskedasiticy Robust Standard errors.</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
Var(\hat\beta)_{0} &amp;= (X'X)^{-1} (X\hat e)'(\hat eX) (X'X)^{-1} \\
&amp;=(X'X)^{-1} \sum(X_iX_i'\hat e^2) (X'X)^{-1}
\end{aligned}
\]</span></p>
<p>Which imposes <strong>NO</strong> penalty to the fact that we are using residuals not errors. If we account for that however, we obtain what is known as HC1, SE, the standard in <code>stata</code>. (when you type <code>robust</code>)</p>
<p><span class="math display">\[
Var(\hat\beta)_{1}=\frac{N}{N-K-1}Var(\hat\beta)_{0}
\]</span></p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">mata</span>:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    ixx = <span class="fu">invsym</span>(x'x)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    var_b_0 = ixx * (x:*<span class="fu">e</span>)'(x:*<span class="fu">e</span>) * ixx</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    var_b_1 = <span class="kw">N</span>/(<span class="kw">N</span>-<span class="kw">k</span>)*var_b_0</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    b,<span class="fu">sqrt</span>(diagonal(var_b_0)),<span class="fu">sqrt</span>(diagonal(var_b_1))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
. mata:
------------------------------------------------- mata (type end to exit) -----
:     ixx = invsym(x'x)

:     var_b_0 = ixx * (x:*e)'(x:*e) * ixx

:     var_b_1 = N/(N-k)*var_b_0

:     b,sqrt(diagonal(var_b_0)),sqrt(diagonal(var_b_1))
                 1             2             3
    +-------------------------------------------+
  1 |  -.145393595   .0243162137   .0243501986  |
  2 |  .0161424301   .0013544849   .0013563779  |
  3 |  .0719321873    .005690214   .0056981668  |
  4 |  1.970020725   .0875757052   .0876981032  |
    +-------------------------------------------+

: end
-------------------------------------------------------------------------------

. </code></pre>
</div>
</div>
</section>
<section id="but-error-is-not-the-same-as-residual" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="but-error-is-not-the-same-as-residual">But error is not the same as residual!</h2>
<p>A residual is model dependent, and should not be confused with the model error <span class="math inline">\(\hat \varepsilon \neq \varepsilon\)</span>. Because of this, additional corrections are needed to obtained unbiased <span class="math inline">\(var(\hat\beta)\)</span> estimates. (Degrees of freedom). But other options exists.</p>
<p>Redefine the Variance Formula:</p>
<p><span class="math display">\[
Var(\hat\beta)=(X'X)^{-1} (\sum X_iX_i \psi_i )  (X'X)^{-1}
\]</span></p>
<p>From here Mackinnon and White (1985) suggest few other options: <span class="math display">\[
\begin{matrix}
HC0: \psi_i = \hat e^2 &amp;
HC1: \psi_i = \frac{N}{N-K}  \hat e^2 \\
HC2: \psi_i =   \hat e^2 \frac{1}{1-h_{ii}} &amp;
HC3: \psi_i =   \hat e^2 \frac{1}{(1-h_{ii})^2}
\end{matrix}
\]</span></p>
<p>Where <span class="math inline">\(h_{ii}\)</span> is the ith diagonal element of <span class="math inline">\(X(X'X)^{-1}X'\)</span> and allows you to see how dependent a model is to a single observation.</p>
<p>HC2 and HC3 Standard errors are better than HC1 SE, specially when Samples are small.</p>
<blockquote class="blockquote">
<p>NOTE: this <span class="math inline">\(h_{ii}\)</span> element is also used to measure the degrees of freedom of a model. Sum it up, and you will see!.</p>
</blockquote>
</section>
<section id="coding-robust-se" class="level2">
<h2 class="anchored" data-anchor-id="coding-robust-se">Coding Robust SE</h2>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">mata</span>:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// h = diagonal(X invsym(X'x) X') Wrong Way, too many calculations</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">h</span> = rowsum(x*<span class="fu">invsym</span>(x'x):*x)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    psi0 = <span class="fu">e</span>:^2           ;   psi1 = <span class="fu">e</span>:^2*<span class="kw">N</span>/(<span class="kw">N</span>-<span class="kw">k</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    psi2 = <span class="fu">e</span>:^2:/(1:-<span class="kw">h</span>)   ;   psi3 = <span class="fu">e</span>:^2:/((1:-<span class="kw">h</span>):^2)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    var_b_0 = ixx * <span class="kw">cross</span>(x,psi0,x) * ixx</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    var_b_1 = ixx * <span class="kw">cross</span>(x,psi1,x) * ixx</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    var_b_2 = ixx * <span class="kw">cross</span>(x,psi2,x) * ixx</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    var_b_3 = ixx * <span class="kw">cross</span>(x,psi3,x) * ixx</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    b,<span class="fu">sqrt</span>(diagonal(var_b_0)),<span class="fu">sqrt</span>(diagonal(var_b_1)),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(diagonal(var_b_2)),<span class="fu">sqrt</span>(diagonal(var_b_3))</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
. mata:
------------------------------------------------- mata (type end to exit) -----
:     // h = diagonal(X invsym(X'x) X') Wrong Way, too many calculations
:     h = rowsum(x*invsym(x'x):*x)

:     psi0 = e:^2 ; psi1 = e:^2*N/(N-k)

:     psi2 = e:^2:/(1:-h) ; psi3 = e:^2:/((1:-h):^2)

:     var_b_0 = ixx * cross(x,psi0,x) * ixx

:     var_b_1 = ixx * cross(x,psi1,x) * ixx

:     var_b_2 = ixx * cross(x,psi2,x) * ixx

:     var_b_3 = ixx * cross(x,psi3,x) * ixx

:     b,sqrt(diagonal(var_b_0)),sqrt(diagonal(var_b_1)),
&gt;     sqrt(diagonal(var_b_2)),sqrt(diagonal(var_b_3))
                 1             2             3             4             5
    +-----------------------------------------------------------------------+
  1 |  -.145393595   .0243162137   .0243501986   .0243568124   .0243975204  |
  2 |  .0161424301   .0013544849   .0013563779   .0013573922   .0013603079  |
  3 |  .0719321873    .005690214   .0056981668   .0057079191    .005725691  |
  4 |  1.970020725   .0875757052   .0876981032   .0878131672   .0880514838  |
    +-----------------------------------------------------------------------+

: end
-------------------------------------------------------------------------------

. </code></pre>
</div>
</div>
<p>Or in <code>Stata</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">regress</span> <span class="fu">y</span> x1 <span class="kw">x2</span> x3, <span class="kw">vce</span>(<span class="kw">robust</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">regress</span> <span class="fu">y</span> x1 <span class="kw">x2</span> x3, <span class="kw">vce</span>(hc2)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">regress</span> <span class="fu">y</span> x1 <span class="kw">x2</span> x3, <span class="kw">vce</span>(hc3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="lifting-even-more-assumptions-correlation" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="lifting-even-more-assumptions-correlation">Lifting Even more Assumptions: Correlation</h2>
<ul>
<li><p>One assumption we barely consider last semester was the possibility that errors could be correlated within groups. (except for time series and serial correlation)</p></li>
<li><p>For example, families may share similar unobserved factors, So would people interviewed from the same classroom, cohort, city, etc. There could be many dimensions to consider possible correlations!</p></li>
<li><p>In that situation, we may be missmeasuring the magnitude of the errors (probably downward), because the <span class="math inline">\(\Omega\)</span> is no longer diagonal: <span class="math inline">\(\sigma_{ij} \neq 0\)</span> for some <span class="math inline">\(i\neq j\)</span>.</p>
<ul>
<li>But, estimate all parameters in an NxN matrix is unfeasible. We need assumptions!</li>
</ul></li>
<li><p>Say we have <span class="math inline">\(G\)</span> groups <span class="math inline">\(g=(1‚Ä¶G)\)</span> . We can rewrite the expression for <span class="math inline">\(\hat\beta\)</span> as follows:</p></li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\hat\beta-\beta &amp;= (X'X)^{-1}\sum_{g=1}^G X'_g \varepsilon_g \\\
&amp;=(X'X)^{-1}\sum_{g=1}^G s_g
\end{aligned}
\]</span></p>
<ul>
<li>We can assume that individuals are correlated within groups <span class="math inline">\(E(s_g's_g) =\Sigma_g\)</span> , but they are uncorrelated across groups <span class="math inline">\(E(s_g s_g')=0 \ \forall \ g \neq g'\)</span> .</li>
<li>These groups are typically known as ‚Äú<strong>clusters</strong>‚Äù</li>
</ul>
</section>
<section id="addressing-correlation" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="addressing-correlation">Addressing Correlation</h2>
<ul>
<li>The idea of correcting for clusters is pretty simple. We just need to come up with an estimator for <span class="math inline">\(\Sigma_g\)</span> for every cluster, so that:</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
Var(\hat\beta) &amp;= (X'X)^{-1} \left( \sum_{g=1}^N \Sigma_g \right) (X'X)^{-1} \\
\Sigma_g &amp;= E( X_g' \Omega_g X_g)
\end{aligned}
\]</span></p>
<ul>
<li><p>Here <span class="math inline">\(\Omega_g\)</span> should be an approximation of the variance covariance matrix among the errors of ALL individuals that belong to the same cluster. But how do we approximate it?</p></li>
<li><p>As with the EW - HC standard errors, there are many ways to estimate Clustered Standard errors. See MacKinnon et al (2023) for reference. We will refer only to the simpler ones CV0 and CV1.</p></li>
</ul>
<blockquote class="blockquote">
<p>Still How?</p>
</blockquote>
<ul>
<li>Recall we approximate <span class="math inline">\(\sigma^2_i\)</span> with <span class="math inline">\(\varepsilon_i^2\)</span>. Then we can approximate <span class="math inline">\(\sigma_{ij}\)</span> with <span class="math inline">\(\varepsilon_j \varepsilon_i\)</span>. More specifically:</li>
</ul>
<p><span class="math display">\[
\Omega_g \simeq \varepsilon \varepsilon' \ or \ \Sigma_g = X'_g \varepsilon \varepsilon' X_g = (X'_g \varepsilon) (\varepsilon' X_g)
\]</span></p>
<ul>
<li>Change <span class="math inline">\(\varepsilon\)</span> with <span class="math inline">\(\hat\varepsilon\)</span>, do that for every group, and done! (almost).</li>
</ul>
</section>
<section id="section-2" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="section-2"></h2>
<ul>
<li>As mentioned earlier, there are many CCSE (clustered consistent SE).</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
CV_0 &amp;= (X'X)^{-1} \sum_{g=1}^G \hat \Sigma_g (X'X)^{-1} \\
CV_1 &amp;= \frac{G(N-1)}{(G-1)(N-k-1)}(X'X)^{-1} \sum_{g=1}^G \hat \Sigma_g (X'X)^{-1}
\end{aligned}
\]</span></p>
<ul>
<li>Similar to HC. CV0 does not correct for degrees of freedom. CV1, however, accounts for Degrees of freedom in the model, and clusters.</li>
</ul>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">mata</span>:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1st Sort Data (easier in Stata rather than Mata) and reload</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">y</span>   = st_data(.,<span class="st">"lnwage"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    x   = st_data(.,<span class="st">"educ exper female"</span>),<span class="fu">J</span>(1434,1,1) </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    cvar= st_data(.,<span class="st">"isco"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    ixx = <span class="fu">invsym</span>(<span class="kw">cross</span>(x,x)); xy = <span class="kw">cross</span>(x,<span class="fu">y</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    b   = ixx * xy</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">e</span>   = <span class="fu">y</span>:-x*b</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the panel info</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    info = <span class="kw">panelsetup</span>(cvar,1); g=<span class="bn">rows</span>(info); n=<span class="bn">rows</span>(<span class="fu">y</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// get X_g'e for all groups: </span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    s_xg_e = panelsum(x:*<span class="fu">e</span>,info)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sum Sigma_g</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    sigma_g = s_xg_e's_xg_e</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    cv0 = ixx*sigma_g*ixx</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    cv1 =g/(g-1)*(n-1)/(n-<span class="kw">k</span>)*ixx*sigma_g*ixx</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    b,<span class="fu">sqrt</span>(diagonal(cv0)),<span class="fu">sqrt</span>(diagonal(cv1))</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
. mata:
------------------------------------------------- mata (type end to exit) -----
:     // 1st Sort Data (easier in Stata rather than Mata) and reload
:     y = st_data(.,"lnwage")

:     x = st_data(.,"educ exper female"),J(1434,1,1)

:     cvar= st_data(.,"isco")

:     ixx = invsym(cross(x,x)); xy = cross(x,y)

:     b = ixx * xy

:     e = y:-x*b

:     // Set the panel info
:     info = panelsetup(cvar,1); g=rows(info); n=rows(y)

:     // get X_g'e for all groups:
:     s_xg_e = panelsum(x:*e,info)

:     // Sum Sigma_g
:     sigma_g = s_xg_e's_xg_e

:     cv0 = ixx*sigma_g*ixx

:     cv1 =g/(g-1)*(n-1)/(n-k)*ixx*sigma_g*ixx

:     b,sqrt(diagonal(cv0)),sqrt(diagonal(cv1))
                  1              2              3
    +----------------------------------------------+
  1 |   .0858251775    .0140570765    .0149254126  |
  2 |   .0147342796    .0014534593    .0015432426  |
  3 |  -.0949227416    .0525121234    .0557559112  |
  4 |   2.218849962    .1947497649    .2067798804  |
    +----------------------------------------------+

: end
-------------------------------------------------------------------------------

. </code></pre>
</div>
</div>
<p>or compare it to</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">reg</span> lnwage educ exper female, <span class="kw">cluster</span>(isco)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Linear regression                               Number of obs     =      1,434
                                                F(3, 8)           =      59.13
                                                Prob &gt; F          =     0.0000
                                                R-squared         =     0.2217
                                                Root MSE          =     .46897

                                   (Std. err. adjusted for 9 clusters in isco)
------------------------------------------------------------------------------
             |               Robust
      lnwage | Coefficient  std. err.      t    P&gt;|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        educ |   .0858252   .0149254     5.75   0.000     .0514071    .1202432
       exper |   .0147343   .0015432     9.55   0.000     .0111756     .018293
      female |  -.0949227   .0557559    -1.70   0.127    -.2234961    .0336506
       _cons |    2.21885   .2067799    10.73   0.000     1.742015    2.695685
------------------------------------------------------------------------------</code></pre>
</div>
</div>
</section>
<section id="beware-of-over-clustering" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="beware-of-over-clustering">Beware of over-clustering</h2>
<p>While clustering helps address a problem of ‚Äúintragroup‚Äù correlation, it can/should be done with care. It is important to be aware about some unintended problems of using Correlation.</p>
<ol type="1">
<li><p>CV0 and CV1 work well when you have a large number of Clusters. How many? MHE(2009) says‚Ä¶42 (this is like having large enough samples for Asymptotic variance). If # clusters are small, you would do better with other approaches (including CV2 and CV3).</p></li>
<li><p>When you cluster your standard errors, you will ‚Äúmost-likely‚Äù generate larger standard errors in your model. Standard recommendation (MHE) is to cluster at the level that makes sense (based on data) and produces largest SE (to be conservative).</p></li>
</ol>
</section>
<section id="role-of-clusters" class="level2">
<h2 class="anchored" data-anchor-id="role-of-clusters">Role of clusters</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/clse.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Standard Errors</figcaption>
</figure>
</div>
</section>
<section id="section-3" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="section-3"></h2>
<ol start="3" type="1">
<li><p>You may also consider that clustering does not work well when sample sizes within cluster are to diverse (micro vs macro clusters)</p></li>
<li><p>And there is the case where clustering is required among multiple dimensions (see <code>vcemway</code>). Where the unobserved correlation could be present in different dimensions.</p></li>
</ol>
<p>So what to cluster and how?</p>
<ul>
<li><p>Mackinnon et al (2023) provides a guide on how and when to cluster your standard errors. (some are quite advanced)</p></li>
<li><p>General practice, At least use Robust SE (HC2 or HC3 if sample is small), but use clustered SE for robustness.</p></li>
<li><p>You may want to cluster SE based on some theoretical expectations. Choose -broader- groups for conservative analysis.</p></li>
<li><p>In treatment-causal effect analysis, you may want to cluster at the ‚Äútreatment‚Äù level.</p></li>
</ul>
<blockquote class="blockquote">
<p>But‚Ä¶Beyond hc0/1 and CV0/1 there is not much out there for correcting Standard errors in nonlinear models.</p>
</blockquote>
</section>
<section id="the-bootstrap" class="level1">
<h1>The Bootstrap</h1>
<section id="if-you-cant-sandwich-you-can-re-sample" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="if-you-cant-sandwich-you-can-re-sample">If you can‚Äôt Sandwich ü•™, you can re-Sample</h2>
<ul>
<li><p>The discussion above refereed to the estimation of SE using <span class="math inline">\(Math\)</span>. In other words, it was based on the asymptotic properties of the data. Which may not work in small samples.</p></li>
<li><p>An alternative, often used by practitioners, is using re-sampling methods to obtain approximations to the coefficient distributions of interest.</p></li>
</ul>
<p>But‚Ä¶ How does it work?ü§î</p>
<p>First ask yourself, how does Asymptotic theory work (and econometrics)? üò±</p>
<blockquote class="blockquote">
<p><span class="smallcaps">Note: I recommend reading the -simulation- chapter in The effect, and simulation methods chapter in CT.</span></p>
</blockquote>
</section>
<section id="a-brief-reviewagain" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="a-brief-reviewagain">A Brief Review‚Ä¶again üòá</h2>
<p>If I were to summarize most of the methodologies (ok all) we used last semester, and this one, the properties that have been derived and proofed are based on the assumption that we ‚Äúcould‚Äù always get more data (frequentist approach).</p>
<p>There is population (or supper population) from where we can get samples of data.</p>
<ol type="1">
<li><p>We get a sample (<span class="math inline">\(y,X\)</span>) (of size N)</p></li>
<li><p>Estimate our model : <code>method</code>(<span class="math inline">\(y,X\)</span>)<span class="math inline">\(\rightarrow\)</span> <span class="math inline">\(\beta's\)</span></p></li>
<li><p>Repeat to infinitum</p></li>
<li><p>Collect all <span class="math inline">\(\beta's\)</span> and summarize. (Mean and Standard deviations)</p></li>
</ol>
<p>Done.</p>
<p>The distributions you get from the above exercise should be the same as what your estimation method produces. (if not, there there is something wrong with the estimation method)</p>
</section>
<section id="but-we-only-get-1-sample" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="but-we-only-get-1-sample">But we only get 1 Sample!</h2>
<p>The truth is we do not have access to multiple samples. Getting more data, is in fact, very expensive. So what to do ?</p>
<ul>
<li><p>Rely on Asymptotic theory</p></li>
<li><p>learn Bayesian Econometrics ü•∫</p></li>
<li><p>or-resample? and do Bootstrap!</p></li>
</ul>
<p><strong>Basic idea of Bootstrapping</strong></p>
<ul>
<li><p>In the ideal scenario, you get multiple samples from your population, Estimate parameters, and done.</p></li>
<li><p>If not possible you do the next best thing. You get your sample (assume is your mini-population),</p>
<ul>
<li><p>Draw subsamples of same size (with replacement) (<span class="math inline">\(y_i^s,X_i^s\)</span>)</p></li>
<li><p>estimate your model and obtain parameters <span class="math inline">\(\beta^s_i\)</span></p></li>
<li><p>Summarize those parameters‚Ä¶and done, you get <span class="math inline">\(Var(\hat\beta)\)</span> for üÜì. (or is it?)</p></li>
</ul></li>
</ul>
</section>
<section id="bootstrapping" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="bootstrapping">Bootstrapping</h2>
<ul>
<li>üë¢Bootstrapping is a methodology that allows you to obtain empirical estimations of standard errors making use of the data in hand, and without even knowing about Asymptotic theory (other than how to get means and variances).</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/bss.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Bootstrap Sample</figcaption>
</figure>
</div>
<ul>
<li>And of course, it comes in different flavors.</li>
</ul>
</section>
<section id="bootstrap-types" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="bootstrap-types">Bootstrap Types:</h2>
<ul>
<li><p><strong>Non-parametric Bootstrap</strong>: You draw subsamples from the main sample. Each observation has the same pr of being selected.</p>
<ul>
<li><p>Easiest to implement ( <code>see bootstrap:</code>)</p></li>
<li><p>Works in almost all cases, but you may have situations when some covariates are rare.</p></li>
<li><p>Can be extended to allow ‚Äúclusters‚Äù using ‚Äúblock bootstrapping‚Äù. Works best if re-sampling ‚Äúfollows‚Äù the same sampling structure as your sample.</p></li>
</ul></li>
<li><p><strong>Parametric Bootstrap:</strong> You estimate your model, make assumptions of your model error.</p>
<ul>
<li><p>You need to implement it on your own. <span class="math inline">\(y^s=x\hat b+\tilde e\)</span> for <span class="math inline">\(\tilde e \sim f(\hat \theta)\)</span></p></li>
<li><p>It will not work well if the assumptions of the error modeling are wrong.</p></li>
</ul></li>
<li><p><strong>Residual bootstrap:</strong> Estimate your model, obtain residuals. Re-sample residuals</p>
<ul>
<li>Again, implement it on your own. <span class="math inline">\(y^s = x\hat b+\tilde e\)</span> for <span class="math inline">\(\tilde e \sim {\hat e_1 , ... , \hat e_N}\)</span></li>
<li>It depends even more on the assumptions of the error modeling.</li>
</ul></li>
</ul>
</section>
<section id="section-4" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="section-4"></h2>
<ul>
<li><p><strong>UWild bootstrap</strong>: Estimate your model, obtain residuals, and re-sample residual weights.</p>
<ul>
<li><p>Again‚Ä¶on your own: <span class="math inline">\(y^s = x\hat b +\hat e * v\)</span> , where <span class="math inline">\(v \sim ff()\)</span> where <span class="math inline">\(ff()\)</span> is a ‚Äúgood‚Äù distribution function. <span class="math inline">\(E(v)=0 \ \&amp; \ Var(v)=1\)</span></p></li>
<li><p>Actually quite flexible, and works well under heteroskedasticity!</p></li>
<li><p>It can also allow clustered standard errors. The error <span class="math inline">\(v\)</span> no longer changes by individual, but by group. It also works well with weights.</p></li>
</ul></li>
<li><p><strong>UWild bootstrap-2</strong> : Estimate your model, obtain Influence functions üò± , and re-sample residual weights.</p>
<ul>
<li>This is an extension to the previous option. But with advantages
<ul>
<li><p>you do not need to -reestimate- the model. Just look into how the the mean of IF‚Äôs change.</p></li>
<li><p>it can be applied to linear and nonlinear model (if you know how to build the IF‚Äôs)</p></li>
</ul></li>
<li>Works well with clustered and weights.</li>
</ul></li>
<li><p><strong>CWild bootstrap:</strong> Similar UWild Bootstrap, Obtain Influence functions under the Null (imposing restrictions), and use that to test the NULL.</p>
<ul>
<li><p>No, you do not need to do it on your own. <code>see bootest</code> in <code>Stata</code>.</p></li>
<li><p>Works pretty well with small samples and small # clusters. Probably the way to go if you really care about Standard errors.</p></li>
</ul></li>
</ul>
</section>
<section id="how-to-bootstrap-in-stata" class="level2">
<h2 class="anchored" data-anchor-id="how-to-bootstrap-in-stata">How to Bootstrap? in <code>Stata</code></h2>
<p>I have a few notes on Bootstrapping here <a href="https://friosavila.github.io/playingwithstata/main_bootstrap.html">Bootstrapping in Stata</a>. But let me give you the highlights for the most general case.</p>
<ol type="1">
<li><p>Most (if not all commands) in <code>Stata</code> allow you to obtain bootstrap standard errors, by default. see:<code>help [cmd]</code></p>
<p>they usually have the following syntax:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>[cmd] <span class="fu">y</span> x1 <span class="kw">x2</span> x3, <span class="kw">vce</span>(<span class="kw">bootstrap</span>, options)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">regress</span> lnwage educ exper female, <span class="kw">vce</span>(<span class="kw">bootstrap</span>, reps(100))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>However, you can also Bootstrap that commands that do not have their own <code>bootstrap</code> option.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">bootstrap</span>:[cmd] <span class="fu">y</span> x1 <span class="kw">x2</span> x3, </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">bootstrap</span>, reps(100):<span class="kw">regress</span> lnwage educ exper female</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">bootstrap</span>, reps(100) <span class="kw">cluster</span>(isco):<span class="kw">regress</span> lnwage educ exper female</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ol>
</section>
<section id="section-5" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="section-5"></h2>
<ol start="3" type="1">
<li>This last command may allow you to bootstrap multiple models at the same time, although it does require a bit of programming. (and a do file)</li>
</ol>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> tchild = kids6 + kids714</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">capture</span> <span class="kw">program</span> <span class="kw">drop</span> bs_wages_children</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="kw">program</span> bs_wages_children, <span class="kw">eclass</span> <span class="co">// eclass is for things like equations</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    ** Estimate first <span class="kw">model</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">reg</span> lnwage educ exper female</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span> b1 = <span class="fu">e</span>(b)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span> <span class="ot">coleq</span> b1 = lnwage</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    ** Estimate second <span class="kw">model</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">reg</span> tchild educ exper female</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span> b2 = <span class="fu">e</span>(b)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span> <span class="ot">coleq</span> b2 = tchild</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    ** Put things together and <span class="kw">post</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span> b = b1 , b2</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ereturn</span> <span class="kw">post</span> b</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="kw">bootstrap</span>: bs_wages_children</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
(running bs_wages_children on estimation sample)

warning: bs_wages_children does not set e(sample), so no observations will be
         excluded from the resampling because of missing values or other
         reasons. To exclude observations, press Break, save the data, drop
         any observations that are to be excluded, and rerun bootstrap.

Bootstrap replications (50): .........10.........20.........30.........40......
&gt; ...50 done

Bootstrap results                                        Number of obs = 1,434
                                                         Replications  =    50

------------------------------------------------------------------------------
             |   Observed   Bootstrap                         Normal-based
             | coefficient  std. err.      z    P&gt;|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
lnwage       |
        educ |   .0858252   .0058256    14.73   0.000     .0744072    .0972431
       exper |   .0147343   .0011288    13.05   0.000      .012522    .0169466
      female |  -.0949227   .0283363    -3.35   0.001     -.150461   -.0393845
       _cons |    2.21885   .0826592    26.84   0.000     2.056841    2.380859
-------------+----------------------------------------------------------------
tchild       |
        educ |   .0177854   .0091641     1.94   0.052     -.000176    .0357468
       exper |  -.0047747   .0017288    -2.76   0.006     -.008163   -.0013864
      female |  -.1306332   .0457432    -2.86   0.004    -.2202883   -.0409781
       _cons |   .4163459   .1156959     3.60   0.000     .1895861    .6431058
------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>Why does it matter? because you may want to test coefficients individually, or across models. This is only possible if the FULL system is estimated jointly</p>
</section>
<section id="final-words-on-bootstrap" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="final-words-on-bootstrap">Final words on Bootstrap:</h2>
<p>So bootstrap (and its many flavors) are convenient approaches to estimate standard errors and elaborate statistical Inference, but its not infallible.</p>
<ol type="1">
<li>If the re-sampling process does not simulate the true sampling design, we may miss important information when constructing SE.</li>
<li>When the parameters are estimated using ‚Äúhard‚Äù cutoffs or restricted distributions, it may not produce good approximations for SE.</li>
<li>You usually require MANY repetitions (standard = 50, but you probably want 999 or more). The more the better, but has some computational costs. (specially simple bs)</li>
<li>Some methods play better with weighted samples, clusters, and other survey designs than others. And some require more know-how than others.</li>
</ol>
<p>So choose your üî´weapon wisely!</p>
</section>
</section>
<section id="small-diversion-the-delta-method" class="level1">
<h1>Small Diversion ü¶å: The Delta Method</h1>
<section id="variance-of-nonlinear-functions" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="variance-of-nonlinear-functions">Variance of nonlinear functions</h2>
<div class="incremental">
<ul class="incremental">
<li><p>Some times (perhaps not with simple OLS) you many need to estimate Standard errors for transformations of your main coefficient of interest, or combinations of those coefficients.</p></li>
<li><p>Say that you estimated <span class="math inline">\(\theta \sim N(\mu_\theta, \sigma^2_\theta)\)</span> but are interested in the distribution of <span class="math inline">\(g(\theta)\)</span>. How do you do this?</p></li>
<li><p>Two options:</p>
<ol class="incremental" type="a">
<li>you re estimate <span class="math inline">\(g(\theta\)</span>) instead, or</li>
<li>you make an approximation, using the <strong>Delta Method</strong></li>
</ol></li>
<li><p>How does it work?<br>
</p></li>
</ul>
</div>
</section>
<section id="section-6" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="section-6"></h2>
<ul>
<li><p>The <strong>Delta method</strong> uses the linear approximations to approximate the distribution of otherwise not known distributions.</p></li>
<li><p>Further, It relies on the fact that linear transformations a normal distribution, is on itself normal. For example:</p></li>
</ul>
<p><span class="math display">\[
g(\hat \theta) \simeq g(\theta) + g'(\hat\theta) (\hat \theta-\theta)
\]</span></p>
<ul>
<li><p>This states that the nonlinear function <span class="math inline">\(g(\theta)\)</span> can be ‚Äúlocally‚Äù approximated as a linear function in the neighborhood of <span class="math inline">\(g(\theta)\)</span>.</p></li>
<li><p>Predictions above or below are approximated using the slope of the function. <span class="math inline">\(g'(\theta)\)</span>.</p></li>
<li><p>So, if we take the variance, we get:</p></li>
</ul>
<p><span class="math display">\[
Var(g(\hat \theta)) \simeq  Var \left(g(\theta)+ g'(\hat\theta) (\hat \theta-\theta)\right)
=g'(\hat\theta)^2 Var(\theta)
\]</span></p>
</section>
<section id="delta-method-visualization" class="level2">
<h2 class="anchored" data-anchor-id="delta-method-visualization">Delta Method: Visualization</h2>
<p><img src="resources/dm.png" class="img-fluid"></p>
</section>
<section id="section-7" class="level2">
<h2 class="anchored" data-anchor-id="section-7"></h2>
<p>It can go multivariate as well:<br>
<span class="math display">\[
\begin{aligned}
g(\hat \theta, \hat \gamma)-g(\theta,\gamma) &amp;\simeq N(0,\nabla g ' \Sigma \nabla g) \\
\nabla g ' &amp;=   [\begin{matrix}
    dg/d\theta &amp; dg/d\gamma
  \end{matrix}]
\end{aligned}  
\]</span></p>
</section>
<section id="so-why-do-we-care" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="so-why-do-we-care">So why do we care:</h2>
<p>Two reasons:</p>
<ul>
<li><p>Nonlinear models need this kind of approximations to do statistical inference (probit/logit)</p></li>
<li><p>Recall that when using Robust Standard errors Joint hypothesis Should be done with Care‚Ä¶</p></li>
</ul>
<p>Consider a linear set of restrictions imposed by the <span class="math inline">\(H_0: R\beta = r\)</span>.</p>
<ol type="1">
<li>Estimate the Variance of <span class="math inline">\(R\beta\)</span></li>
</ol>
<p><span class="math display">\[
Var(R\beta)  = \nabla (R\beta)' Var(\beta) R \nabla (R\beta)'= R' Var(\beta) R
\]</span></p>
<ol start="2" type="1">
<li>Estimate the F value for the Linear Hypothesis (Wald Test)</li>
</ol>
<p><span class="math display">\[
(R\hat \beta-r)' Var(R\beta)^{-1} (R\hat \beta-r)/Q \sim F(Q,N-K)
\]</span></p>
</section>
</section>
<section id="linear-model-selection-and-regularization" class="level1">
<h1>Linear Model Selection and Regularization</h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://www.atakanekiz.com/en/technical/understanding-lasso-and-ridge-regression/featured.jpg" class="img-fluid figure-img"></p>
</figure>
</div>
<section id="what-happens-when-k-is-too-big" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="what-happens-when-k-is-too-big">What happens when K is too big?</h2>
<div class="incremental">
<ul class="incremental">
<li><p>How many variables (max) can you use in a model?</p>
<ul class="incremental">
<li><span class="math display">\[max \ k = rank(X'X)\]</span></li>
</ul></li>
<li><p>What happens when you add too many variables in a model?</p>
<ul class="incremental">
<li><p>Increase Multicolinearity and coefficient variance (too much noise)</p></li>
<li><p>R2 overly large (without explaining much)</p></li>
<li><p>Far more difficult to interpret (too many factors)</p></li>
<li><p>May introduce endogeneity (when it wasnt a problem before)</p></li>
</ul></li>
<li><p>How can you solve the problem?</p>
<ul class="incremental">
<li>You select only a few of the variables, based on theory, and contribution to the model</li>
</ul></li>
<li><p>What if you can‚Äôt choose?</p></li>
</ul>
</div>
</section>
<section id="ml-we-let-the-choose-for-you" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="ml-we-let-the-choose-for-you">ML: We let the üíªChoose for you</h2>
<blockquote class="blockquote">
<p>Before we start. The methodology we will discuss are usually meant to get models with ‚Äúgood‚Äù predictive power, and some times better interpretability, not so much stat-inference (although its possible)</p>
</blockquote>
<p>When you do not know how to choose, you could try select a subset of variables from your model such that you maximize the predictive power of the model.</p>
<p>This should go beyond IN sample predictive power, but instead maximize Out of sample predictive power.</p>
<p>This is typically achieved using the following:</p>
<p><span class="math display">\[
AR^2 = 1-\frac{SSR}{SST}\frac{n-1}{n-k-1} \\
AIC = n^{-1}(SSR + 2k\hat\sigma^2) \\
BIC = n^{-1}(SSR + ln(n) k\hat\sigma^2)
\]</span></p>
<p>Or using a method known as cross-validation (Comparing predictive power using data not used for model estimation)</p>
<p>However, we can always try to estimate a model with all variables!</p>
</section>
<section id="ridge-and-lasso-and-elasticnet" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="ridge-and-lasso-and-elasticnet">Ridge and Lasso and ElasticNet</h2>
<ul>
<li>Recall that when using OLS to obtain <span class="math inline">\(\beta's\)</span>, we try to minimize the following:</li>
</ul>
<p><span class="math display">\[
SSR = \sum_i(y_i - X_i \beta)^2
\]</span></p>
<ul>
<li><p>This has the restrictions of mentioned before (<span class="math inline">\(k &lt; N\)</span>). In addition to letting coefficents vary ‚Äútoo much‚Äù</p></li>
<li><p>An alternative is to use <strong>Ridge</strong> regression, which instead Minimizes the following:</p></li>
</ul>
<p><span class="math display">\[
rSS = \sum_i(y_i - X_i \beta)^2+ \lambda \sum_{k=1}^K\beta_k^2
\]</span></p>
<ul>
<li><p>This essentially aims to find parameters that reduces SSR, but also ‚Äúcontrols‚Äù for how large <span class="math inline">\(\beta's\)</span> can be, using a shrinkage penalty that depends on <span class="math inline">\(\lambda\)</span>.</p></li>
<li><p>If <span class="math inline">\(\lambda = 0\)</span> you get Standard OLS, and if <span class="math inline">\(\lambda \rightarrow \infty\)</span> , you get a situation where all betas (but the constant) are zero. For intermediate values, you may have better models than OLS, because you can balance Bias (when <span class="math inline">\(\beta's\)</span> are zero) with increase variance (when all <span class="math inline">\(\beta's\)</span> vary as they ‚Äúplease‚Äù)</p></li>
</ul>
</section>
<section id="section-8" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="section-8"></h2>
<ul>
<li>We usually start with Ridge, because is relatively Easy to implement, since it has a close form Solution:</li>
</ul>
<p><span class="math display">\[
\beta = (X'X + \lambda I)^{-1}{X'y}
\]</span></p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>frause oaxaca, <span class="kw">clear</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> lnwage!=.</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> male = 1-female</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="kw">mata</span>:</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">y</span> = st_data(.,<span class="st">"lnwage"</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    x = st_data(.,<span class="st">"educ exper female male"</span>),<span class="fu">J</span>(1434,1,1)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    i0 = <span class="fu">I</span>(5);i0[5,5]=0</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    xx = (<span class="kw">cross</span>(x,x)) ; xy = (<span class="kw">cross</span>(x,<span class="fu">y</span>))</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    bb0 = <span class="fu">invsym</span>(xx)*xy </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    bb1 = <span class="fu">invsym</span>(xx:+i0*1)*xy </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    bb10 = <span class="fu">invsym</span>(xx:+i0*10)*xy </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    bb100 = <span class="fu">invsym</span>(xx:+i0*100)*xy </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    bb1000 = <span class="fu">invsym</span>(xx:+i0*1000)*xy </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    bb0,bb1,bb10,bb100,bb1000</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Excerpt from the Swiss Labor Market Survey 1998)
(213 observations deleted)

. mata:
------------------------------------------------- mata (type end to exit) -----
:     y = st_data(.,"lnwage")

:     x = st_data(.,"educ exper female male"),J(1434,1,1)

:     i0 = I(5);i0[5,5]=0

:     xx = (cross(x,x)) ; xy = (cross(x,y))

:     bb0 = invsym(xx)*xy

:     bb1 = invsym(xx:+i0*1)*xy

:     bb10 = invsym(xx:+i0*10)*xy

:     bb100 = invsym(xx:+i0*100)*xy

:     bb1000 = invsym(xx:+i0*1000)*xy

:     bb0,bb1,bb10,bb100,bb1000
                  1              2              3              4
    +-------------------------------------------------------------
  1 |   .0858251775    .0858183338    .0857563567    .0851046501
  2 |   .0147342796    .0147345813    .0147372042    .0147554544
  3 |  -.0949227416    -.047396817   -.0468240416    -.041806663
  4 |             0     .047396817    .0468240416     .041806663
  5 |   2.218849962    2.171466638    2.172174327    2.179690914
    +-------------------------------------------------------------
                  5
     ----------------+
  1     .0778292498  |
  2     .0146298058  |
  3    -.0208062854  |
  4     .0208062854  |
  5     2.266275433  |
     ----------------+

: end
-------------------------------------------------------------------------------

. </code></pre>
</div>
</div>
</section>
<section id="lasso-and-elastic-net" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="lasso-and-elastic-net">Lasso and Elastic Net</h2>
<ul>
<li><p>Ridge is a relatively easy model to understand and estimate, since it has a close form solution. It has the slight disadvantage that you still estimate a coefficient for ‚Äúevery‚Äù variable (tho some are very small)</p></li>
<li><p>Another approach, that overcomes this advantage is known as Lasso.</p></li>
</ul>
<p><span class="math display">\[
LSS = \sum_i(y_i - X_i \beta)^2+ \lambda \sum_{k=1}^K |\beta_k|
\]</span></p>
<ul>
<li>and the one known as Elastic net</li>
</ul>
<p><span class="math display">\[
eSS = \sum_i(y_i - X_i \beta)^2+ \lambda_L \sum_{k=1}^K |\beta_k| +
\lambda_r \sum_{k=1}^K \beta_k^2
\]</span></p>
<ul>
<li><p>Lasso has the advantage of forcing some coefficients exactly to zero, when <span class="math inline">\(\lambda\)</span> is sufficiently large.</p></li>
<li><p>Elastic net tries to use the benefits from both approaches.</p></li>
</ul>
</section>
<section id="lasso-vs-ridge" class="level2">
<h2 class="anchored" data-anchor-id="lasso-vs-ridge">Lasso vs Ridge</h2>
<p><img src="resources/image-394882719.png" class="img-fluid"></p>
</section>
<section id="considerations" class="level2">
<h2 class="anchored" data-anchor-id="considerations">Considerations:</h2>
<p>As with many methodologies, the benefits from this approaches is not free.</p>
<ol type="1">
<li>You need to choose tuning parameters ‚Äúwisely‚Äù using approaches such as AIC, BIC, or cross validation.</li>
<li>The model you get may improve prediction, but inference is not as straight forward.</li>
<li>It also requires working with Standardized coefficients. (so the same penalty can be used for all variables in the model.</li>
</ol>
<p>Nevertheless, they can be used as starting point for model selection.</p>
<p>if interested, look into <code>Stata</code> introduction to <code>Lasso</code> regression. <code>help Lasso intro</code></p>
</section>
<section id="brief-example" class="level2">
<h2 class="anchored" data-anchor-id="brief-example">Brief Example:</h2>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>frause oaxaca, <span class="kw">clear</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> lnwage!=.</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span> lnwage i.age</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> p_ols</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:elasticnet linear lnwage i.age, selection(cv, alllambdas)  <span class="kw">alpha</span>(0)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> p_ridge</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:lasso linear lnwage i.age, selection(cv, alllambdas)  </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> p_lasso</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:elasticnet linear lnwage i.age, selection(cv, alllambdas)   </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> p_elastic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Excerpt from the Swiss Labor Market Survey 1998)
(213 observations deleted)
(option xb assumed; fitted values)
(options xb penalized assumed; linear prediction with penalized coefficients)
(options xb penalized assumed; linear prediction with penalized coefficients)
(options xb penalized assumed; linear prediction with penalized coefficients)</code></pre>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/image-1604739776.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="shrinking-coefficients" class="level2">
<h2 class="anchored" data-anchor-id="shrinking-coefficients">Shrinking Coefficients</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/lasso_ridge.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Lasso vs Ridge</figcaption>
</figure>
</div>
</section>
</section>
<section id="next-non-semi-parametric-models" class="level1">
<h1>Next: Non &amp; Semi Parametric models</h1>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>