<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Fernando Rios-Avila">

<title>Econometrics MSC Levy - Semi- and Non- Parametric regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Econometrics MSC Levy</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../adv_class.html" rel="" target="">
 <span class="menu-text">Adv Methods and Causal Effects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../rmethods/index.html" rel="" target="">
 <span class="menu-text">Research Methods: Econometrics I</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../rm2_return.html" rel="" target="">
 <span class="menu-text">Research Methods II: Applied Methods</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-math-refresher" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Math Refresher</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-math-refresher">    
        <li>
    <a class="dropdown-item" href="../mathref/math_1.html" rel="" target="">
 <span class="dropdown-text">Math Refresher: Basic Calculus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../mathref/math_2.html" rel="" target="">
 <span class="dropdown-text">Math Refresher: Basic Linear Algebra</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../mathref/math_3.html" rel="" target="">
 <span class="dropdown-text">Math Refresher: Basic Statistics and Probability</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../resources.html" rel="" target="">
 <span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#so-what-about-non-parametric" id="toc-so-what-about-non-parametric" class="nav-link" data-scroll-target="#so-what-about-non-parametric">So what about non-parametric?</a></li>
  <li><a href="#ok-but-what-about-semi-parametric" id="toc-ok-but-what-about-semi-parametric" class="nav-link" data-scroll-target="#ok-but-what-about-semi-parametric">Ok but what about Semi-parametric!</a></li>
  <li><a href="#step1-estimation-of-density-functions" id="toc-step1-estimation-of-density-functions" class="nav-link" data-scroll-target="#step1-estimation-of-density-functions">Step1: Estimation of Density functions</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  <li><a href="#histogram-and-kernel-density" id="toc-histogram-and-kernel-density" class="nav-link" data-scroll-target="#histogram-and-kernel-density">Histogram and Kernel Density</a></li>
  <li><a href="#histograms-with-varying-h" id="toc-histograms-with-varying-h" class="nav-link" data-scroll-target="#histograms-with-varying-h">Histograms with Varying h</a></li>
  <li><a href="#kernel-density" id="toc-kernel-density" class="nav-link" data-scroll-target="#kernel-density">Kernel density</a></li>
  <li><a href="#kernel-density-visualization" id="toc-kernel-density-visualization" class="nav-link" data-scroll-target="#kernel-density-visualization">Kernel density: Visualization</a></li>
  <li><a href="#trade-off-bias-vs-variance" id="toc-trade-off-bias-vs-variance" class="nav-link" data-scroll-target="#trade-off-bias-vs-variance">Trade off: Bias vs variance</a></li>
  <li><a href="#kdensity-bias-vs-variance" id="toc-kdensity-bias-vs-variance" class="nav-link" data-scroll-target="#kdensity-bias-vs-variance">Kdensity, Bias vs Variance</a></li>
  <li><a href="#other-considerations" id="toc-other-considerations" class="nav-link" data-scroll-target="#other-considerations">Other Considerations</a></li>
  <li><a href="#kfunctions" id="toc-kfunctions" class="nav-link" data-scroll-target="#kfunctions">Kfunctions</a></li>
  <li><a href="#non-parametric-regression" id="toc-non-parametric-regression" class="nav-link" data-scroll-target="#non-parametric-regression">Non-parametric Regression</a>
  <ul class="collapse">
  <li><a href="#np---regression" id="toc-np---regression" class="nav-link" data-scroll-target="#np---regression">NP - Regression</a></li>
  <li><a href="#univariate-case" id="toc-univariate-case" class="nav-link" data-scroll-target="#univariate-case">Univariate case</a></li>
  <li><a href="#local-constant-regression" id="toc-local-constant-regression" class="nav-link" data-scroll-target="#local-constant-regression">Local Constant Regression</a></li>
  <li><a href="#visuals" id="toc-visuals" class="nav-link" data-scroll-target="#visuals">Visuals</a></li>
  <li><a href="#considerations" id="toc-considerations" class="nav-link" data-scroll-target="#considerations">Considerations</a></li>
  <li><a href="#choosing-h" id="toc-choosing-h" class="nav-link" data-scroll-target="#choosing-h">Choosing h</a></li>
  <li><a href="#cross-validation-intuition" id="toc-cross-validation-intuition" class="nav-link" data-scroll-target="#cross-validation-intuition">Cross Validation: Intuition</a></li>
  <li><a href="#cross-validation-in-stata" id="toc-cross-validation-in-stata" class="nav-link" data-scroll-target="#cross-validation-in-stata">Cross-validation in <code>Stata</code></a></li>
  <li><a href="#loocv" id="toc-loocv" class="nav-link" data-scroll-target="#loocv">LOOCV</a></li>
  <li><a href="#extending-from-constant-to-polynomial" id="toc-extending-from-constant-to-polynomial" class="nav-link" data-scroll-target="#extending-from-constant-to-polynomial">Extending from constant to Polynomial</a></li>
  <li><a href="#local-constant-to-local-polynomial" id="toc-local-constant-to-local-polynomial" class="nav-link" data-scroll-target="#local-constant-to-local-polynomial">Local Constant to Local Polynomial</a></li>
  <li><a href="#statistical-inference" id="toc-statistical-inference" class="nav-link" data-scroll-target="#statistical-inference">Statistical Inference</a></li>
  <li><a href="#stata-example" id="toc-stata-example" class="nav-link" data-scroll-target="#stata-example"><code>Stata</code> Example</a></li>
  <li><a href="#other-types-of-non-parametric-models" id="toc-other-types-of-non-parametric-models" class="nav-link" data-scroll-target="#other-types-of-non-parametric-models">Other types of “non-parametric” models</a></li>
  <li><a href="#non-parametric-series" id="toc-non-parametric-series" class="nav-link" data-scroll-target="#non-parametric-series">Non-parametric series</a></li>
  <li><a href="#np-series---tuning" id="toc-np-series---tuning" class="nav-link" data-scroll-target="#np-series---tuning">NP series - tuning</a></li>
  <li><a href="#np-series---se-and-mfx" id="toc-np-series---se-and-mfx" class="nav-link" data-scroll-target="#np-series---se-and-mfx">NP series - SE and Mfx</a></li>
  <li><a href="#np-series-implementation-marginal-effects" id="toc-np-series-implementation-marginal-effects" class="nav-link" data-scroll-target="#np-series-implementation-marginal-effects">NP series: Implementation marginal effects</a></li>
  <li><a href="#semiparametric-regressions" id="toc-semiparametric-regressions" class="nav-link" data-scroll-target="#semiparametric-regressions">Semiparametric Regressions</a></li>
  <li><a href="#partially-linear-model" id="toc-partially-linear-model" class="nav-link" data-scroll-target="#partially-linear-model">Partially Linear model</a></li>
  <li><a href="#generalized-additive-model" id="toc-generalized-additive-model" class="nav-link" data-scroll-target="#generalized-additive-model">Generalized Additive model</a></li>
  <li><a href="#smooth-coefficient-model" id="toc-smooth-coefficient-model" class="nav-link" data-scroll-target="#smooth-coefficient-model">Smooth Coefficient model</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  <li><a href="#example-1" id="toc-example-1" class="nav-link" data-scroll-target="#example-1">Example</a></li>
  </ul></li>
  <li><a href="#the-end-next-time-quantile-regressions" id="toc-the-end-next-time-quantile-regressions" class="nav-link" data-scroll-target="#the-end-next-time-quantile-regressions">The end: Next time Quantile regressions</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="03par_spar_npar.html"><i class="bi bi-file-slides"></i>RevealJS</a></li><li><a href="03par_spar_npar.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Semi- and Non- Parametric regression</h1>
<p class="subtitle lead">How flexible is flexible enough?</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Fernando Rios-Avila </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>What exactly do we mean with non parametric??</p>
<ul>
<li><p>First of all, everything we have done in the last class, concerned to the analysis of parametric relationships between <span class="math inline">\(y\)</span> and <span class="math inline">\(X's\)</span> .</p></li>
<li><p>Why parametric? Because we assume that the relationship between those variables is linear, so we just need to estimate the <em>parameters</em> of that relationship. (<span class="math inline">\(\beta's\)</span>). Even tho the CEF was on itself non-parametric.</p></li>
<li><p>This was just a matter of convince. Instead of trying to estimate all possible conditional means (impossible task?) we impose functional form conditions, to identify the relationship of interest.</p></li>
<li><p>When we covered MLE (last semester) we even imposed functional forms assumptions on relationships and distribution!</p></li>
</ul>
</section>
<section id="so-what-about-non-parametric" class="level2">
<h2 class="anchored" data-anchor-id="so-what-about-non-parametric">So what about non-parametric?</h2>
<ul>
<li><p>Non-parametric is on the other side of the spectrum. There are no “single” parameters to estimate, but rather it tries to be as flexible as possible, to identify all possible relationships in the data.</p></li>
<li><p>In terms of distributions, it no longer assumes data distributes as normal, poisson, exponential, etc. Instead, it simply assumes it distributes, however it does. 🤔 But isnt that a problem?</p></li>
<li><p>Yes it can be.</p>
<ul>
<li><p>On the one hand Parametric modeling is very “strict” regarding functional forms. (linear quadratic, logs, etc).</p></li>
<li><p>On the other, Non-parametric can be too flexible. Making the problem almost impossible to solve.</p></li>
</ul></li>
<li><p>However, the benefits of letting your data “speak” for itself, would allow you to avoid some problems with parametric models. At least is some balance can be set on the “flexibility”</p></li>
</ul>
</section>
<section id="ok-but-what-about-semi-parametric" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="ok-but-what-about-semi-parametric">Ok but what about Semi-parametric!</h2>
<ul>
<li><p>Semi-parametric models try to establish a mid point between parametric and non-parametric models, attempting to draw from the benefit of both.</p>
<ul>
<li>It also helps that it has a smaller computational burden (we will see what do i mean with this.</li>
</ul></li>
<li><p>What about an example? Say we are trying to explain “wages” as a function of age and education. (assume exogeneity)</p>
<p>Theoretical framework : <span class="math display">\[wage = g(age, education, \varepsilon)
\]</span></p>
<p>Parametric model: <span class="math display">\[wage = b_0 + b_1 age + b_2 education +\varepsilon
\]</span></p>
<p>Non-parametric model: <span class="math display">\[
wage = g(age,education) +\varepsilon
\]</span></p>
<p>Semi-parametric model:</p></li>
</ul>
<p><span class="math display">\[wage = b_0 + g_1(age) + g_2(education) +\varepsilon \\ wage = g_0(age)+b1 education+\varepsilon \\ wage = g_0(age)+g_1 (age)education+\varepsilon
\]</span></p>
</section>
<section id="step1-estimation-of-density-functions" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="step1-estimation-of-density-functions">Step1: Estimation of Density functions</h2>
<ul>
<li><p>The first step towards learning non-parmetric analysis, is by learning to use the most basic task of all.</p></li>
<li><p><strong>Estimating distributions (PDFs)</strong> : why? in economics, and other social sciences, we care about distributions!</p>
<p>Distribution of income, how many live under poverty, how much is concentrated among the rich, how skew the distribution is, what is the level of inequality, etc, etc</p></li>
<li><p>The parametric approach to estimating distribution, is by using some predefined functional form (say normal), and use the data to estimate the parameters that define that distribution:</p></li>
</ul>
<p><span class="math display">\[
\hat f(x) = \frac{1}{\sqrt{2\pi\hat\sigma^2}}exp \left(-\frac{1}{2}\left(\frac{x-\hat \mu}{\hat \sigma}\right)^2 \right)
\]</span></p>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>
<ul>
<li>Which can be done rather easy in <code>Stata</code></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>frause oaxaca, <span class="kw">clear</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">if</span> lnwage==.</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">sum</span> lnwage</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> f = <span class="fu">normalden</span>(lnwage, <span class="fu">r</span>(<span class="kw">mean</span>), <span class="fu">r</span>(<span class="fu">sd</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">histogram</span> wages</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="resources/pdensity.png" class="img-fluid"></p>
<p>But as you can see, it does not fit well.</p>
</section>
<section id="histogram-and-kernel-density" class="level2">
<h2 class="anchored" data-anchor-id="histogram-and-kernel-density">Histogram and Kernel Density</h2>
<p>Histograms and Kernel densities (you probably have used a lot) are a type of non-parametric estimators, because they impose no functional form restrictions to estimate <strong>probability density functions (PDFs).</strong></p>
<p>Construction histograms, is in fact, a fairly Straight forward task:</p>
<ol type="1">
<li>You select the width of bins, <span class="math inline">\(h\)</span> , and starting value <span class="math inline">\(x_0\)</span></li>
</ol>
<p><span class="math display">\[if \ x_i \in [x_0 + m * h, x_0 + (m+1)h ) \rightarrow
bin(x)=m+1
\]</span></p>
<ol start="2" type="1">
<li>And the Histogram estimator for density, is given by:</li>
</ol>
<p><span class="math display">\[\hat f (x) = \frac{1}{nh} \sum_i 1(bin(x)=bin(x_i))
\]</span></p>
<p>Simple yet powerful approach to estimate and visualize distributions. But with lots of room for improvement. It may provide very different pictures based on “h”</p>
</section>
<section id="histograms-with-varying-h" class="level2">
<h2 class="anchored" data-anchor-id="histograms-with-varying-h">Histograms with Varying h</h2>
<p><img src="resources/hist_1.png" class="img-fluid"></p>
</section>
<section id="kernel-density" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="kernel-density">Kernel density</h2>
<p>An alternative that overcomes some of the limitations of the Histogram is known as the kernel density estimator. This is defined as:</p>
<p><span class="math display">\[
\hat f(x) = \frac{1}{nh}\sum_i K\left(\frac{X_i-x}{h}\right)
\]</span></p>
<p>where <span class="math inline">\(K\)</span> is what is known as a kernel function.</p>
<p>This function is such that has the following properties:</p>
<p><span class="math display">\[
\int K(z)dz = 1 ; \int zK(z)dz = 0 ; \int z^2K(z)dz &lt; \infty
\]</span></p>
<p>Is a well behaved pdf on its own, that is symmetric, with defined second moment.</p>
<blockquote class="blockquote">
<p>as with the histogram estimator, the Kden is just an average of functions, that has the advantage of being smooth.</p>
<p>Although it also depends strongly, on the choice of bandwidth.</p>
</blockquote>
</section>
<section id="kernel-density-visualization" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="kernel-density-visualization">Kernel density: Visualization</h2>
<p><img src="resources/kden_2.png" class="img-fluid"></p>
</section>
<section id="trade-off-bias-vs-variance" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="trade-off-bias-vs-variance">Trade off: Bias vs variance</h2>
<p>While this estimators are “flexible” in the sense that we impose very simple assumptions for estimation, there is still one parameter that needs attention.</p>
<p>The bandwidth <span class="math inline">\(h\)</span></p>
<p>This does not (or cannot) be estimated, rather, needs to be calibrated to balance two problems in Non-parametric analysis. Bias vs Variance:</p>
<ol type="1">
<li><p>when <span class="math inline">\(h\rightarrow 0\)</span> , the bias of your estimator goes to zero ( in average). Intuitively <span class="math inline">\(\hat f(x)\)</span> is constructed based on information that comes from <span class="math inline">\(x\)</span> alone.</p>
<p>But the variance increases! Because things will vary for every <span class="math inline">\(x\)</span>.</p></li>
<li><p>when <span class="math inline">\(h \rightarrow \infty\)</span> , the bias increases, because you start using data that is very different to <span class="math inline">\(x\)</span> to estimate <span class="math inline">\(\hat f(x)\)</span>.</p>
<p>But variance decreases. Since the “function” is now very smooth (a line?)</p></li>
</ol>
<p>Thus, special attention is needed to choose the right h, which minimizes the problems (bias and variance).</p>
</section>
<section id="kdensity-bias-vs-variance" class="level2">
<h2 class="anchored" data-anchor-id="kdensity-bias-vs-variance">Kdensity, Bias vs Variance</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/kden_3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="other-considerations" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="other-considerations">Other Considerations</h2>
<ol type="1">
<li>As shown above, one needs to choose the bandwidth <span class="math inline">\(h\)</span> carefully, balancing the bias-variance trade off. Common approach is to simply use rule-of-thumb approaches to select this parameter:</li>
</ol>
<p><span class="math display">\[
h = 1.059 \sigma n ^ {-1/5} \\ h = 1.3643 * d * n ^ {-1/5} * min(\sigma,iqr\sigma)
\]</span></p>
<p>But other approaches may work better.</p>
<ol start="2" type="1">
<li>A second consideration is the choice of Kernel function! (<code>see help kdensity -&gt; kernel</code>)
<ul>
<li>Although, except in few cases, the choice of bandwidth matters more than the kernel function.</li>
</ul></li>
<li>This method works well when your data is smooth and continuous. But for so much for discrete data.
<ul>
<li>Nevertheless, it is still possible to use it with discrete data, and kernel weights!</li>
</ul></li>
<li>Can be “easily” extended to multiple dimensions <span class="math inline">\(f(x,y,z,...)\)</span>, including mixture of continuous and discrete data. You just multiple Kernels!
<ul>
<li>But, beware of Curse of dimensionality.</li>
<li>But still better than just Subsampling!</li>
</ul></li>
</ol>
</section>
<section id="kfunctions" class="level2">
<h2 class="anchored" data-anchor-id="kfunctions">Kfunctions</h2>
<p><img src="resources/image-893322693.png" class="img-fluid"></p>
</section>
<section id="non-parametric-regression" class="level1">
<h1>Non-parametric Regression</h1>
<p><img src="resources/smreg_1.png" class="img-fluid"></p>
<section id="np---regression" class="level2">
<h2 class="anchored" data-anchor-id="np---regression">NP - Regression</h2>
<ul>
<li><p>As hinted from the beginning, the idea of non-parametric regressions is related to estimate a model that is as flexible as it can probably be.</p></li>
<li><p>This relates to the CEF, where we want to estimate a conditional mean for every combination of X’s. In other words, you aim to estimate models that are valid “locally”. A very difficult task.</p>
<ul>
<li>You have a limited sample size</li>
<li>You may not see all possible X’s combinations</li>
<li>and for some, you may have micro-samples (n=1) Can you really do something with this?</li>
</ul></li>
<li><p>Yes, make your model flexible, but not overly flexible! but how?</p>
<ul>
<li>Kernel regression ; Spline regression</li>
<li>Polynomial regression; Smoothed Spline regression.</li>
</ul></li>
</ul>
</section>
<section id="univariate-case" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="univariate-case">Univariate case</h2>
<ul>
<li>Consider a univariate case <span class="math inline">\(y,X\)</span> where you only have 1 indep variable, which are related as follows:</li>
</ul>
<p><span class="math display">\[
y = m(x) + e
\]</span></p>
<p>which imposes the <strong><em>simplifying</em></strong> assumption that error is additive.</p>
<ul>
<li>In the parametric case:</li>
</ul>
<p><span class="math display">\[
y =b_0 + b_1 x + b_2 x^2 +b_3 x^3 +...+e
\]</span></p>
<p>(this is, in fact, starting to become less parametric)</p>
<ul>
<li>But in the full (unconstrained) model it would just be (simple conditional mean:</li>
</ul>
<p><span class="math display">\[
E(y|X) = \hat m(x) = \frac{\sum y_i 1(x_i=x)}{\sum 1(x_i=x)}
\]</span></p>
<p>Problems? Impossible to do out out sample predictions, and if <span class="math inline">\(n&lt;42\)</span> inference would be extremely unreliable.</p>
</section>
<section id="local-constant-regression" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="local-constant-regression">Local Constant Regression</h2>
<p>We can improve over the Unconstrained mean using the following connection:</p>
<ol type="1">
<li><p><span class="math inline">\(1(x_i=x)\)</span> is a non smooth indicator that shows if an observation is included (counted towards the mean).</p></li>
<li><p>It can be substituted with <span class="math inline">\(K_h(x_i,x)\)</span>, which is the standardized kernel function. (ie <span class="math inline">\(K_h(x_i,x) = \frac{1}{h} K(\frac{x_i-x}{h})\)</span></p>
<p>Depending on <span class="math inline">\(h\)</span> , it gives the most weight the closer <span class="math inline">\(x_i\)</span> is to <span class="math inline">\(x\)</span>.</p>
<p>This gives what is known as the Nadaraya-Watson or Local constant estimator:</p></li>
</ol>
<p><span class="math display">\[
\hat m(x) = \frac{\sum y_i K_h(x_i,x)}{\sum K_h(x_i,x)} = \sum y_i w_i
\]</span></p>
<p>Which, on its core, is simply a weighted regression, with weights given by <span class="math inline">\(\frac{K_h(x_i,x)}{\sum K_h(x_i,x)}\)</span></p>
<ol start="3" type="1">
<li>Kernel Regressions “borrows” info from neighboring observations to obtain a smooth estimator.</li>
</ol>
</section>
<section id="visuals" class="level2">
<h2 class="anchored" data-anchor-id="visuals">Visuals</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/smreg_2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="considerations" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="considerations">Considerations</h2>
<ol type="1">
<li>Local Constant estimator is simple to estimate with a single variable. And so with multiple variables:</li>
</ol>
<p><span class="math display">\[
\hat m(x,z) = \frac{\sum y_i K_h(x_i,x) \times K_h(z_i,z)}{\sum K_h(x_i,x) \times K_h(z_i,z)}
\]</span></p>
<p>The problem, however, lies on the curse of dimensionality. - More dimensions, less data per <span class="math inline">\((x,z)\)</span> point, unless you “increase” bandwidths.</p>
<ol start="2" type="1">
<li><p>As Before, it all depends on the Bandwidth <span class="math inline">\(h\)</span>.It determines the “flexibility” of the model.</p></li>
<li><p>The local constant tends to have considerable bias (specially near limits of the distribution, or when <span class="math inline">\(g\)</span> has too much curvature)</p></li>
</ol>
</section>
<section id="choosing-h" class="level2">
<h2 class="anchored" data-anchor-id="choosing-h">Choosing h</h2>
<p>The quality of the NPK regression depends strongly on the choice of <span class="math inline">\(h\)</span>. And as with density estimation, the choice translates into a tradeoff between bias and variance of the estimation.</p>
<p>There are various approaches to choose <span class="math inline">\(h\)</span>. Some which depend strongly on the dimensionality of the model.</p>
<p>For Example, <code>Stata</code> command <code>lpoly</code> estimates local constant models, using the following:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/image-1628248108.png" class="img-fluid figure-img" width="300"></p>
</figure>
</div>
<p>But that is not the only approach.</p>
<p>An alternative (used for regularization) is using Cross-Validaton. (a method to evaluate the predictive power of a model)</p>
</section>
<section id="cross-validation-intuition" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="cross-validation-intuition">Cross Validation: Intuition</h2>
<ol type="1">
<li><p>Separate your data in two parts: Training and testing Sample.</p></li>
<li><p>Estimate your model in the TrainS, and evaluate predictive power in TestS.</p></li>
<li><p>To obtain a full view of predictive power, Repeat the process rotating the training set</p></li>
</ol>
<p><span class="math display">\[
mse = \frac{1}{N}\sum(y_i - g_{-k}(x))^2
\]</span></p>
<p>This should give you a better idea of the predictive power of the model.</p>
<p><img src="resources/image-1717331850.png" class="img-fluid" width="800"></p>
</section>
<section id="cross-validation-in-stata" class="level2">
<h2 class="anchored" data-anchor-id="cross-validation-in-stata">Cross-validation in <code>Stata</code></h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>frause oaxaca, <span class="kw">clear</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ssc</span> isntall cv_kfold</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span> lnwage educ exper tenure female age</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>cv_kfold</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">k</span>-fold Cross validation</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> Folds     :          5</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> Repetions :          1</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>Avg Root Mean <span class="kw">SE</span>    :    0.45838</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span> lnwage c.(educ exper tenure female age)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>               ##c.(educ exper tenure female age)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>cv_kfold</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="kw">k</span>-fold Cross validation</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> Folds     :          5</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> Repetions :          1</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>Avg Root Mean <span class="kw">SE</span>    :    0.42768</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>. <span class="kw">qui</span>:<span class="kw">reg</span> lnwage c.(educ exper tenure female age)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                 ##c.(educ exper tenure female age)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                 ##c.(educ exper tenure female age)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>. cv_kfold</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="kw">k</span>-fold Cross validation</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> Folds     :          5</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> Repetions :          1</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>Avg Root Mean <span class="kw">SE</span>    :    0.43038</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="kw">ssc</span> install cv_regress</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>* Does lOOCV <span class="kw">for</span> regression</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>cv_regress</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>Leave-One-Out Cross-Validation Results </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>-----------------------------------------</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>         Method          |    Value</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>-------------------------+---------------</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>Root Mean Squared Errors |       0.4244</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>Log Mean Squared Errors  |      -1.7144</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>Mean Absolute Errors     |       0.2895</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>Pseudo-R2                |      0.36344</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>-----------------------------------------</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="loocv" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="loocv">LOOCV</h2>
<p>Because the “choice” of “folds” and Repetitions, and the randomness, may produce different results every-time, one also has the option of using the “leave-one-out” approach.</p>
<p>This means, leave one observation out, and use the rest to make the predictions.</p>
<p><span class="math display">\[
CV(h) = n^{-1}\sum_{i=1}^n(y_i - \hat g_{-i}(x_i))^2
\]</span></p>
<p>This is not as bad as it looks, since we can use the shortcut</p>
<p><span class="math display">\[
CV(h) = n^{-1}\sum_{i=1}^n\left(\frac{y_i - \hat g(x_i)}{1-w_i/\Sigma w_j}\right)^2
\]</span></p>
<p>In <code>Stata</code>, the command <code>npregress kernel</code> uses this type of cross-validation to determine “optimal” <span class="math inline">\(h\)</span></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>lpoly <span class="fu">y</span> x, kernel(gaussian) <span class="bn">nodraw</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">display</span> <span class="fu">r</span>(bwidth)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>.23992564</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>npregress kernel <span class="fu">y</span> x, estimator(constant) noderiv</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>. Bandwidth</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>-------------------------</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>             |      Mean </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>-------------+-----------</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>           x |  .4064052 </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>-------------------------</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="extending-from-constant-to-polynomial" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="extending-from-constant-to-polynomial">Extending from constant to Polynomial</h2>
<p>An alternative way to understanding the simple NW (local constant) regressions, is to understand it as a local regression model with anything but a constant:</p>
<p><span class="math display">\[
\hat m(x)=min\sum(y_i - \beta_0)^2 w(x,h)_i
\]</span></p>
<p>This means that you could extend the analogy and include “centered” polynomials to the model.</p>
<p><span class="math display">\[
\begin{aligned}
min &amp;\sum(y_i - \beta_0 - \beta_1 (x_i -x) -\beta_2 (x_i - x) ^2 - ...-\beta_k(x_i-x)^k)^2 w(x,h)_i \\
\hat m(x) &amp;= \hat \beta_0
\end{aligned}
\]</span></p>
<p>This is called the local polynomial regression.</p>
<ul>
<li><p>Because its more flexible, it shows less bias when the true function shows a lot of variation.</p></li>
<li><p>Because of added polynomials, it requires more information (larger <span class="math inline">\(h\)</span>)</p></li>
<li><p>It can be used to easily obtain local marginal effects.</p></li>
<li><p>And can also be used with multinomial models (local planes)</p></li>
</ul>
<p><span class="math display">\[min \sum (y_i - \beta_0 - \beta_1 (x_i-x) - \beta_2 (z_i-z))^2 w(x,z,h)
\]</span></p>
</section>
<section id="local-constant-to-local-polynomial" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="local-constant-to-local-polynomial">Local Constant to Local Polynomial</h2>
<div class="columns">
<div class="column" style="width:40%;">
<div class="sourceCode" id="cb4"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">webuse</span> motorcycle</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">two</span> <span class="kw">scatter</span> accel time || <span class="co">///</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>lpoly accel time , degree(0) n(100) || <span class="co">///</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>lpoly accel time , degree(1) n(100) || <span class="co">///</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>lpoly accel time , degree(2) n(100) || <span class="co">///</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>lpoly accel time , degree(3) n(100) , <span class="co">///</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="bn">legend</span>(<span class="kw">order</span>(2 <span class="st">"LConstant"</span> 3 <span class="st">"Local Linear"</span> <span class="co">///</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>4 <span class="st">"Local Cubic"</span> 5 <span class="st">"Local Quartic"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="column" style="width:60%;">
<p><img src="resources/lllreg.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="statistical-inference" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="statistical-inference">Statistical Inference</h2>
<p>For Statistical Inference, since each regression is just a linear model, standard errors can be obtained using the criteria as in Lecture 1. (Robust, Clustered, bootstrapped).</p>
<ul>
<li>With perhaps one caveat. Local estimation and standard errors may need to be estimated “globally”, rather than locally.</li>
</ul>
<p>The estimation of marginal effects becomes a bit more problematic.</p>
<ul>
<li><p>Local marginal effects are straightforward (when local linear or higher local polynomial is used)</p></li>
<li><p>Global marginal effects, can be obtained averaging all local marginal effects.</p></li>
<li><p>However, asymptotic standard errors are difficult to obtain (consider the multiple correlated components), but bootstrapping is still possible.</p></li>
</ul>
</section>
<section id="stata-example" class="level2">
<h2 class="anchored" data-anchor-id="stata-example"><code>Stata</code> Example</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>frause oaxaca</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>npregress kernel lnwage age exper</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>Computing <span class="kw">mean</span> <span class="kw">function</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>Minimizing <span class="kw">cross</span>-validation <span class="kw">function</span>:</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>Iteration 0:   Cross-validation criterion = -1.5904753  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>Iteration 1:   Cross-validation criterion = -1.5906158  </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>Iteration 2:   Cross-validation criterion = -1.5907243  </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>Iteration 3:   Cross-validation criterion = -1.5911389  </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>Iteration 4:   Cross-validation criterion = -1.5911389  </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>Iteration 5:   Cross-validation criterion = -1.5911855  </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>Iteration 6:   Cross-validation criterion = -1.5912075  </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>Computing optimal derivative bandwidth</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>Iteration 0:   Cross-validation criterion =  .01378252  </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>Iteration 1:   Cross-validation criterion =   .0019967  </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>Iteration 2:   Cross-validation criterion =  .00196967  </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>Iteration 3:   Cross-validation criterion =  .00196371  </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>Bandwidth</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>------------------------------------</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>             |      Mean     Effect </span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>-------------+----------------------</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>         age |  2.843778   15.10978 </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>       exper |  3.113587   16.54335 </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>------------------------------------</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>Local-linear regression                    Number <span class="kw">of</span> <span class="kw">obs</span>      =          1,434</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>Kernel   : epanechnikov                    E(Kernel <span class="kw">obs</span>)      =          1,434</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>Bandwidth: <span class="kw">cross</span>-validation                R-squared          =         0.3099</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------------</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>      lnwage |   Estimate</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>-------------+----------------------------------------------------------------</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>Mean         |</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      lnwage |   3.339269</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>-------------+----------------------------------------------------------------</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>Effect       |</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>         age |   .0169326</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>       exper |  -.0010196</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------------</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>Note: Effect <span class="kw">estimates</span> are averages <span class="kw">of</span> derivatives.</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>Note: You may compute standard errors <span class="kw">using</span> <span class="kw">vce</span>(<span class="kw">bootstrap</span>) <span class="kw">or</span> reps().</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="other-types-of-non-parametric-models" class="level2">
<h2 class="anchored" data-anchor-id="other-types-of-non-parametric-models">Other types of “non-parametric” models</h2>
<p>We have explored the basic version of <strong>non-parametric</strong> modeling. But its not the only one.</p>
<p>There are at least two others that are <em>easy</em> to implement.</p>
<ol type="1">
<li>Nonparametric Series Regression (we will see this)</li>
<li>Smoothing series/splines: Which borrows from Series regression and Ridge Regression.</li>
</ol>
</section>
<section id="non-parametric-series" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="non-parametric-series">Non-parametric series</h2>
<p>This approach assumes that model flexibility can achieve by using “basis” functions in combination with Interactions, but using “global” regressions (OLS)</p>
<p>But what are “basis” functions? They are a collection of terms that approximates smooth functions arbitrarily well.</p>
<p><span class="math display">\[
\begin{aligned}
y &amp;= m(x,z)+e  \\
m(x,z)  &amp;= B(x)+ B(z)+B(x)*B(z)  \\
B(x)  &amp;= (x, x^2, x^3,...) \\
B(x)  &amp; = fracPoly \\
B(x)  &amp;= (x, max(0,x-c_1), max(0,x-c_2), ... \\
B(x)  &amp;= (x,x^2,max(0,x-c_1)^2, max(0,x-c_2)^2, ... \\
B(x)  &amp;= B-splines
\end{aligned}
\]</span></p>
<ul>
<li><p>Polynomials can be used, but there may be problems with high order polynomials. (<em>Runge’s phenomenon,multiple-co-linearity</em>). They are “global” estimators.</p></li>
<li><p>Fractional polynomials: More flexible than polynomials, without producing “waves” on the predictions</p></li>
<li><p>Natural Splines, are better at capturing smooth transitions (depending on degree). Require choosing Knots appropriately.</p></li>
<li><p>B-splines are similar to N-splines, but with better stat properties. Also require choosing knots</p></li>
</ul>
<p>Except for correctly estimating the Bases functions (fracpoly and Bsplines are not straight forward), estimation requires simple OLS.</p>
</section>
<section id="np-series---tuning" class="level2">
<h2 class="anchored" data-anchor-id="np-series---tuning">NP series - tuning</h2>
<ul>
<li><p>While NP-series are easy to estimate, we also need to address problems of over-fitting.</p></li>
<li><p>With Polynomial: What degree of polynomial is correct? What about the degree of the interactions?</p></li>
<li><p>Fractional Polynomials: How many terms are needed, what would their “degrees” be.</p></li>
<li><p>Nsplines, Bsplines: How to choose degree? and where to set the knots?</p></li>
</ul>
<p>These questions are similar to the choosing <span class="math inline">\(h\)</span> in kernel regressions. However, model choice is simple…Cross validation.</p>
<blockquote class="blockquote">
<p>Estimate a model under different specifications (cut offs), and compare the out-of-sample predictive power. (<code>see Stata: cv_kfold or cv_regress</code>)</p>
</blockquote>
<p>One more problem left. Statistical Inference</p>
</section>
<section id="np-series---se-and-mfx" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="np-series---se-and-mfx">NP series - SE and Mfx</h2>
<p>Lecture 1 applies here. Once the model has been chosen, you can estimate SE using appropriate methods. There is only one caveat</p>
<ul>
<li>Standard SE estimation ignores the uncertainty of choosing cut-offs or polynomial degrees. In principle, cut-offs uncertainty can be modeled. But requires non-linear estimation.</li>
</ul>
<p>Marginal effects are somewhat easier for some basis. Just take derivatives:</p>
<p><span class="math display">\[
y = b_0 + b_1 x + b_2 x^2 +b_3 max(0,x-c)^2 + e \\
\frac{dy}{dx}=b_1 + 2 b_2 x + 2 b_3 (x-c) 1(x&gt;c)
\]</span></p>
<ul>
<li>But keeping track of derivatives in a multivariate model is difficult, and often, the functions are hard to track down. so how to implement it?</li>
</ul>
</section>
<section id="np-series-implementation-marginal-effects" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="np-series-implementation-marginal-effects">NP series: Implementation marginal effects</h2>
<p>As always, it all depends on how are the models estimated.</p>
<ul>
<li><p><code>Stata</code> command <code>npregress series</code> allows you to estimate this type of models using polynomials, splines and B-splines. And also allows estimates marginal effects for you. (can be slow)</p></li>
<li><p><code>fp</code> estimates fractional polynomials, but does not estimate marginal effects for you.</p></li>
<li><p><code>R</code> is a bit more flexible in terms of tracking down functions as variables (<code>~x+I(x*x)+ln(x)</code>). So it may be “easy” to estimate those effects.</p></li>
<li><p>In <code>Stata</code>, you can use the package <code>f_able</code> to estimate those marginal effects, however. see <a href="https://journals.sagepub.com/doi/pdf/10.1177/1536867X211000005">here</a> for details. and <code>SSC</code> for the latest update.</p></li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>frause oaxaca, <span class="kw">clear</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> agesq</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>f_spline age = age, nk(1) degree(3)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>f_spline exper = exper, nk(1) degree(3)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">regress</span> lnwage c.(age*)##c.(exper*)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>f_able age? exper?, auto </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>margins, <span class="kw">dydx</span>(age exper) noestimcheck </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------------</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>             |            Delta-method</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>             |      dy/dx   <span class="fu">std</span>. err.      z    P&gt;|z|     [95% conf. interval]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>-------------+----------------------------------------------------------------</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>         age |   .0360234   .0033909    10.62   0.000     .0293775    .0426694</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>       exper |   .0082594   .0050073     1.65   0.099    -.0015547    .0180735</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------------</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="semiparametric-regressions" class="level2">
<h2 class="anchored" data-anchor-id="semiparametric-regressions">Semiparametric Regressions</h2>
<ul>
<li><p>Full non-parametric estimations are powerful to identify very flexible functional forms. To avoid overfitting, however, one must choose tuning parameters appropriately (<span class="math inline">\(h\)</span> and <span class="math inline">\(cutoffs\)</span> ).</p></li>
<li><p>A disadvantage: Curse of dimensionality. More variables need more data to provide good results. But, the more data you have, the more difficult to estimate (computing time).</p></li>
<li><p>It also becomes extremly difficult to interpret. (too much flexibility)</p></li>
<li><p>An alternative, Use the best of both worlds: Semiparametric regression</p>
<ul>
<li>Flexiblity when needed with the structure of standard regressions, to avoid the downfalls of fully nonparametric models</li>
</ul></li>
</ul>
</section>
<section id="partially-linear-model" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="partially-linear-model">Partially Linear model</h2>
<p><span class="math display">\[
y = x\beta +g(z) +e
\]</span></p>
<p>This model assumes that only a smaller set of covariates need to be estimated non-parametrically in the model.</p>
<p>Estimators:</p>
<ul>
<li><p><code>npregress series</code>: Use BasisF to estimate <span class="math inline">\(g(z)\)</span> . Or other series regressions, fractional polynomial <code>fp</code></p></li>
<li><p>Yatchew 1997: For a single z, sort variables by it, and estimate: <span class="math inline">\(\Delta y=\Delta X\beta+ \Delta g(z) + \Delta e\)</span>. This works because <span class="math inline">\(\Delta g(z)\rightarrow 0\)</span></p>
<p>Estimate <span class="math inline">\(g(z)\)</span> regressing <span class="math inline">\(y-x\hat \beta\)</span> on <span class="math inline">\(z\)</span>. See <a href="https://journals.sagepub.com/doi/pdf/10.1177/1536867X0600600306">plreg</a></p></li>
<li><p>Robinson 1988: Application of FWL. Estimate <span class="math inline">\(y = g_y(z)+e_y\)</span> and <span class="math inline">\(x = g_x(z)+e_x\)</span> and estimate <span class="math inline">\(\beta = (e_x ' e_x)^{-1} e_x ' e_y\)</span> . For <span class="math inline">\(g(z)\)</span> same as before. See <a href="https://journals.sagepub.com/doi/pdf/10.1177/1536867X1201200411">semipar</a>.</p></li>
<li><p>Other methods available see <a href="https://www.stata.com/meeting/uk13/abstracts/materials/uk13_verardi.pdf">semi_stata</a></p></li>
</ul>
</section>
<section id="generalized-additive-model" class="level2">
<h2 class="anchored" data-anchor-id="generalized-additive-model">Generalized Additive model</h2>
<p><span class="math display">\[
y = g(x) +g(z)+e
\]</span></p>
<p>This model assumes the effect of X and Z (or any other variables) are additive separable, and may have a nonlinear effect on y.</p>
<ul>
<li><p><code>npregress series</code>: with non-interaction option. Fractional polynomials <code>mfp</code>, cubic splines <code>mvrs</code> (see <a href="https://journals.sagepub.com/doi/pdf/10.1177/1536867X0700700103">mvrs</a>) , or manual implementation.</p></li>
<li><p>Kernel regression possible. (as in Robinson 1988), but requires an iterative method. (back fitting algorithm)</p>
<ul>
<li><span class="math inline">\(g(x) = smooth (y-g(z)|x)\)</span>, center <span class="math inline">\(g(x)\)</span> , and <span class="math inline">\(g(z) = smooth (y-g(x)|z)\)</span>, center <span class="math inline">\(g(z)\)</span> until convergence</li>
</ul></li>
<li><p>In general, it can be easy to apply, but extra work required for marginal effects.</p></li>
</ul>
</section>
<section id="smooth-coefficient-model" class="level2">
<h2 class="anchored" data-anchor-id="smooth-coefficient-model">Smooth Coefficient model</h2>
<p><span class="math display">\[
y = g_0(z)+g_1(z)x + e
\]</span></p>
<p>This model assumes that <span class="math inline">\(X's\)</span> have a locally linear effect on $y$, but that effect varies across values of <span class="math inline">\(z\)</span>, in a non-parametric way.</p>
<ul>
<li><p><code>fp</code> or manual implementation of basis functions, with interaction. May allow for multiple variables in <span class="math inline">\(z\)</span></p></li>
<li><p>One can also use Local Kernel regressions. locally weighted regression where All X variables are considered fixed, or interacted with polynomials of Z. Choice of bandwidth problematic, but doable (LOOCV).</p>
<p><a href="https://journals.sagepub.com/doi/abs/10.1177/1536867X20953574">vc_pack</a> can estimate this models with a single z, as well as test it. Overall marginal effects still difficult to obtain.</p></li>
</ul>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>frause oaxaca</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>npregress kernel lnwage age exper</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>margins, <span class="kw">dydx</span>(*)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>vc_bw lnwage educ exper tenure female married divorced, vcoeff(age)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>vc_reg lnwage educ exper tenure female married divorced, vcoeff(age) <span class="kw">k</span>(20)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">ssc</span> install <span class="bn">addplot</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>vc_graph educ exper tenure female married divorced, rarea</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="bn">addplot</span> grph1:, <span class="bn">legend</span>(<span class="kw">off</span>) <span class="bn">title</span>(Education)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="bn">addplot</span> grph2:, <span class="bn">legend</span>(<span class="kw">off</span>) <span class="bn">title</span>(Experience)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="bn">addplot</span> grph3:, <span class="bn">legend</span>(<span class="kw">off</span>) <span class="bn">title</span>(Tenure)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="bn">addplot</span> grph4:, <span class="bn">legend</span>(<span class="kw">off</span>) <span class="bn">title</span>(Female)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="bn">addplot</span> grph5:, <span class="bn">legend</span>(<span class="kw">off</span>) <span class="bn">title</span>(Married)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="bn">addplot</span> grph6:, <span class="bn">legend</span>(<span class="kw">off</span>) <span class="bn">title</span>(Divorced)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="kw">graph</span> <span class="bn">combine</span> grph1 grph2 grph3 grph4 grph5 grph6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="example-1" class="level2">
<h2 class="anchored" data-anchor-id="example-1">Example</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/vc_plot.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Wage Profile across years</figcaption>
</figure>
</div>
</section>
</section>
<section id="the-end-next-time-quantile-regressions" class="level1">
<h1>The end: Next time Quantile regressions</h1>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>