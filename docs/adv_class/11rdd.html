<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Fernando Rios-Avila">

<title>Econometrics MSC Levy - Regression Discontinuity Design</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Econometrics MSC Levy</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Regression Discontinuity Design</li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Courses</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../adv_class/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advance Econometrics: Causal Effects</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../rmethods/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research Methods: Econometrics I</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../rmethods2/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research Methods II</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Math Refresher</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mathref/math_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Math Refresher: Basic Calculus</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mathref/math_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Math Refresher: Basic Linear Algebra</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mathref/math_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Math Refresher: Basic Statistics and Probability</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#re-cap-potential-outcome-model" id="toc-re-cap-potential-outcome-model" class="nav-link active" data-scroll-target="#re-cap-potential-outcome-model">Re-Cap: Potential outcome Model</a></li>
  <li><a href="#the-problem" id="toc-the-problem" class="nav-link" data-scroll-target="#the-problem">The Problem</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  <li><a href="#what-is-rdd" id="toc-what-is-rdd" class="nav-link" data-scroll-target="#what-is-rdd">What is RDD?</a></li>
  <li><a href="#possible-solution" id="toc-possible-solution" class="nav-link" data-scroll-target="#possible-solution">Possible Solution</a></li>
  <li><a href="#rdd-how-it-works." id="toc-rdd-how-it-works." class="nav-link" data-scroll-target="#rdd-how-it-works.">RDD: How it works.</a></li>
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1"></a></li>
  <li><a href="#sharp-rdd" id="toc-sharp-rdd" class="nav-link" data-scroll-target="#sharp-rdd">Sharp RDD</a></li>
  <li><a href="#how-it-works-p2" id="toc-how-it-works-p2" class="nav-link" data-scroll-target="#how-it-works-p2">How it works : p2</a></li>
  <li><a href="#estimation" id="toc-estimation" class="nav-link" data-scroll-target="#estimation">Estimation</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  <li><a href="#example-1" id="toc-example-1" class="nav-link" data-scroll-target="#example-1">Example</a></li>
  <li><a href="#fuzzy-rd-imperfect-compliance" id="toc-fuzzy-rd-imperfect-compliance" class="nav-link" data-scroll-target="#fuzzy-rd-imperfect-compliance">Fuzzy RD: Imperfect compliance</a></li>
  <li><a href="#fuzzy-rd" id="toc-fuzzy-rd" class="nav-link" data-scroll-target="#fuzzy-rd">Fuzzy RD</a></li>
  <li><a href="#example-2" id="toc-example-2" class="nav-link" data-scroll-target="#example-2">Example</a></li>
  <li><a href="#things-to-consider" id="toc-things-to-consider" class="nav-link" data-scroll-target="#things-to-consider">Things to consider</a></li>
  <li><a href="#testing-empirical-assumptions" id="toc-testing-empirical-assumptions" class="nav-link" data-scroll-target="#testing-empirical-assumptions">Testing Empirical Assumptions</a></li>
  <li><a href="#section-2" id="toc-section-2" class="nav-link" data-scroll-target="#section-2"></a></li>
  <li><a href="#covariate-balance-and-placebo-tests" id="toc-covariate-balance-and-placebo-tests" class="nav-link" data-scroll-target="#covariate-balance-and-placebo-tests">Covariate balance and Placebo tests</a></li>
  <li><a href="#example-3" id="toc-example-3" class="nav-link" data-scroll-target="#example-3">Example</a></li>
  <li><a href="#manipulation-test" id="toc-manipulation-test" class="nav-link" data-scroll-target="#manipulation-test">Manipulation test</a></li>
  <li><a href="#intention-to-treat" id="toc-intention-to-treat" class="nav-link" data-scroll-target="#intention-to-treat">Intention to treat</a></li>
  <li><a href="#estimation-of-the-effect" id="toc-estimation-of-the-effect" class="nav-link" data-scroll-target="#estimation-of-the-effect">Estimation of the effect:</a></li>
  <li><a href="#some-sensitivity" id="toc-some-sensitivity" class="nav-link" data-scroll-target="#some-sensitivity">Some Sensitivity</a></li>
  <li><a href="#flasification-test" id="toc-flasification-test" class="nav-link" data-scroll-target="#flasification-test">Flasification test</a></li>
  <li><a href="#next-differences-in-differences" id="toc-next-differences-in-differences" class="nav-link" data-scroll-target="#next-differences-in-differences">Next Differences in Differences</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="11rdd.html"><i class="bi bi-file-slides"></i>RevealJS</a></li><li><a href="11rdd.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Regression Discontinuity Design</h1>
<p class="subtitle lead">Up close, we are all the same</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Fernando Rios-Avila </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="re-cap-potential-outcome-model" class="level2 smaler">
<h2 class="smaler anchored" data-anchor-id="re-cap-potential-outcome-model">Re-Cap: Potential outcome Model</h2>
<p>In the ideal world, where we can see all possible outcomes and scenarios of your potential treatments, it will be very simple to estimate treatment effects:</p>
<p><span class="math display">\[
\delta_i = Y_i(1)-Y_i(0)
\]</span></p>
<p>This works because all observed and unobserved individual characteristics are kept fixed, except for the treatment Status.</p>
<p><span class="math display">\[y_i(D)=y_i(X,u,D)\]</span></p>
<p>So when comparing a person with himself (clones or parallel worlds), we know (or at least expect) that everything else is the same, and that differences between the two states are explained only by the treatment.</p>
</section>
<section id="the-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-problem">The Problem</h2>
<p>We do not observe both <strong>ALL</strong> States at the same time. People will either be treated or untreated, not both.</p>
<p>So what can we do?</p>
<blockquote class="blockquote">
<p><strong>We need to find good counterfactuals!</strong></p>
</blockquote>
<p>This means finding people are very similar to the ones treated, so they can be used as the examples of the “what if” question.</p>
<p>But there is a problem. Even in the best scenarios, we can never be asure about how to control for unobservables…or can we?</p>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>
<ul>
<li><p><strong>You can always RCT</strong> But it can be expensive</p></li>
<li><p><strong>You can IV the problem</strong> but its hard to justify</p></li>
<li><p><strong>You can add FE</strong>, but you have time varying errors</p></li>
</ul>
<p>Then what?</p>
<ul>
<li>You could RDD the problem (if you have the right data!)</li>
</ul>
</section>
<section id="what-is-rdd" class="level2">
<h2 class="anchored" data-anchor-id="what-is-rdd">What is RDD?</h2>
<p><strong>RDD</strong> or Regression Discontinuity design is methodology that is known for its clean identification and with a relatively easy visualization tool to understand the identification, and solve the problem of unobserved distributions. (see <a href="https://academic.oup.com/qje/advance-article/doi/10.1093/qje/qjad011/7068116?login=true">here</a> for a recent paper on how to make graphs on this).</p>
<p>In fact, the treatment Status has a very clear Rule!</p>
<p>Consider the following problem:</p>
<ol type="1">
<li>You want to study the role of college on earnings.</li>
<li>You have data on people who are applying to go to school. They all take some standardized tests. Their grade will determine if they get into College or not.</li>
<li>People with high skills will get a higher grades in the GRE, go to college, and probably get higher salaries.</li>
<li>But, there is a problem. How can you figure out if wages are due to College or skill?</li>
</ol>
</section>
<section id="possible-solution" class="level2">
<h2 class="anchored" data-anchor-id="possible-solution">Possible Solution</h2>
<p>Say that we actually have access to the grades, which range from 100 to 200. And assume that you say, every one with grades higher than 170 will go to college.</p>
<p>Can you estimate the effect now?</p>
<ul>
<li>You can’t compare people with more than 170 to those with less than 170. Because skill or ability will be different across groups.</li>
<li>However, what if you compare individuals with 170-172 vs 167-169?
<ul>
<li>These individuals are so close togeter they problably have very similar characteristics as well!</li>
<li>you have a Localized randomization.</li>
</ul></li>
</ul>
<p>In this case, your analysis is those individuals just above the thresholds to those just below (counterfactual)</p>
<p>Unless you think grades near the threshold are as good as random, then you have a design to identify treatment effects!</p>
</section>
<section id="rdd-how-it-works." class="level2">
<h2 class="anchored" data-anchor-id="rdd-how-it-works.">RDD: How it works.</h2>
<p><strong>Selection and Index</strong>:</p>
<ol type="1">
<li>The first thing you need to see if you can use and RDD is to see if you have access to a variable that “ranks” units.</li>
</ol>
<ul>
<li>This variable should be smooth and preferibly continuous.
<ul>
<li>age, distance from boarder, test score, poverty index</li>
</ul></li>
</ul>
<ol start="2" type="1">
<li>Assignment into treatment is a function of this index only, with a clear threshold for the index to have an impact the treatment.</li>
</ol>
<ul>
<li>Those under the Threshold are not treated. Those above are.</li>
<li>This is called a <strong>Sharp RDD</strong> design.</li>
</ul>
</section>
<section id="section-1" class="level2">
<h2 class="anchored" data-anchor-id="section-1"></h2>
<ol start="3" type="1">
<li>The threshold should be unique to the Treatment of interest (nothing else happens around that point)</li>
</ol>
<ul>
<li>In the College Case, we assume 170 triggers acceptance to School. But if it also triggers Scholarships??</li>
</ul>
<ol start="4" type="1">
<li><p>Perhaps the Most important: The score cannot be manipulated</p>
<ul>
<li>Only then we have true local randomization.</li>
</ul></li>
<li><p>You want the potential outcomes to be smooth functions of Z. (so we do not mix treatment effects with Nonsmooth changes in outcomes)</p></li>
</ol>
</section>
<section id="sharp-rdd" class="level2">
<h2 class="anchored" data-anchor-id="sharp-rdd">Sharp RDD</h2>
<div id="168e2e09" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ssc</span> install synth</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="dv">scheme</span> white2</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>color_style bay</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="dv">seed</span> 1</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">set</span> <span class="kw">obs</span> 100</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="fu">e</span>=rnormal()</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> z=runiform()+<span class="fu">e</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> t = z&gt;0</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="fu">y</span> = 1 + z + <span class="fu">e</span> + rnormal() + (z&gt;0)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">two</span> <span class="kw">line</span> t z, <span class="kw">sort</span> <span class="bn">title</span>(<span class="st">"Treatment"</span>) <span class="kw">ylabel</span>(0 <span class="st">"Not Treated"</span> 1 <span class="st">"Treated"</span>) <span class="bn">name</span>(m1, <span class="kw">replace</span>) <span class="bn">ytitle</span>(<span class="st">""</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">graph</span> <span class="kw">export</span> resources\rdd1.png,  <span class="kw">width</span>(1000) height(1000) <span class="kw">replace</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">two</span> <span class="kw">scatter</span> <span class="fu">y</span> z, <span class="kw">sort</span> <span class="bn">title</span>(<span class="st">"Outcome"</span>) pstyle(p1) || <span class="kw">lfit</span> <span class="fu">y</span> z, lw(1) pstyle(p2) <span class="co">///</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    || <span class="kw">lfit</span> <span class="fu">y</span> z <span class="kw">if</span> z&lt;0, lw(0.5) || <span class="kw">lfit</span> <span class="fu">y</span> z <span class="kw">if</span> z&gt;0, lw(0.5) , <span class="bn">legend</span>(<span class="kw">off</span>) <span class="bn">name</span>(m2, <span class="kw">replace</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="kw">graph</span> <span class="kw">export</span> resources\rdd2.png,  <span class="kw">width</span>(1000) height(1000)  <span class="kw">replace</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="resources/rdd1.png" class="img-fluid"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="resources/rdd2.png" class="img-fluid"></p>
</div>
</div>
</div>
</section>
<section id="how-it-works-p2" class="level2">
<h2 class="anchored" data-anchor-id="how-it-works-p2">How it works : p2</h2>
<p>Recall that in an RCT (or under randomization) treatment effects are estimated by comparing those treated and those not treated.</p>
<p><span class="math display">\[E(y|D=1)-E(y|D=0)\]</span></p>
<p>Under SRDD, you can also think about the same experiment, except that we would need to compare individuals AT the theshold.</p>
<p><span class="math display">\[\begin{aligned}
\lim_{z\downarrow c} E(y|Z=z) &amp;- \lim_{z\uparrow c} E(y|Z=z) \\
E(y(1)|Z=c) &amp;-E(y(0)|Z=c)
\end{aligned}
\]</span></p>
<ul>
<li>In this case, the overlapping assumption is violated. So we need to attemp obtaining effects for groups AT the limit when <span class="math inline">\(Z=c\)</span>.</li>
</ul>
</section>
<section id="estimation" class="level2">
<h2 class="anchored" data-anchor-id="estimation">Estimation</h2>
<p>The most simple way to proceed is to estimate the model using a parametric approach (OLS)</p>
<p><span class="math display">\[y = a_0 + \delta D_{z&gt;c} + f(z-c) + e\]</span></p>
<p>The idea here is to identify a “jump” in the outcome (treatment effect) at the point where <span class="math inline">\(z\)</span> crosses the threshold.</p>
<p>But to identify the jump only, we also need to model the trend observe before and after that threshold (<span class="math inline">\(f(z-c)\)</span>), which can be modelled as flexible as possible. (this include interactions with the jump)</p>
<p>Alternatively, we could use smaller bandwidths (nonparametric)</p>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<div id="f28b1a1d" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a> <span class="kw">qui</span>: {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="dv">seed</span> 1</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="kw">obs</span> 200</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="fu">e</span>=rnormal()</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> z=runiform()+<span class="fu">e</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">sum</span> z</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> z=(z-<span class="fu">r</span>(<span class="kw">mean</span>))/<span class="fu">r</span>(<span class="fu">sd</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> t = z&gt;0</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="fu">y</span> = 1 + 0.5*z + <span class="fu">e</span> + rnormal() + (z&gt;0)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span> <span class="fu">y</span> t z </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> yh1</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> b1:<span class="kw">display</span> %3.2f _b[t]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span> <span class="fu">y</span> t c.z##c.z  </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> yh2</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> b2:<span class="kw">display</span> %3.2f _b[t]</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span> <span class="fu">y</span> t c.z##c.z##c.z</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> yh3</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> b3:<span class="kw">display</span> %3.2f _b[t]</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> z</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="kw">two</span> (<span class="kw">scatter</span> <span class="fu">y</span> z, <span class="kw">sort</span> <span class="bn">title</span>(<span class="st">"Sharp RDD"</span>) pstyle(p1) <span class="kw">color</span>(%20)) <span class="co">///</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">line</span> yh1 z <span class="kw">if</span> z&lt;0, pstyle(p2) lw(0.5)) (<span class="kw">line</span> yh1 z <span class="kw">if</span> z&gt;0, pstyle(p2) lw(0.5)) <span class="co">///</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">line</span> yh2 z <span class="kw">if</span> z&lt;0, pstyle(p3) lw(0.5)) (<span class="kw">line</span> yh2 z <span class="kw">if</span> z&gt;0, pstyle(p3) lw(0.5)) <span class="co">///</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">line</span> yh3 z <span class="kw">if</span> z&lt;0, pstyle(p4) lw(0.5)) (<span class="kw">line</span> yh3 z <span class="kw">if</span> z&gt;0, pstyle(p4) lw(0.5)) , <span class="co">///</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="bn">legend</span>(<span class="kw">order</span>(2 <span class="st">"Linear ATT: `b1'"</span> 3 <span class="st">"Quadratic ATT: `b2'"</span> 4 <span class="st">"Cubic ATT: `b3'"</span>)) <span class="bn">name</span>(m1, <span class="kw">replace</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="11rdd_files/figure-revealjs/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-1" class="level2">
<h2 class="anchored" data-anchor-id="example-1">Example</h2>
<div id="5d6f2cf3" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span> <span class="fu">y</span> t c.z#t </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> yh11</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> b1:<span class="kw">display</span> %3.2f _b[t]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span> <span class="fu">y</span> t (c.z##c.z)#t  </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> yh21</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> b2:<span class="kw">display</span> %3.2f _b[t]</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span> <span class="fu">y</span> t (c.z##c.z##c.z)#t</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> yh31</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> b3:<span class="kw">display</span> %3.2f _b[t]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">two</span> (<span class="kw">scatter</span> <span class="fu">y</span> z, <span class="kw">sort</span> <span class="bn">title</span>(<span class="st">"Sharp RDD"</span>) pstyle(p1) <span class="kw">color</span>(%20)) <span class="co">///</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">line</span> yh11 z <span class="kw">if</span> z&lt;0, pstyle(p2) lw(0.5)) (<span class="kw">line</span> yh11 z <span class="kw">if</span> z&gt;0, pstyle(p2) lw(0.5)) <span class="co">///</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">line</span> yh21 z <span class="kw">if</span> z&lt;0, pstyle(p3) lw(0.5)) (<span class="kw">line</span> yh21 z <span class="kw">if</span> z&gt;0, pstyle(p3) lw(0.5)) <span class="co">///</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">line</span> yh31 z <span class="kw">if</span> z&lt;0, pstyle(p4) lw(0.5)) (<span class="kw">line</span> yh31 z <span class="kw">if</span> z&gt;0, pstyle(p4) lw(0.5)) , <span class="co">///</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="bn">legend</span>(<span class="kw">order</span>(2 <span class="st">"Linear ATT: `b1'"</span> 3 <span class="st">"Quadratic ATT: `b2'"</span> 4 <span class="st">"Cubic ATT: `b3'"</span>)) <span class="bn">name</span>(m2, <span class="kw">replace</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="11rdd_files/figure-revealjs/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fuzzy-rd-imperfect-compliance" class="level2">
<h2 class="anchored" data-anchor-id="fuzzy-rd-imperfect-compliance">Fuzzy RD: Imperfect compliance</h2>
<p>While the Idea Scenario happens when there is perfect compliance (above the threshold you are treated), this doesnt happen all the time.</p>
<p>In the education example:</p>
<ul>
<li>Some people with low grades may be “legacy” or have “contacts” (or took a second exam later) and manage to go to college</li>
<li>Some decided not to go, even after entering to college</li>
</ul>
<p>Sounds Familiar? (Never takers vs always takers)</p>
<p>When this happens, you can still do RDD, but you need more steps</p>
</section>
<section id="fuzzy-rd" class="level2">
<h2 class="anchored" data-anchor-id="fuzzy-rd">Fuzzy RD</h2>
<ol type="1">
<li>Estimate the impact of Discontinuity on Treatment</li>
<li>Estimate the impact of Discontinuity on Outcome</li>
<li>Estimate the ratio between (1) and (2)</li>
</ol>
<p>Sounds Familiar?</p>
<ul>
<li>Its a kind of wald/IV estimator.
<ul>
<li>The instrument is the discontinuity</li>
<li>The the endogenous variable is the treament</li>
</ul></li>
</ul>
<p>You still need to estimate the effect as close to the Discontinuity as possible</p>
<p><code>ivregress</code> may still do most of this for you</p>
</section>
<section id="example-2" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="example-2">Example</h2>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/frdd1.png" class="img-fluid figure-img"></p>
<figcaption>Treatment</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/frdd2.png" class="img-fluid figure-img"></p>
<figcaption>Outcome</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>Effect:</p>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: <span class="kw">gen</span> dz = z&gt;0</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: <span class="kw">reg</span> <span class="fu">y</span> dz c.z##c.z#i.dz</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> b1 = _b[dz]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: <span class="kw">reg</span> t dz c.z##c.z#i.dz</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> b2 = _b[dz]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">display</span> <span class="st">"There is a "</span> %3.2f <span class="ot">`b1'</span> <span class="st">" effect on the outcome"</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">display</span> <span class="st">"and a "</span> %3.2f <span class="ot">`b2'</span> <span class="st">" effect on the treatment"</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="kw">display</span> <span class="st">"which imply a LATE of "</span> %3.2f <span class="ot">`=`b1'</span>/<span class="ot">`b2'</span>'</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There is a 0.45 effect on the outcome and a 0.44 effect on the treatment which imply a LATE of 1.03</p>
</section>
<section id="things-to-consider" class="level2">
<h2 class="anchored" data-anchor-id="things-to-consider">Things to consider</h2>
<p><strong>Theoretical</strong>:</p>
<ol type="1">
<li>You need to identify “jumps” caused by a running variable. (depends on knowing how things works)</li>
<li>The potential outcomes have to be smooth functions of the running variable</li>
</ol>
<p><strong>Empirical</strong>:</p>
<ol start="3" type="1">
<li>The running variable shouldnt be manipulated. (random)
<ul>
<li>Implies Assignment rules are not known, are exogenous, and there is no random heaping</li>
</ul></li>
<li>Controls should be balanced around the threshold</li>
</ol>
</section>
<section id="testing-empirical-assumptions" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="testing-empirical-assumptions">Testing Empirical Assumptions</h2>
<p>Manipulation of running variable may cause a non-smooth density in the running variable:</p>
<ul>
<li>If there is no manipulation, you may expect density round threshold to be smooth.
<ul>
<li>In Stata: ssc install <code>rddensity</code>. In r install.packages(c(‘rdd’,‘rddensity’))</li>
</ul></li>
</ul>
<div id="8b23d0c2" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="dv">linesize</span> 100</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">ssc</span> install  lpdensity, <span class="kw">replace</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">ssc</span> install  rddensity, <span class="kw">replace</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>rddensity z, c(0) plot</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">graph</span> <span class="kw">export</span> resources\frdd3.png, <span class="kw">width</span>(1000) <span class="kw">replace</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><img src="resources/frdd3.png" class="img-fluid"></p>
</section>
<section id="section-2" class="level2">
<h2 class="anchored" data-anchor-id="section-2"></h2>
<ul>
<li><p>In cases of nonrandom heaping, it may be possible to avoid the problem by restricting the data.</p></li>
<li><p>This is an example of measurement error, when individuals may “round-up/down” answers. And may occure near threshold.</p></li>
<li><p>This does not necessarily mean there is manipulation.</p></li>
<li><p>Possible Solution? Estimate RDD excluding observations around (excluding) threshold.</p></li>
</ul>
</section>
<section id="covariate-balance-and-placebo-tests" class="level2">
<h2 class="anchored" data-anchor-id="covariate-balance-and-placebo-tests">Covariate balance and Placebo tests</h2>
<ul>
<li><p>If treatment is <strong>locally</strong> randomized, then covariates should not be affected by discontinuity.</p></li>
<li><p>Alternatively, one could estimate effects on variables you know CANNOT be affected by the treatment</p></li>
<li><p>One could also implement a placebo test, checking the impact on a different threholds.</p>
<ul>
<li>No effect should be observed on the outcome, (but some on the treatment)</li>
</ul></li>
</ul>
</section>
<section id="example-3" class="level2">
<h2 class="anchored" data-anchor-id="example-3">Example</h2>
<p>Impact of Scores on Scholarship recipiency</p>
<div id="7af4b8d3" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> resources\fuzzy, <span class="kw">clear</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>color_style bay</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ssc</span> install rdrobust</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ssc</span> install rddensity</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:rdplot <span class="kw">d</span> x1, graph_options(<span class="bn">legend</span>( pos(6)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>checking rdrobust consistency and verifying not already installed...
all files already exist and are up to date.
checking rddensity consistency and verifying not already installed...
all files already exist and are up to date.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="11rdd_files/figure-revealjs/cell-8-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="manipulation-test" class="level2">
<h2 class="anchored" data-anchor-id="manipulation-test">Manipulation test</h2>
<div id="096a5d24" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:rddensity x1, plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="11rdd_files/figure-revealjs/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="intention-to-treat" class="level2">
<h2 class="anchored" data-anchor-id="intention-to-treat">Intention to treat</h2>
<p>Impact on Enrollment</p>
<div id="8efd57d5" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:rdplot <span class="fu">y</span> x1, graph_options(<span class="bn">legend</span>( pos(6)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="11rdd_files/figure-revealjs/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="estimation-of-the-effect" class="level2">
<h2 class="anchored" data-anchor-id="estimation-of-the-effect">Estimation of the effect:</h2>
<div id="efded81c" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> dx1 = x1&gt;0</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ivregress 2sls <span class="fu">y</span> (<span class="kw">d</span> = dx1) c.x1##c.x1#dx1 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Instrumental variables 2SLS regression            Number of obs   =     23,132
                                                  Wald chi2(5)    =    1645.56
                                                  Prob &gt; chi2     =     0.0000
                                                  R-squared       =     0.2845
                                                  Root MSE        =     .39876

-------------------------------------------------------------------------------
            y | Coefficient  Std. err.      z    P&gt;|z|     [95% conf. interval]
--------------+----------------------------------------------------------------
            d |   .4432824   .0215111    20.61   0.000     .4011214    .4854434
              |
     dx1#c.x1 |
           0  |   .0002949   .0019179     0.15   0.878    -.0034642    .0040539
           1  |  -.0034238    .000779    -4.39   0.000    -.0049507   -.0018969
              |
dx1#c.x1#c.x1 |
           0  |   .0000741   .0000703     1.05   0.292    -.0000637    .0002119
           1  |   .0000616   .0000164     3.76   0.000     .0000295    .0000936
              |
        _cons |   .5103635    .010876    46.93   0.000     .4890469    .5316801
-------------------------------------------------------------------------------
Endogenous: d
Exogenous:  0b.dx1#c.x1 1.dx1#c.x1 0b.dx1#c.x1#c.x1 1.dx1#c.x1#c.x1 dx1</code></pre>
</div>
</div>
</section>
<section id="some-sensitivity" class="level2">
<h2 class="anchored" data-anchor-id="some-sensitivity">Some Sensitivity</h2>
<div id="fb912f5b" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:{   </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">matrix</span> b1 = 0,0</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">forvalues</span> i = 1/15 {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    ivregress 2sls <span class="fu">y</span> (<span class="kw">d</span> = dx1) c.x1#dx1  <span class="kw">if</span> <span class="fu">abs</span>(x1)&lt;<span class="ot">`i'</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span> b1=b1\[_b[<span class="kw">d</span>],_se[<span class="kw">d</span>]]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">matrix</span> b2 = 0,0</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="kw">forvalues</span> i = 1/15 {</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    ivregress 2sls <span class="fu">y</span> (<span class="kw">d</span> = dx1) c.x1##c.x1#dx1  <span class="kw">if</span> <span class="fu">abs</span>(x1)&lt;<span class="ot">`i'</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span> b2=b2\[_b[<span class="kw">d</span>],_se[<span class="kw">d</span>]]</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="fu">matrix</span> b3 = 0,0</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="kw">forvalues</span> i = 1/15 {</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    ivregress 2sls <span class="fu">y</span> (<span class="kw">d</span> = dx1) c.x1##c.x1##c.x1#dx1  <span class="kw">if</span> <span class="fu">abs</span>(x1)&lt;<span class="ot">`i'</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">matrix</span> b3=b3\[_b[<span class="kw">d</span>],_se[<span class="kw">d</span>]]</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>lbsvmat b1</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>lbsvmat b2</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>lbsvmat b3</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="kw">forvalues</span> i = 1/3 {</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">gen</span> ll<span class="ot">`i'</span>=b<span class="ot">`i'</span>1-b<span class="ot">`i'</span>2*1.96</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">gen</span> ul<span class="ot">`i'</span>=b<span class="ot">`i'</span>1+b<span class="ot">`i'</span>2*1.96</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> z = <span class="dt">_n</span>-1 <span class="kw">if</span> b11!=.</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> z=. <span class="kw">in</span> 1</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> z1 = z + 0.25</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> z2 = z + 0.5</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="kw">two</span> (rspike ll1 ul1 z, lw(1) pstyle(p1) <span class="kw">color</span>(%50) ) (<span class="kw">scatter</span> b11 z, pstyle(p1) ) <span class="co">///</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    (rspike ll2 ul2 z1, lw(1) pstyle(p2) <span class="kw">color</span>(%50) ) (<span class="kw">scatter</span> b21 z1, pstyle(p2) ) <span class="co">///</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    (rspike ll3 ul3 z2, lw(1) pstyle(p3) <span class="kw">color</span>(%50) ) (<span class="kw">scatter</span> b31 z2, pstyle(p3) ), <span class="co">///</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="bn">legend</span>(<span class="kw">order</span>(1 <span class="st">"Linear"</span> 3 <span class="st">"Quadratic"</span> 5 <span class="st">"Cubic"</span>)) <span class="bn">xtitle</span>(<span class="st">"Bandwidth"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(23,117 missing values generated)
(23,117 missing values generated)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="11rdd_files/figure-revealjs/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="flasification-test" class="level2">
<h2 class="anchored" data-anchor-id="flasification-test">Flasification test</h2>
<div id="e04d5d5d" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span> {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ivregress 2sls icfes_female (<span class="kw">d</span> = dx1) c.x1#dx1    <span class="kw">if</span> <span class="fu">abs</span>(x1)&lt;20</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m1</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>ivregress 2sls icfes_age (<span class="kw">d</span> = dx1) c.x1#dx1       <span class="kw">if</span> <span class="fu">abs</span>(x1)&lt;20</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m2</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>ivregress 2sls icfes_urm (<span class="kw">d</span> = dx1) c.x1#dx1       <span class="kw">if</span> <span class="fu">abs</span>(x1)&lt;20</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m3</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>ivregress 2sls icfes_famsize (<span class="kw">d</span> = dx1) c.x1#dx1       <span class="kw">if</span> <span class="fu">abs</span>(x1)&lt;20</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m4</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>esttab m1 m2 m3 m4, <span class="kw">keep</span>(<span class="kw">d</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
----------------------------------------------------------------------------
                      (1)             (2)             (3)             (4)   
             icfes_female       icfes_age       icfes_urm    icfes_fams~e   
----------------------------------------------------------------------------
d                  0.0199           0.128         0.00791          0.0439   
                   (0.80)          (1.05)          (0.65)          (0.63)   
----------------------------------------------------------------------------
N                   14841           14799           14841           14801   
----------------------------------------------------------------------------
t statistics in parentheses
* p&lt;0.05, ** p&lt;0.01, *** p&lt;0.001</code></pre>
</div>
</div>
</section>
<section id="next-differences-in-differences" class="level1">
<h1>Next Differences in Differences</h1>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>