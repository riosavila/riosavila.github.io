<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Fernando Rios-Avila">

<title>Econometrics MSC Levy - Instrumental Variables and 2SLS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Econometrics MSC Levy</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../adv_class.html" rel="" target="">
 <span class="menu-text">Adv Methods and Causal Effects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../rm_class.html" rel="" target="">
 <span class="menu-text">Research Methods: Econometrics I</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../resources.html" rel="" target="">
 <span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-problem" id="toc-the-problem" class="nav-link active" data-scroll-target="#the-problem">The problem</a>
  <ul class="collapse">
  <li><a href="#the-problem-endogeneity" id="toc-the-problem-endogeneity" class="nav-link" data-scroll-target="#the-problem-endogeneity">The problem: Endogeneity</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  <li><a href="#a-pair-of-solutions" id="toc-a-pair-of-solutions" class="nav-link" data-scroll-target="#a-pair-of-solutions">A pair of Solutions</a></li>
  <li><a href="#what-is-an-instrumental-variable" id="toc-what-is-an-instrumental-variable" class="nav-link" data-scroll-target="#what-is-an-instrumental-variable">What is an “<strong><em>Instrumental Variable</em></strong>”</a></li>
  <li><a href="#how-instruments-work-the-math" id="toc-how-instruments-work-the-math" class="nav-link" data-scroll-target="#how-instruments-work-the-math">How Instruments work: The math</a></li>
  <li><a href="#how-instruments-work-the-intuition" id="toc-how-instruments-work-the-intuition" class="nav-link" data-scroll-target="#how-instruments-work-the-intuition">How Instruments work: The intuition</a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a></li>
  <li><a href="#se-and-statistical-inference" id="toc-se-and-statistical-inference" class="nav-link" data-scroll-target="#se-and-statistical-inference">SE and Statistical Inference</a></li>
  <li><a href="#examples-of-ivs" id="toc-examples-of-ivs" class="nav-link" data-scroll-target="#examples-of-ivs">Examples of IV’s</a></li>
  </ul></li>
  <li><a href="#weak-and-enogenous-and-mlr" id="toc-weak-and-enogenous-and-mlr" class="nav-link" data-scroll-target="#weak-and-enogenous-and-mlr">Weak and Enogenous, and MLR</a>
  <ul class="collapse">
  <li><a href="#weak-and-endogenous-instruments" id="toc-weak-and-endogenous-instruments" class="nav-link" data-scroll-target="#weak-and-endogenous-instruments">Weak and endogenous instruments:</a></li>
  <li><a href="#iv-with-mlr" id="toc-iv-with-mlr" class="nav-link" data-scroll-target="#iv-with-mlr">IV with MLR</a></li>
  <li><a href="#iv-and-treatment-effects" id="toc-iv-and-treatment-effects" class="nav-link" data-scroll-target="#iv-and-treatment-effects">IV and Treatment Effects</a></li>
  <li><a href="#sls-many-ys-many-zs" id="toc-sls-many-ys-many-zs" class="nav-link" data-scroll-target="#sls-many-ys-many-zs">2SLS: Many Ys many Zs</a></li>
  <li><a href="#sls-estimation" id="toc-sls-estimation" class="nav-link" data-scroll-target="#sls-estimation">2SLS: Estimation</a></li>
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1"></a></li>
  <li><a href="#matrix-math" id="toc-matrix-math" class="nav-link" data-scroll-target="#matrix-math">Matrix Math</a></li>
  <li><a href="#multicolinearity-and-2sls" id="toc-multicolinearity-and-2sls" class="nav-link" data-scroll-target="#multicolinearity-and-2sls">Multicolinearity and 2sls</a></li>
  <li><a href="#weak-instruments" id="toc-weak-instruments" class="nav-link" data-scroll-target="#weak-instruments">Weak Instruments</a></li>
  <li><a href="#section-2" id="toc-section-2" class="nav-link" data-scroll-target="#section-2"></a></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples">Examples</a></li>
  <li><a href="#iv-for-measurement-errors-two-wrongs-make-one-right" id="toc-iv-for-measurement-errors-two-wrongs-make-one-right" class="nav-link" data-scroll-target="#iv-for-measurement-errors-two-wrongs-make-one-right">IV for Measurement errors: Two wrongs make one right</a></li>
  <li><a href="#section-3" id="toc-section-3" class="nav-link" data-scroll-target="#section-3"></a></li>
  <li><a href="#example-1" id="toc-example-1" class="nav-link" data-scroll-target="#example-1">Example</a></li>
  </ul></li>
  <li><a href="#endogenous-ivs-and-too-many-ivs" id="toc-endogenous-ivs-and-too-many-ivs" class="nav-link" data-scroll-target="#endogenous-ivs-and-too-many-ivs">Endogenous IVs and Too many IVs</a>
  <ul class="collapse">
  <li><a href="#testing-for-endogeneity-and-overidentifying-restrictions" id="toc-testing-for-endogeneity-and-overidentifying-restrictions" class="nav-link" data-scroll-target="#testing-for-endogeneity-and-overidentifying-restrictions">Testing for Endogeneity and Overidentifying restrictions</a></li>
  <li><a href="#section-4" id="toc-section-4" class="nav-link" data-scroll-target="#section-4"></a></li>
  <li><a href="#overidentifying-restrictions" id="toc-overidentifying-restrictions" class="nav-link" data-scroll-target="#overidentifying-restrictions">overidentifying restrictions</a></li>
  <li><a href="#section-5" id="toc-section-5" class="nav-link" data-scroll-target="#section-5"></a></li>
  <li><a href="#ivs-as-lates" id="toc-ivs-as-lates" class="nav-link" data-scroll-target="#ivs-as-lates">IV’s as LATES</a></li>
  <li><a href="#example-2" id="toc-example-2" class="nav-link" data-scroll-target="#example-2">Example</a></li>
  </ul></li>
  <li><a href="#thats-all-for-today" id="toc-thats-all-for-today" class="nav-link" data-scroll-target="#thats-all-for-today">Thats all for today!</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="8_iv2sls.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Instrumental Variables and 2SLS</h1>
<p class="subtitle lead">Time to save A4 (hopefully)</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Fernando Rios-Avila </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>

<section id="the-problem" class="level1">
<h1>The problem</h1>
<section id="the-problem-endogeneity" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-endogeneity">The problem: Endogeneity</h2>
<ul>
<li>As I mentioned at the beginning, one of the most important assumptions required to analyze data and obtain correct estimations and draw inference was A4: <strong>No endogeneity</strong> or <span class="math inline">\(E(e|X)=0\)</span>
<ul>
<li>Endogeneity is a problem that occurs because the error is related to <span class="math inline">\(X\)</span>.</li>
<li>This is a proble,, because we can no longer assume the error is, in average, constant when analyzing changes in <span class="math inline">\(X's\)</span></li>
</ul></li>
</ul>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>
<ul>
<li>Why did it happen?
<ul>
<li>Usually because important variables are omitted
<ul>
<li>Add them back, or at least proxies?</li>
</ul></li>
<li>Incorrect functional form
<ul>
<li>Try making it more flexible?</li>
</ul></li>
<li>Data has measurement error
<ul>
<li>Get better data?</li>
</ul></li>
<li>Sample is endogenous (other treatments are necessary)</li>
<li>Reverse causality (you dont know which cause which)</li>
<li>Simultenaity, similar to omitted variables. There is another factor that caused both the outcome and explanatory variable</li>
</ul></li>
</ul>
</section>
<section id="a-pair-of-solutions" class="level2">
<h2 class="anchored" data-anchor-id="a-pair-of-solutions">A pair of Solutions</h2>
<ul>
<li>Today we will cover one approach that could help with many (not all) the situations that could cause endogeneity.</li>
<li>To apply this approach, however, we need:
<ul>
<li>More data (more variables with specific properties)</li>
<li>More information on how the “system” works.</li>
</ul></li>
<li>These methods are:
<ul>
<li>IV - Instrumental variable</li>
<li>2sls - Two-stage Least squares</li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>NOTE: These two methods are almost interchangable.</p>
<ul>
<li><p>IV refers to cases with 1 endogenous variable and 1 “instrument”</p></li>
<li><p>2sls refers to cases with 1+ endogenous variables and “instruments”</p></li>
</ul>
</blockquote>
</section>
<section id="what-is-an-instrumental-variable" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-instrumental-variable">What is an “<strong><em>Instrumental Variable</em></strong>”</h2>
<ul>
<li><p>I have mentioned a few times the word “instrument” But what are they really?</p></li>
<li><p>Instruments: the heros/variables that will “save us” of endogeneity.</p></li>
<li><p>They have at least 2 properties:</p>
<ol type="1">
<li>Instruments should be exogenous to the model</li>
</ol>
<ul>
<li>This means that they do not appear in the theoretical specification, thus there is no <strong>DIRECT</strong> conection between the instrument <span class="math inline">\(Z\)</span> and the outcome <span class="math inline">\(y\)</span>.
<ul>
<li>Should only be connected through the endogenous variable.</li>
</ul></li>
<li>Also that there is no correlation between the model error and <span class="math inline">\(Z\)</span>.</li>
</ul>
<ol start="2" type="1">
<li>The instrument is relevant and related to <span class="math inline">\(x\)</span> (endogenous variable)</li>
</ol>
<ul>
<li>Preferably, you need a variable that is not only correlated with <span class="math inline">\(X\)</span> but determines changes in <span class="math inline">\(X\)</span>.</li>
<li>We also need this effect to be monotonic!</li>
</ul></li>
<li><p>In many instances we even want an instrument that is just as good as [conditionally] random.</p></li>
</ul>
</section>
<section id="how-instruments-work-the-math" class="level2">
<h2 class="anchored" data-anchor-id="how-instruments-work-the-math">How Instruments work: The math</h2>
<p>The problem <span class="math inline">\(corr(x_1,e) \neq 0\)</span>: <span class="math display">\[\begin{aligned}
y &amp;= \beta_0 + \beta_1 x_1 + e || \tilde w = w-\bar w  \\
\tilde \beta_1 &amp;=\frac{\sum \tilde x_1 \tilde y}{\sum \tilde x_1^2}=
\frac{\sum \tilde x_1 (\beta_1 \tilde x_1 + e)}{\sum \tilde x_1^2} \\
&amp; = \beta_1 + \frac{\sum \tilde x_1 e}{\sum \tilde x_1^2}
\end{aligned}
\]</span></p>
<p>How IV works <span class="math inline">\(corr(z_1,e) \neq 0\)</span>:</p>
<p><span class="math display">\[\begin{aligned}
\hat \beta_1 &amp;=\frac{\sum \tilde z_1 \tilde y}{\sum \tilde z_1 \tilde x_1}=
\frac{\sum \tilde z_1 (\beta_1 \tilde x_1 + e)}{\sum \tilde z_1 \tilde x_1} \\
&amp; = \beta_1 + \frac{\sum \tilde z_1 e}{\sum \tilde z_1 \tilde x_1}
\end{aligned}
\]</span></p>
</section>
<section id="how-instruments-work-the-intuition" class="level2">
<h2 class="anchored" data-anchor-id="how-instruments-work-the-intuition">How Instruments work: The intuition</h2>
<ul>
<li>One way of thinking about how IV works is by realizing not ALL changes in <span class="math inline">\(X_1\)</span> are endogenous. Some <strong>are</strong> due to <span class="math inline">\(e\)</span>, but some are due other factors.
<ul>
<li>we just can’t differentiate them</li>
<li>If we could use (in the regression), only exogenous changes, (or omit endogenous ones), we could estimate our models correctly.</li>
</ul></li>
<li>What IV’s do is to identify <strong>Part</strong> of the exogenous component (the one related to <span class="math inline">\(Z\)</span>), and use only THAT variation to identify coefficients.
<ul>
<li>This would do a reasonable work, as long as the instrument is relevant, and instrument exogenous.</li>
</ul></li>
</ul>
</section>
<section id="example" class="level2">
<h2 class="anchored" data-anchor-id="example">Example</h2>
<p><span class="math display">\[\begin{aligned}
e &amp;\sim chi(2)-2 ; z = chi(2)-2 ; x = chi(2)-2+z+e \\
y &amp;=1+x+e
\end{aligned}
\]</span></p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>** Montecarlo Simulation</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="dv">seed</span> 10101</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="kw">obs</span> 1000</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">mata</span>:</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">k</span> = 1000; n=1000</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>b1=bc = b = <span class="fu">J</span>(<span class="kw">k</span>,2,0)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span>(i=1;i&lt;=<span class="kw">k</span>;i++){</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">e</span> = rchi2(n,1,2):-2</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    e1 = rchi2(n,1,2):-2</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    z = rchi2(n,1,2):-2,<span class="fu">J</span>(n,1,1)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    x = rchi2(n,1,2):-2:+z[,1]:+<span class="fu">e</span> ,<span class="fu">J</span>(n,1,1)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    x1 = rchi2(n,1,2):-2:+z[,1]:+e1,<span class="fu">J</span>(n,1,1)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">y</span> = 1:+x[,1]:+<span class="fu">e</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    y1 = 1:+x[,1]:+e1</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    xx = <span class="kw">cross</span>(x,x)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    b[i,] = (<span class="fu">invsym</span>(xx)*<span class="kw">cross</span>(x,<span class="fu">y</span>))'</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    bc[i,] = (<span class="fu">invsym</span>(<span class="kw">cross</span>(z,x))*<span class="kw">cross</span>(z,<span class="fu">y</span>))'</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    b1[i,] = (<span class="fu">invsym</span>(xx)*<span class="kw">cross</span>(x,y1))'</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>getmata bb*=b</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>getmata bc*=bc</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>getmata b_*=b1</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="dv">scheme</span> white2</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>color_style tableau</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="kw">two</span> <span class="kw">kdensity</span> bb1 ||  <span class="kw">kdensity</span> bc1  || <span class="kw">kdensity</span> b_1, <span class="co">///</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="bn">legend</span>(<span class="kw">order</span>(1 <span class="st">"X Endogenous"</span> 2 <span class="st">"IV"</span> 3 <span class="st">"X Exogenous"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>div.jp-Notebook .datagrid-container {min-height: 448px; }</style>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="8_iv2sls_files/figure-revealjs/cell-2-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="se-and-statistical-inference" class="level2">
<h2 class="anchored" data-anchor-id="se-and-statistical-inference">SE and Statistical Inference</h2>
<ul>
<li>SE have a different structure compared to OLS.</li>
<li>In the simplest case (one dep variable that is endogenous), and under the assumption of Homoskedasticity, SE for <span class="math inline">\(\beta_1\)</span> are given by:</li>
</ul>
<p><span class="math display">\[\begin{aligned}Var_{iv}(\beta_1) = \frac{\hat\sigma^2_e}{SST_x R^2_{x|z}} \\
\hat\sigma^2_e =\frac{ \sum (y-\hat\beta_0-\hat\beta_1 x)^2}{n-2}
\end{aligned}
\]</span></p>
<ul>
<li>Once they are obtained t-stats can be used as usual</li>
</ul>
</section>
<section id="examples-of-ivs" class="level2">
<h2 class="anchored" data-anchor-id="examples-of-ivs">Examples of IV’s</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p>Education:</p>
<ul>
<li>Fathers Education</li>
<li>Distance to School</li>
<li># Siblins</li>
</ul>
</div><div class="column" style="width:50%;">
<p>Veteran Status:</p>
<ul>
<li>Vietnam Lottery Ticket</li>
</ul>
<p>Other:</p>
<ul>
<li>Rain</li>
<li>Shift-Share</li>
<li>Judge FE</li>
</ul>
</div>
</div>
<ul>
<li>IV SE will be necessarily larger than OLS, because there is less variation of <span class="math inline">\(x\)</span> used to identify <span class="math inline">\(\beta\)</span>.</li>
<li>If <span class="math inline">\(x\)</span> is used as its own instrument, the estimator will be that of OLS.</li>
</ul>
</section>
</section>
<section id="weak-and-enogenous-and-mlr" class="level1">
<h1>Weak and Enogenous, and MLR</h1>
<section id="weak-and-endogenous-instruments" class="level2">
<h2 class="anchored" data-anchor-id="weak-and-endogenous-instruments">Weak and endogenous instruments:</h2>
<ul>
<li>While instruments can be used to address Endogeneity problems, finding good instruments can be hard.
<ul>
<li>They can be “weak-instruments”</li>
<li>or not fully exogenous</li>
</ul></li>
<li>If this happens, IV can be worse than endogeneity:</li>
</ul>
<p><span class="math display">\[\begin{aligned}
plim \beta_{ols} &amp;= \beta_1 + corr(x,u) \frac{\sigma_u}{\sigma_x} \\
plim \beta_{iv}  &amp;= \beta_1 + \frac{corr(z,u)}{corr(z,x)} \frac{\sigma_u}{\sigma_x}
\end{aligned}
\]</span></p>
<ul>
<li>we will talk about the “weak-instruments” later today.</li>
</ul>
</section>
<section id="iv-with-mlr" class="level2">
<h2 class="anchored" data-anchor-id="iv-with-mlr">IV with MLR</h2>
<p>Adding controls…is easy!</p>
<p><span class="math display">\[y = \beta_0 + \gamma_1 y_1 + X\beta + e ; z \text{ instrument for } y
\]</span></p>
<p>We still assume 1 endogenous variable (<span class="math inline">\(y_1\)</span>) and one instrument (<span class="math inline">\(z\)</span>)</p>
<p><span class="math display">\[X =\begin{bmatrix} 1 &amp; y_1 &amp; x_1 &amp; x_2 &amp; x_3 \end{bmatrix} ;
Z =\begin{bmatrix} 1 &amp; z &amp; x_1 &amp; x_2 &amp; x_3 \end{bmatrix}
\]</span></p>
<p>then <span class="math inline">\(\hat\beta_{iv}\)</span> is given by</p>
<p><span class="math display">\[\hat\beta_{iv} = (Z'X)^{-1}{Z'y}
\]</span></p>
<ul>
<li>Same assumptions needed, except that instrument strength is measured by the <span class="math inline">\(corr(y_1-E[y_1|X], z-E[z|X] )\)</span>
<ul>
<li>Multicollinearity problem can be a problem here</li>
</ul></li>
</ul>
</section>
<section id="iv-and-treatment-effects" class="level2">
<h2 class="anchored" data-anchor-id="iv-and-treatment-effects">IV and Treatment Effects</h2>
<p>One small note:</p>
<ul>
<li>When analyzing the model of interest, we could also try to analyze the reduced form model:</li>
</ul>
<p><span class="math display">\[y = \beta_0 + \lambda z + X \beta + e\]</span></p>
<ul>
<li><p>This model will not give you the effect of <span class="math inline">\(y_1\)</span> (endogenous variable), but can be just as interesting, specially when instrument and endogenous variables are dummies.</p>
<ul>
<li>In such case <span class="math inline">\(\lambda\)</span> will represent the “intention-to-treat” effect, rather than “treatment” effect.</li>
</ul></li>
</ul>
</section>
<section id="sls-many-ys-many-zs" class="level2">
<h2 class="anchored" data-anchor-id="sls-many-ys-many-zs">2SLS: Many Ys many Zs</h2>
<ul>
<li>There could be situations where you have not one, but many instruments.
<ul>
<li>This may be rare, as even finding a single instrument can be hard</li>
</ul></li>
<li>You may also have the situation where there is more than one endogenous variable!
<ul>
<li>In such case, you need at least as many IVs as endogenous variables</li>
</ul></li>
</ul>
<ol type="1">
<li><p>The same assumptions as before apply. IV’s need to be exogenous, but relevant to explain the endogenous variables.</p></li>
<li><p>Contrary to intuition, ALL instruments are used to analyze ALL exogenous variables</p></li>
</ol>
</section>
<section id="sls-estimation" class="level2">
<h2 class="anchored" data-anchor-id="sls-estimation">2SLS: Estimation</h2>
<p>Consider the following:</p>
<ul>
<li><span class="math inline">\(y\)</span> is the variable of interest</li>
<li><span class="math inline">\(x1, x2\)</span> set of exogenous variables</li>
<li><span class="math inline">\(y1, y2\)</span> set of endogenous variables</li>
<li><span class="math inline">\(z1,z2,z3\)</span> set of instruments for <span class="math inline">\(y1\)</span> and <span class="math inline">\(y2\)</span></li>
</ul>
<p><span class="math inline">\(X's\)</span> and <span class="math inline">\(Z's\)</span> are exogenous:</p>
</section>
<section id="section-1" class="level2">
<h2 class="anchored" data-anchor-id="section-1"></h2>
<p>Model of interesed: <span class="math display">\[y = a_0 + a_1 y_1 + a_2 y_2 + b_1 x_1 + b_2 x_2 +  b_3 x_3 + e
\]</span></p>
<p>First Stage</p>
<p><span class="math display">\[\begin{aligned}
y_1 = \gamma^1_0 + \gamma^1_1 z_1+ \gamma^1_2 z_2+ \gamma^1_3 z_3+\lambda^1_1 x_1 + \lambda^1_2 x_2 +  \lambda^1_3 x_3  + v_1 \rightarrow \hat y_1 \\
y_2 = \gamma^2_0 + \gamma^2_1 z_1+ \gamma^2_2 z_2+ \gamma^2_3 z_3+\lambda^2_1 x_1 + \lambda^2_2 x_2 +  \lambda^2_3 x_3  + v_2 \rightarrow \hat y_1
\end{aligned}
\]</span></p>
<p>Second Stage:</p>
<p><span class="math display">\[y = a_0 + a_1 \hat y_1 + a_2 \hat y_2 + b_1 x_1 + b_2 x_2 +  b_3 x_3 + e
\]</span></p>
<p>This last model should work, because <span class="math inline">\(\hat y_1\)</span> and <span class="math inline">\(\hat y_2\)</span> are exogenous (if <span class="math inline">\(Zs\)</span> are).</p>
<p>Standard Errors, however, need to be adjusted appropietly. (all two-step estimators need this)</p>
</section>
<section id="matrix-math" class="level2">
<h2 class="anchored" data-anchor-id="matrix-math">Matrix Math</h2>
<p><span class="math display">\[\begin{aligned}
X &amp;= \begin{bmatrix} 1 &amp; y_k &amp; x  \end{bmatrix} \\
Z &amp;=\begin{bmatrix} 1 &amp; z   &amp; x \end{bmatrix}
\end{aligned}
\]</span></p>
<p>Then</p>
<p><span class="math display">\[\begin{aligned}
\beta_{2sls} &amp;= [X'Z(Z'Z)^{-1}Z'X]^{-1}[X'Z(Z'Z)^{-1}Z'y] \\
\beta_{2sls} &amp;= [X'P_z X]^{-1}[X'P_z y] \\
\beta_{2sls} &amp;= [\hat X'X]^{-1}[\hat X'y]
\end{aligned}
\]</span></p>
</section>
<section id="multicolinearity-and-2sls" class="level2">
<h2 class="anchored" data-anchor-id="multicolinearity-and-2sls">Multicolinearity and 2sls</h2>
<ul>
<li>When Appplying 2sls, the problem of Multicolinearity could be stronger.
<ul>
<li>Because of <em>MCL</em>, Standard errors will increase (less individual variation.)</li>
<li>Because of IV, only a fraction of the variation is used for the analysis.</li>
<li>Botton line: Combined have conisderate results.</li>
</ul></li>
</ul>
</section>
<section id="weak-instruments" class="level2">
<h2 class="anchored" data-anchor-id="weak-instruments">Weak Instruments</h2>
<ul>
<li>Weak Instruments create problems when using IV’s and 2SLS.
<ul>
<li>A weak instrument is one that doesnt have much explanatory power on dep variable, once all other controls are taken into account.</li>
<li>If the instrument is too weak, the bias it generates could larger than OLS.</li>
<li>The distribution of coefficent is no longer normal, so its harder to make inference.</li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>How do we test for it?</p>
</blockquote>
</section>
<section id="section-2" class="level2">
<h2 class="anchored" data-anchor-id="section-2"></h2>
<p>We usually test for weak instruments when analyzing the “first-stage” regression.</p>
<p><span class="math display">\[y_2 = \gamma_0 + \gamma_1 z_1 + \gamma_2 z_2 + \gamma_3 x_1 + \gamma_4 x_2 + e
\]</span></p>
<ul>
<li><p>The null is: <span class="math inline">\(H_0: \gamma_1 = \gamma_2 =0\)</span>, or the instruments are weak.</p></li>
<li><p>Based on Stock and Yogo (2005), the general recommendation is to get an F&gt;10, to reject the Null.</p></li>
<li><p>However, new evidence and research suggest that F=10 is not large enough.</p>
<ul>
<li>One should either use F&gt;104 (To keep the same t) (Lee McCrary Moreira Porter, 2020)</li>
<li>or use an alternative t-critica (3.4 for an F=10)</li>
</ul></li>
</ul>
</section>
<section id="examples" class="level2">
<h2 class="anchored" data-anchor-id="examples">Examples</h2>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">* This code is only to show the process. Too long to run in quarto</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">capture program drop simx </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">program simx, eclass</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">clear</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">local N `1'</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">local F `2'</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">local sig = sqrt(`N'/ `F')</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">set obs `N'</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">gen e = rnormal()</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">gen z = rnormal() </span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">gen x = 1 + z + (e+rnormal())*sqrt(.5)*`sig'</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">*sqrt(10) </span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">gen y = 1 + (e+rnormal())*sqrt(.5)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">reg x z, </span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">matrix b=(_b[z]/_se[z])^2</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">ivreg y (x=z), </span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">matrix b=b,_b[x],_b[x]/_se[x]</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">ereturn post b</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">end</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">tempfile f1 f2 f3 f4 f5</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">parallel initialize 14</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">parallel sim, reps(5000): simx 500 10</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">gen F=10</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">save `f1'</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">parallel sim, reps(5000): simx 500 20</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co">gen F=20</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">save `f2'</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co">parallel sim, reps(5000): simx 500 40</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co">gen F=40</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">save `f3'</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co">parallel sim, reps(5000): simx 500 80</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co">gen F=80</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co">save `f4'</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co">parallel sim, reps(5000): simx 500 160</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co">gen F=160</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co">save `f5'</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="co">clear </span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co">append using `f1'</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co">append using `f2'</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="co">append using `f3'</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="co">append using `f4'</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="co">append using `f5'</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="co">ren (*) (f_stat b_coef t_stat)</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> mdata/ivweak, <span class="kw">clear</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="dv">scheme</span> white2</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>color_style tableau</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>joy_plot t_stat, <span class="bn">over</span>(<span class="fu">F</span>) <span class="bn">xline</span>(-1.96 1.96) <span class="bn">xtitle</span>(t-Stat) dadj(2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="8_iv2sls_files/figure-revealjs/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="iv-for-measurement-errors-two-wrongs-make-one-right" class="level2">
<h2 class="anchored" data-anchor-id="iv-for-measurement-errors-two-wrongs-make-one-right">IV for Measurement errors: Two wrongs make one right</h2>
<ul>
<li>As described previously when independent variables have measurement errors (Classical), using the variable with errors will produced biased coefficients.</li>
<li>If you have multiple variables with Mesurement error, however, its possible to use IV to correct the problem.
<ul>
<li>This is done by using one variable as the instrument of the other.</li>
</ul></li>
<li>FOr this strategy to work, we need the error to be classical. That is, Uncorrelated across each other, and unrelated to the model error.</li>
</ul>
<p>Consider the following:</p>
<p><span class="math display">\[\begin{aligned}
y &amp;= \beta_0 + \beta_1 x_1 + e \\
\check x_1 &amp;= x_1 + u_1 \\
\tilde x_1 &amp;= x_1 + u_2 \\
\end{aligned}
\]</span></p>
</section>
<section id="section-3" class="level2">
<h2 class="anchored" data-anchor-id="section-3"></h2>
<ul>
<li>If we use each model, independently, we will have biased coefficients</li>
<li>If we combined the, Biases will remain present (albeit lower)</li>
<li>If we use one as instrument of the other tho:</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\beta_{1,iv} &amp;= \frac{cov(\check x_1, y)}{cov(\check x_1, \tilde x_1)} or \beta_{1,iv} = \frac{cov(\tilde x_1, y)}{cov(\check x_1, \tilde x_1)} \\
&amp; = \frac{cov(x_1 + u_1, \beta_0 + \beta_1 x_1 + e)}{cov(x_1 + u_2, x_1 + u_1)} \\
&amp; = \frac{\beta_1 cov(x_1,x_1) + cov(x_1, e) + \beta_1 cov(u_1, x_1) + cov(x_1,e)}{cov(x_1 , x_1 )} \\
&amp; = \beta_1
\end{aligned}
\]</span></p>
</section>
<section id="example-1" class="level2">
<h2 class="anchored" data-anchor-id="example-1">Example</h2>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="kw">obs</span> 1000</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> x = rnormal()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="fu">y</span> = 1 + x + rnormal() </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> x1 = x + rnormal()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> <span class="kw">x2</span> = x + rnormal()</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: <span class="kw">regress</span> <span class="fu">y</span> x</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m1</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: <span class="kw">regress</span> <span class="fu">y</span> x1</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m2</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: <span class="kw">regress</span> <span class="fu">y</span> <span class="kw">x2</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m3</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> x1_x2 = (x1 + <span class="kw">x2</span>)/2</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: <span class="kw">regress</span> <span class="fu">y</span> x1_x2</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m3b</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:ivregress 2sls  <span class="fu">y</span> (x1=<span class="kw">x2</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m4</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:ivregress 2sls  <span class="fu">y</span> (<span class="kw">x2</span>=x1)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m5</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>esttab m1 m2 m3 m3b m4 m5, se</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of observations (_N) was 0, now 1,000.

-------------------------------------------------------------------------------
&gt; -----------------------------
                      (1)             (2)             (3)             (4)      
&gt;        (5)             (6)   
                        y               y               y               y      
&gt;          y               y   
-------------------------------------------------------------------------------
&gt; -----------------------------
x                   1.006***                                                   
&gt;                              
                 (0.0320)                                                      
&gt;                              

x1                                  0.520***                                   
&gt;      1.018***                
                                 (0.0277)                                      
&gt;   (0.0640)                   

x2                                                  0.502***                   
&gt;                      1.038***
                                                 (0.0277)                      
&gt;                   (0.0654)   

x1_x2                                                               0.682***   
&gt;                              
                                                                 (0.0301)      
&gt;                              

_cons               1.010***        0.996***        0.988***        0.983***   
&gt;      0.974***        0.956***
                 (0.0313)        (0.0380)        (0.0384)        (0.0360)      
&gt;   (0.0438)        (0.0451)   
-------------------------------------------------------------------------------
&gt; -----------------------------
N                    1000            1000            1000            1000      
&gt;       1000            1000   
-------------------------------------------------------------------------------
&gt; -----------------------------
Standard errors in parentheses
* p&lt;0.05, ** p&lt;0.01, *** p&lt;0.001</code></pre>
</div>
</div>
</section>
</section>
<section id="endogenous-ivs-and-too-many-ivs" class="level1">
<h1>Endogenous IVs and Too many IVs</h1>
<section id="testing-for-endogeneity-and-overidentifying-restrictions" class="level2">
<h2 class="anchored" data-anchor-id="testing-for-endogeneity-and-overidentifying-restrictions">Testing for Endogeneity and Overidentifying restrictions</h2>
<ul>
<li>In general, Instrumental variables are a great tool to deal with <strong>A4</strong> violations.
<ul>
<li>but, it can be hard to find the perfect IV, and you may still have problems if its Weak.</li>
</ul></li>
<li>In that case, it may be useful to asnwer…Do you have an Endogeneity problem? (empirically rather than theoretically)</li>
</ul>
<p>Test:</p>
<ol type="1">
<li>Estimate first stage, and save predicted residuals <span class="math inline">\(\hat v\)</span>:</li>
</ol>
<p><span class="math display">\[y_2 = \gamma_0 + \gamma_1 z_1 + \gamma_2 x_1 + \gamma_3 x_2 + v
\]</span></p>
<p>You expect residuals to be endogenous</p>
<ol start="2" type="1">
<li>Estimate main model “adding” the residuals first stage</li>
</ol>
<p><span class="math display">\[y = \beta_0 + \beta_1 y_2 + \beta_2 x_1 + \beta_3 x_2 + \theta \hat v + e
\]</span></p>
<p>Test for <span class="math inline">\(H_0: \theta=0\)</span>.</p>
</section>
<section id="section-4" class="level2">
<h2 class="anchored" data-anchor-id="section-4"></h2>
<ul>
<li><p>If the model was endogenous, Then <span class="math inline">\(\theta\)</span> will be different from zero, and <span class="math inline">\(\beta's\)</span> different from the case without controlling for it.</p></li>
<li><p>Otherwise, we reject presence of endogeneity.</p></li>
<li><p>This method has the added advantage:</p></li>
<li><p>For the simple and exactly identified case, 2sls and adding residuals provide the same solution, except for SE. (its called Control function approach)</p></li>
</ul>
</section>
<section id="overidentifying-restrictions" class="level2">
<h2 class="anchored" data-anchor-id="overidentifying-restrictions">overidentifying restrictions</h2>
<ul>
<li><p>Some times, you <strong>may</strong> have access to multiple potential instruments.</p>
<ul>
<li>But what if this instruments give you different results?</li>
<li>If you expect/believe a single effect exists, then there may be a problem. (one of they may be endogenous)</li>
</ul></li>
<li><p>So how do we test if the instruments are exogenous?</p>
<ul>
<li>First you need more instruments than endogenous variables.</li>
</ul></li>
</ul>
</section>
<section id="section-5" class="level2">
<h2 class="anchored" data-anchor-id="section-5"></h2>
<ul>
<li><p>S1. Estimate Structural Equation <span class="math display">\[y=\beta_0 + \gamma y_2 + \beta_1 x_1 + e | y_2 \sim z_1, z_2
\]</span></p></li>
<li><p>S2. Auxiliary equation <span class="math display">\[
\hat e = \delta_0 + \delta_1 z_1 + \delta_2 z2 + \delta_3 x_1 + v
\]</span></p></li>
<li><p>S3. Test for Overall Fitness. <span class="math inline">\(nR^2\sim \chi^2(q_{iv})\)</span> with <span class="math inline">\(q_{iv} = \# over IVs\)</span></p></li>
</ul>
</section>
<section id="ivs-as-lates" class="level2">
<h2 class="anchored" data-anchor-id="ivs-as-lates">IV’s as LATES</h2>
<p>NOTE</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When describing this test, I mentioned that one would be typically worried if observing multiple coefficients when using different IV’s.</p>
<p>However, IV’s can identify different effects, because different IV’s may affect different people differently.</p>
<p><span class="math inline">\(Z1\)</span> may affect, say, only men. <span class="math inline">\(z_2\)</span> only women, <span class="math inline">\(z_3\)</span> only highly educated, etc.</p>
<p>When analyzing IV’s will be important to undertand who would be affected by the instrument the most, because that may explain why effects vary.</p>
</div>
</div>
</section>
<section id="example-2" class="level2 scrollable">
<h2 class="scrollable anchored" data-anchor-id="example-2">Example</h2>
<p>Ignoring Potential endogeneity</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>frause mroz, <span class="kw">clear</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">if</span> lwage==.</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>** But with Endogeneity</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">reg</span> lwage educ exper expersq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(325 observations deleted)

      Source |       SS           df       MS      Number of obs   =       428
-------------+----------------------------------   F(3, 424)       =     26.29
       Model |  35.0222967         3  11.6740989   Prob &gt; F        =    0.0000
    Residual |  188.305144       424  .444115906   R-squared       =    0.1568
-------------+----------------------------------   Adj R-squared   =    0.1509
       Total |  223.327441       427  .523015084   Root MSE        =    .66642

------------------------------------------------------------------------------
       lwage | Coefficient  Std. err.      t    P&gt;|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        educ |   .1074896   .0141465     7.60   0.000     .0796837    .1352956
       exper |   .0415665   .0131752     3.15   0.002     .0156697    .0674633
     expersq |  -.0008112   .0003932    -2.06   0.040    -.0015841   -.0000382
       _cons |  -.5220406   .1986321    -2.63   0.009    -.9124667   -.1316144
------------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>First Stage for different IVs</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: <span class="kw">reg</span> educ fatheduc exper expersq</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> r1 , res</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">test</span> fatheduc</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>adde <span class="fu">scalar</span> fiv = <span class="fu">r</span>(<span class="fu">F</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>adde <span class="fu">scalar</span> pfiv = <span class="fu">r</span>(<span class="kw">p</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m1</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: <span class="kw">reg</span> educ motheduc exper expersq</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> r2 , res</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="kw">test</span> motheduc</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>adde <span class="fu">scalar</span> fiv = <span class="fu">r</span>(<span class="fu">F</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>adde <span class="fu">scalar</span> pfiv = <span class="fu">r</span>(<span class="kw">p</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m2</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>: <span class="kw">reg</span> educ fatheduc motheduc exper expersq</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> r3 , res</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="kw">test</span> motheduc fatheduc</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>adde <span class="fu">scalar</span> fiv = <span class="fu">r</span>(<span class="fu">F</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>adde <span class="fu">scalar</span> pfiv = <span class="fu">r</span>(<span class="kw">p</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m3</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>esttab m1 m2 m3 , <span class="fu">scalar</span>(fiv pfiv) sfmt(%5.2f %5.3f) <span class="kw">order</span>(fatheduc motheduc exper expersq) se <span class="co">///</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="kw">star</span>(* 0.1 ** 0.05 *** 0.01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 ( 1)  fatheduc = 0

       F(  1,   424) =   87.74
            Prob &gt; F =    0.0000

 ( 1)  motheduc = 0

       F(  1,   424) =   73.95
            Prob &gt; F =    0.0000

 ( 1)  motheduc = 0
 ( 2)  fatheduc = 0

       F(  2,   423) =   55.40
            Prob &gt; F =    0.0000

------------------------------------------------------------
                      (1)             (2)             (3)   
                     educ            educ            educ   
------------------------------------------------------------
fatheduc            0.271***                        0.190***
                 (0.0289)                        (0.0338)   

motheduc                            0.268***        0.158***
                                 (0.0311)        (0.0359)   

exper              0.0468          0.0489          0.0452   
                 (0.0411)        (0.0417)        (0.0403)   

expersq          -0.00115        -0.00128        -0.00101   
                (0.00123)       (0.00124)       (0.00120)   

_cons               9.887***        9.775***        9.103***
                  (0.396)         (0.424)         (0.427)   
------------------------------------------------------------
N                     428             428             428   
fiv                 87.74           73.95           55.40   
pfiv                0.000           0.000           0.000   
------------------------------------------------------------
Standard errors in parentheses
* p&lt;0.1, ** p&lt;0.05, *** p&lt;0.01</code></pre>
</div>
</div>
<p>Using parents education as instruments</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>* SMALL requests Df adjustment</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:ivregress 2sls lwage (educ= fatheduc ) exper expersq, small</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m1</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:ivregress 2sls lwage (educ= motheduc ) exper expersq, small</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m2</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:ivregress 2sls lwage (educ= fatheduc motheduc) exper expersq, small</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m3</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>esttab m1 m2 m3 , se mtitle(IV:Father IV:Mother IV:Parents) <span class="co">///</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="kw">star</span>(* 0.1 ** 0.05 *** 0.01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
------------------------------------------------------------
                      (1)             (2)             (3)   
                IV:Father       IV:Mother      IV:Parents   
------------------------------------------------------------
educ               0.0702**        0.0493          0.0614*  
                 (0.0344)        (0.0374)        (0.0314)   

exper              0.0437***       0.0449***       0.0442***
                 (0.0134)        (0.0136)        (0.0134)   

expersq         -0.000882**     -0.000922**     -0.000899** 
               (0.000401)      (0.000406)      (0.000402)   

_cons             -0.0611           0.198          0.0481   
                  (0.436)         (0.473)         (0.400)   
------------------------------------------------------------
N                     428             428             428   
------------------------------------------------------------
Standard errors in parentheses
* p&lt;0.1, ** p&lt;0.05, *** p&lt;0.01</code></pre>
</div>
</div>
<p>** Testing for endogeneity</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>* Instrumenting education</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span>  lwage educ  exper expersq r1</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m1</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span>  lwage educ  exper expersq r2</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m2</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:<span class="kw">reg</span>  lwage educ  exper expersq r3</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="kw">est</span> sto m3</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>esttab m1 m2 m3 , se mtitle(IV:Father IV:Mother IV:Parents) <span class="co">///</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="kw">star</span>(* 0.1 ** 0.05 *** 0.01)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>*see -<span class="kw">estat</span> endogenous- after ivregress 2sls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
------------------------------------------------------------
                      (1)             (2)             (3)   
                IV:Father       IV:Mother      IV:Parents   
------------------------------------------------------------
educ               0.0702**        0.0493          0.0614** 
                 (0.0341)        (0.0366)        (0.0310)   

exper              0.0437***       0.0449***       0.0442***
                 (0.0133)        (0.0133)        (0.0132)   

expersq         -0.000882**     -0.000922**     -0.000899** 
               (0.000397)      (0.000398)      (0.000396)   

r1                 0.0450                                   
                 (0.0375)                                   

r2                                 0.0684*                  
                                 (0.0397)                   

r3                                                 0.0582*  
                                                 (0.0348)   

_cons             -0.0611           0.198          0.0481   
                  (0.433)         (0.463)         (0.395)   
------------------------------------------------------------
N                     428             428             428   
------------------------------------------------------------
Standard errors in parentheses
* p&lt;0.1, ** p&lt;0.05, *** p&lt;0.01</code></pre>
</div>
</div>
<p>Overid Test</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">qui</span>:ivregress 2sls lwage (educ= fatheduc motheduc) exper expersq, small</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">predict</span> <span class="kw">resid</span>, res</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">estat</span> overid </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">reg</span> <span class="kw">resid</span> fatheduc motheduc exper expersq, notable <span class="kw">robust</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  Tests of overidentifying restrictions:

  Sargan (score) chi2(1) =  .378071  (p = 0.5386)
  Basmann chi2(1)        =  .373985  (p = 0.5408)

Linear regression                               Number of obs     =        428
                                                F(4, 423)         =       0.11
                                                Prob &gt; F          =     0.9791
                                                R-squared         =     0.0009
                                                Root MSE          =     .67521
</code></pre>
</div>
</div>
</section>
</section>
<section id="thats-all-for-today" class="level1">
<h1>Thats all for today!</h1>
<p>Next week: Limited Dep Variables When data has kinks</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>