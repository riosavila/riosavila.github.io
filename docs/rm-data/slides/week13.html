<!DOCTYPE html>
<html lang="en"><head>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/tabby.min.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-07ba0ad10f5680c660e360ac31d2f3b6.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.33">

  <meta name="author" content="Fernando Rios-Avila">
  <meta name="dcterms.date" content="2024-11-26">
  <title>Econometrics MSC Levy – Forecasting from Time Series Data</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
  </style>
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/theme/quarto-97edfe54b73ff960639f8ac44205bcc0.css">
  <link href="../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Forecasting from Time Series Data</h1>
  <p class="subtitle">Todays forcast it will be sunny with a chance of rain</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Fernando Rios-Avila 
</div>
        <p class="quarto-title-affiliation">
            Levy Economics Institute
          </p>
    </div>
</div>

  <p class="date">November 26, 2024</p>
</section>
<section id="forecast-setup" class="slide level2">
<h2>Forecast setup</h2>
<blockquote>
<p>It is difficult to make predictions, especially about the future. (Niels Bohr; possibly an old Danish proverb)</p>
</blockquote>
<ul>
<li>It is fairly easy to make forecasts for variables that have a decently stable pattern over time
<ul>
<li>Weekly FastMovingGoods product sales, sensor of gadgets used regularly</li>
</ul></li>
<li>It is very hard to make forecasts of really interesting variables
<ul>
<li>GDP with Recession, crisis,</li>
<li>High tech gadgets with new products</li>
<li>Stock market prices</li>
</ul></li>
<li>why???
<ul>
<li>Tradition!</li>
</ul></li>
</ul>
</section>
<section id="forecasting-basics" class="slide level2">
<h2>Forecasting basics</h2>
<ul>
<li>Forecasting is a special case of prediction.</li>
<li>Forecasting makes use of time series data on <span class="math inline">\(y\)</span>, and possibly other variables <span class="math inline">\(x\)</span>.</li>
<li>The original data used for forecasting is a time series from 1 through <span class="math inline">\(T\)</span>, such as <span class="math inline">\(y_1, y_2, ..., y_T\)</span></li>
<li>The forecast is prepared for time periods after the original data ends, such as <span class="math inline">\(\hat{y}_{T+1}, \hat{y}_{T+2}, ..., \hat{y}_{T+H}\)</span>. This is the live time series data.</li>
</ul>
</section>
<section id="forecast-horizon" class="slide level2">
<h2>Forecast horizon</h2>
<ul>
<li>What is it?
<ul>
<li>The length of the live time series data (here <span class="math inline">\(H\)</span>) = the forecast horizon.</li>
</ul></li>
<li>Short-horizon forecasts are carried out for a few observations after the original time series;
<ul>
<li>5-10 years of monthly data <span class="math inline">\(\rightarrow\)</span> forecast a 3-12 months ahead</li>
<li>10 years of quarterly data <span class="math inline">\(\rightarrow\)</span> predict ahead of a few quarters</li>
</ul></li>
<li>Long-horizon forecasts are carried out for many observations.
<ul>
<li>Often: data on activity, operation</li>
<li>5 years of daily data <span class="math inline">\(\rightarrow\)</span> forecast daily ahead for a year</li>
<li>2 months of hourly activity data <span class="math inline">\(\rightarrow\)</span> predict weeks ahead</li>
</ul></li>
</ul>
</section>
<section id="cross-validation-in-time-series" class="slide level2">
<h2>Cross-validation in time series</h2>
<ul>
<li>Cross-validation is essential in time series
<ul>
<li>The ability to build a model that works well for the future, without overfitting</li>
</ul></li>
<li>But it is tricky
<ul>
<li>you cannot just randomly split the data.
<ul>
<li>Time series is time dependent</li>
</ul></li>
<li>But there are Options</li>
</ul></li>
</ul>
</section>
<section id="cross-validation-options" class="slide level2">
<h2>Cross-validation: Options</h2>
<ul>
<li>OP1: Select a “test set” of few periods where to evaluate the model
<ul>
<li>Use all information before and the test set to build the model</li>
<li>And a common “end of sample” test set</li>
<li>Good for long-horizon forecasts</li>
</ul></li>
<li>OP2: Select a “test set” of few periods where to evaluate the model
<ul>
<li>Use “X” periods before the test set to build the model</li>
<li>Repeat with the next Window</li>
<li>Good for short-horizon forecasts</li>
</ul></li>
</ul>
</section>
<section id="cross-validation" class="slide level2">
<h2>Cross-validation</h2>
<div class="panel-tabset">
<ul id="tabset-1" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-1-1">Option 1: Full sample</a></li><li><a href="#tabset-1-2">Option 2: Rolling window</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1">
<p><img data-src="images/paste-29.png"></p>
</div>
<div id="tabset-1-2">
<p><img data-src="images/paste-27.png"></p>
</div>
</div>
</div>
</section>
<section id="message" class="slide level2">
<h2>Message:</h2>
<ul>
<li>The strategy for prediction and cross-validation depends on the forecast horizon.
<ul>
<li>For short-horizon forecasts, you really need to consider the time dependence of the data.</li>
<li>For long-horizon forecasts, you try to capture long-term patterns in the data.</li>
</ul></li>
</ul>
</section>
<section>
<section id="long-horizon" class="title-slide slide level1 center">
<h1>Long-horizon:</h1>
<p>Seasonality, trend and predictable events</p>
</section>
<section id="long-horizon-forecasting-seasonality-and-predictable-events" class="slide level2">
<h2>Long-horizon forecasting: Seasonality and predictable events</h2>
<ul>
<li>Look for aspect of data that matter for long time</li>
<li>Focus on predictable aspects of time series
<ul>
<li>Trend(s) + Seasonality + Other regular events</li>
</ul></li>
<li>Two options to model trend: estimate average change or trend line
<ul>
<li><span class="math inline">\(y = f(T,S,E)\)</span> or</li>
<li><span class="math inline">\(\%\Delta y \text{ or } \Delta y =g(T,S,E)\)</span></li>
</ul></li>
<li>Seasonality: ie model with set of variables (11 months), maybe interactions</li>
<li>Other regular events - set of binary vars (War, Covid, New Policy, etc)</li>
</ul>
</section>
<section id="long-horizon-forecasting-growth-rates" class="slide level2">
<h2>Long-horizon forecasting: Growth rates</h2>
<p>First model - estimate average change:</p>
<p><span class="math display">\[\hat{\Delta}y = \hat{\alpha}\]</span></p>
<p>For prediction this means:</p>
<p><span class="math display">\[
\begin{aligned}
\hat{y}_{T+1} &amp;= y_T + \hat{\Delta}y \\
\hat{y}_{T+2} &amp;= \hat{y}_{T+1} + \hat{\Delta}y = y_T + 2 \times \hat{\Delta}y \\
\dots \\
\hat{y}_{T+H} &amp;= y_T xx+ H \times \hat{\Delta}y
\end{aligned}
\]</span></p>
</section>
<section id="long-horizon-forecasting-trends" class="slide level2">
<h2>Long-horizon forecasting: Trends</h2>
<p>Estimate trend line: <span class="math display">\[\hat{y}_t = \hat{\alpha} + \hat{\delta}t\]</span></p>
<ul>
<li><span class="math inline">\(\hat{\alpha}\)</span> is predicted <span class="math inline">\(y\)</span> when <span class="math inline">\(t = 0\)</span></li>
<li><span class="math inline">\(\hat{\delta}\)</span> tells us how much predicted <span class="math inline">\(y\)</span> changes if <span class="math inline">\(t\)</span> is increased by one unit.</li>
<li>You can also use more complex trends. (but one should still be concerned about overfitting)</li>
</ul>
</section>
<section id="long-horizon-forecasting-trends---compare-options" class="slide level2">
<h2>Long-horizon forecasting: Trends - compare options</h2>
<ul>
<li>Difference in models
<ul>
<li>Model changes:
<ul>
<li>Assumes that <span class="math inline">\(y\)</span> continues from the last observation, and increase by the same amount each time. What if Last observation is unusual?</li>
</ul></li>
<li>Model trend line
<ul>
<li>Assumes that <span class="math inline">\(y\)</span> remains close to the trend line. Last unusual observation would not matter for the forecast, because it would be the trend line.</li>
</ul></li>
</ul></li>
<li>Neither approach is inherently better than the other</li>
</ul>
</section>
<section id="long-horizon-forecasting-seasonality" class="slide level2">
<h2>Long-horizon forecasting: Seasonality</h2>
<ul>
<li>Capture regular fluctuations</li>
<li>Months, days of the week, hours, combinations</li>
</ul>
</section>
<section id="case-study-abq-swimming" class="slide level2">
<h2>Case study: ABQ swimming</h2>
<ul>
<li>Swimming pool data</li>
<li>Albuquerque (ABQ), New Mexico, USA</li>
<li>Big data, transaction level entry data logged from sales systems</li>
<li>1.5m observations</li>
</ul>
<p>This CS:</p>
<ul>
<li>Sample: Single swimming pool</li>
<li>Aggregated: number of ticket sales per day</li>
<li>After some sample design - regular tickets only</li>
</ul>
</section>
<section id="case-study-modelling" class="slide level2">
<h2>Case study: Modelling</h2>
<ul>
<li>Trend is simple – use simple linear trend: <span class="math inline">\(\alpha t\)</span>
<ul>
<li>Maybe not really important at all</li>
<li>Perhaps consider exponential trend? (log-linear model)</li>
</ul></li>
<li>Seasonality is important and tricky</li>
</ul>
</section>
<section id="case-study-daily-ticket-sales" class="slide level2">
<h2>Case study: Daily ticket sales</h2>

<img data-src="images/paste-30.png" class="r-stretch quarto-figure-center"><p class="caption">Daily Sales 5Yrs</p></section>
<section id="case-study-monthly-and-daily-seasonality" class="slide level2">
<h2>Case study: Monthly and daily seasonality</h2>
<div class="columns">
<div class="column">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/paste-31.png"></p>
<figcaption>Month</figcaption>
</figure>
</div>
</div><div class="column">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/paste-32.png"></p>
<figcaption>Day of the Week</figcaption>
</figure>
</div>
</div></div>
</section>
<section id="case-study-daily-ticket-sales-a-heatmap" class="slide level2">
<h2>Case study: Daily ticket sales: A heatmap</h2>
<div class="columns">
<div class="column">
<ul>
<li>Tool to model seasonality</li>
<li>Each cell is average sales for a given combination of day and month over years</li>
<li>Colors help see pattern</li>
</ul>
</div><div class="column">
<p><img data-src="images/paste-36.png"></p>
</div></div>
</section>
<section id="case-study-modeling" class="slide level2">
<h2>Case study: Modeling</h2>
<ul>
<li>Trend is simple - linear trend</li>
<li>Seasonality is tricky - need to model and simplify
<ul>
<li>Months</li>
<li>Days of the week</li>
<li>USA holidays (dummies)</li>
<li>Summer break (depends?)</li>
<li>Interaction of summer break and day of the week</li>
<li>Interaction of weekend and month</li>
</ul></li>
</ul>
</section>
<section id="case-study-model-features-and-rmse" class="slide level2">
<h2>Case study: Model features and RMSE</h2>
<table class="caption-top">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>trend</th>
<th>months</th>
<th>days</th>
<th>holidays</th>
<th>school*days</th>
<th>days*months</th>
<th>RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>M1</td>
<td>X</td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>32.35</td>
</tr>
<tr class="even">
<td>M2</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td>31.45</td>
</tr>
<tr class="odd">
<td>M3</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td></td>
<td></td>
<td>29.46</td>
</tr>
<tr class="even">
<td>M4</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td></td>
<td>27.61</td>
</tr>
<tr class="odd">
<td>M5</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>26.90</td>
</tr>
<tr class="even">
<td>M6 (log)</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td></td>
<td>30.99</td>
</tr>
<tr class="odd">
<td>M7 (Prophet-ML)</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>N/A</td>
<td></td>
<td>29.47</td>
</tr>
</tbody>
</table>
<p>Note: Trend is linear trend, days is day-of-the-week, holidays: national US holidays, school*days is school holiday (mid-May to mid-August and late December) interacted with days of week.<br>
RMSE is cross-validated.<br>
Source: swim-transactions dataset.<br>
Daily time series, 2010–2016, N=2522 (work set 2010–2015, N=2162).</p>
</section>
<section id="case-study-compared-actual-vs-predicted-on-holdout-set-2016" class="slide level2">
<h2>Case study: Compared actual vs predicted on holdout set (2016)</h2>

<img data-src="images/paste-37.png" style="width:80.0%" class="r-stretch"></section>
<section id="case-study-diagnostics---holdout-set-2016" class="slide level2">
<h2>Case study: Diagnostics - holdout set (2016)</h2>
<div class="columns">
<div class="column">
<h3 id="actual-vs-predicted-august-2016">Actual vs predicted August 2016</h3>
<p><img data-src="images/paste-38.png"></p>
</div><div class="column">
<h3 id="monthly-rmse">Monthly RMSE</h3>
<p><img data-src="images/paste-40.png"></p>
</div></div>
</section>
<section id="case-study-diagnostics-vs-model-building" class="slide level2">
<h2>Case study: Diagnostics vs model building</h2>
<ul>
<li>Here we used diagnostics to learn about what to expect, strength and weaknesses of the already <strong>selected</strong> model.
<ul>
<li>This means, no going back to drawing board.</li>
</ul></li>
<li>But, we could have said, lets run some checks on the training set and maybe alter the model accordingly.
<ul>
<li>As we normally do with scatterplots, lowess, tabulations, etc</li>
<li>Here: something weird happening in December.</li>
</ul></li>
<li>Act, build a new model and test, etc.</li>
</ul>
</section></section>
<section>
<section id="short-run-horizon-serial-correlation-and-arima" class="title-slide slide level1 center">
<h1>Short-run horizon, serial correlation and ARIMA</h1>
<p>What you learn today, you can use tomorrow</p>
</section>
<section id="short-horizon-forecasting-what-is-new" class="slide level2">
<h2>Short-horizon forecasting: what is new?</h2>
<ul>
<li><p>Serial correlation is essential</p>
<ul>
<li>Data Depends on itself, and Errors Also Depend on Themselves</li>
</ul></li>
<li><p>Modeling how a shock fades away <span class="math inline">\(\leftarrow\)</span> Hopefully things “return to normal”</p>
<ul>
<li>Autoregressive (AR) models, capture the patterns of serial correlation – <span class="math inline">\(y\)</span> at time <span class="math inline">\(t\)</span> is regressed on its lags, that is its past values, <span class="math inline">\(t - 1, t - 2, etc\)</span>.</li>
</ul></li>
<li><p>The simplest includes one lag only, AR(1): <span class="math display">\[y_t^E = \beta_0 + \beta_1 y_{t-1}\]</span></p></li>
<li><p>Interested in estimating <span class="math inline">\(\beta_1\)</span> or <span class="math inline">\(\rho\)</span>.</p>
<ul>
<li>If <span class="math inline">\(\rho = 1\)</span> is random walk (unpredictable),</li>
<li>if <span class="math inline">\(\rho = 0\)</span> is white noise (also unpredictable, but stable).</li>
</ul></li>
</ul>
</section>
<section id="short-horizon-forecasting-ar1" class="slide level2">
<h2>Short-horizon forecasting: AR(1)</h2>
<ul>
<li>One-period-ahead forecast from an AR(1):
<ul>
<li>Its a recursive formula:</li>
</ul></li>
</ul>
<p><span class="math display">\[\begin{aligned}
\hat{y}_{T+1} &amp;= \hat{\beta}_0 + \hat{\beta}_1 y_T \\
\hat{y}_{T+2} &amp;= \hat{\beta}_0 + \hat{\beta}_1 \hat y_{T+1}  \\
              &amp;=  \hat{\beta}_0 + \hat{\beta}_1 \hat{\beta}_0 + \hat{\beta}_1^2  y_T \\
\dots                \\
\hat{y}_{T+k} &amp;= \hat{\beta}_0 \sum_{s=1}^{k}  \hat{\beta}_1^{s-1} + \hat{\beta}_1^{k} y_T
\end{aligned}
\]</span></p>
</section></section>
<section>
<section id="arima" class="title-slide slide level1 center">
<h1>ARIMA</h1>
<p>Bringing the Big Guns</p>
</section>
<section id="short-horizon-forecasting-arima" class="slide level2">
<h2>Short-horizon forecasting: ARIMA</h2>
<ul>
<li>ARIMA(p,d,q) models that are generalizations of the AR(1) model
<ul>
<li>can approximate any pattern of serial correlation.</li>
</ul></li>
<li>ARIMA models are put together from three parts: AR(p), I(d) and MA(q).</li>
<li>but What are these?</li>
</ul>
</section>
<section id="short-horizon-forecasting-arimapdq" class="slide level2">
<h2>Short-horizon forecasting: ARIMA(p,d,q)</h2>
<ul>
<li>The ARIMA model combines three approaches to modeling time series data:
<ul>
<li>AR(p): autoregressive models, We have seen this</li>
<li>I(d): models of differences, This is new
<ul>
<li>Relates to models that you first take the difference before modeling.</li>
<li>For example <span class="math inline">\(\Delta y_t = y_t - y_{t-1} = \alpha\)</span> is a I(1) model</li>
</ul></li>
<li>MA(q) models: moving average models: Concentrates on the error term, and how much it “depends” on past errors.
<ul>
<li>For example <span class="math inline">\(y_t = e_t + \theta e_{t-1}\)</span> is a MA(1) model</li>
<li><span class="math inline">\(\theta\)</span> has to be estimated via maximum likelihood, not OLS.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="arima-mix-and-match" class="slide level2">
<h2>ARIMA: Mix and Match</h2>
<ul>
<li>ARIMA(2,1,0): <span class="math inline">\(\Delta y_t = \beta_0 + \beta_1 \Delta y_{t-1} + \beta_2 \Delta y_{t-2} + e_t\)</span></li>
<li>ARIMA(0,1,1): <span class="math inline">\(\Delta y_t = \beta_0 + \theta e_{t-1} + e_t\)</span></li>
<li>ARIMA(0,2,2): <span class="math inline">\(\Delta^2 y_t = \beta_0 + \theta_1 e_{t-1} + \theta_2 e_{t-2} + e_t\)</span></li>
<li>ARIMA(p,d,q): <span class="math inline">\(\Delta^q y_t = \beta_0 + \sum_{i=1}^{p} \beta_i \Delta^q y_{t-i} + \sum_{j=1}^{q} \theta_j e_{t-j}+e_t\)</span></li>
</ul>
<p>In practice, You rarely see <span class="math inline">\(d&gt;2\)</span>, although <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> can be larger (depending on frequency of data)</p>
</section>
<section id="how-to-choose-pdq" class="slide level2">
<h2>How to choose (p,d,q)?</h2>
<ul>
<li>Empirical approach
<ul>
<li>Whichever works best in a cross-validated exercise!</li>
<li>Try out a few and pick the one that works best</li>
<li>“auto-arima” - an algo that tries out many options</li>
<li>keep it simple, <span class="math inline">\(d = 0, 1\)</span> and <span class="math inline">\(p = 0, 1, 2\)</span> and <span class="math inline">\(q = 0, 1, 2\)</span> rarely more</li>
</ul></li>
</ul>
</section>
<section id="how-to-choose-pdq-1" class="slide level2">
<h2>How to choose (p,d,q)?</h2>
<ul>
<li><p>Box-Jenkins Methodology</p></li>
<li><p>Step 1: Determine <span class="math inline">\(d\)</span>. Typically you test if the data is stationary (ADF test or PP test). You difference the data until it is stationary.</p></li>
<li><p>Step 2: To determine <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> you look at the ACF and PACF of the differenced (if applicable) data.</p>
<ul>
<li>ACF or Autocorrelation function
<ul>
<li><span class="math inline">\(corr(y_t, y_{t-1})\)</span>, <span class="math inline">\(corr(y_t, y_{t-2})\)</span>, etc.</li>
<li>Helps Identify MA component (based on spikes)</li>
</ul></li>
<li>PACF or Partial autocorrelation function
<ul>
<li><span class="math inline">\(y_t = \beta_0 + \beta_1 y_{t-1}+ e_t\)</span></li>
<li><span class="math inline">\(y_t = \beta_0 + \beta_1 y_{t-1}+\beta_2{t-2} y_{t-2} e_t\)</span>,etc</li>
<li>Helps Identify the AR component</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="case-study-case--shiller-home-price-index" class="slide level2">
<h2>Case study: Case- Shiller home price index</h2>
<ul>
<li>Case-Shiller home price index, Los Angeles</li>
<li>Monthly index of home prices</li>
<li>Data available: fred.stlouisfed.org</li>
<li>Use 18 years of monthly data</li>
</ul>
</section>
<section id="case-study-case-shiller-home-price-data" class="slide level2">
<h2>Case study: Case Shiller home price data</h2>
<ul>
<li>18 years of data 2000-2017</li>
<li>work: 2000-2016, holdout is 2017</li>
<li>cross-validate with rolling window, 4-fold
<ul>
<li>train is 2000-2012, test is 2013</li>
<li>…</li>
<li>train is 2003-2015, test is 2016</li>
</ul></li>
<li>Predict 12 months ahead</li>
<li>RMSE - symmetric and quadratic loss</li>
<li>Assume getting index right matters exactly the same</li>
</ul>
</section>
<section id="case-study-target-variable" class="slide level2">
<h2>Case study: target variable</h2>
<ul>
<li>What should be the target variable?
<ul>
<li>The price index</li>
<li>The log of the price index</li>
<li>First difference &lt;- Shortcut to assume I(1) process</li>
</ul></li>
<li>We’ll try out, and pick via cross-validation</li>
<li>The model should include seasonal dummies (could be more complicated)</li>
<li>The model may include a linear trend or capture it with <span class="math inline">\(\Delta y\)</span> as target</li>
<li>The model can have any form of ARIMA</li>
</ul>
</section>
<section id="case-study-case--shiller-home-price-index---prediction-from-arima-models" class="slide level2">
<h2>Case study: Case- Shiller home price index - prediction from ARIMA models</h2>
<table class="caption-top">
<thead>
<tr class="header">
<th>id</th>
<th>target</th>
<th>ARIMA</th>
<th>trend</th>
<th>season</th>
<th>AR</th>
<th>I</th>
<th>MA</th>
<th>RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>M1</td>
<td>p</td>
<td>NO</td>
<td>X</td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td>31.9</td>
</tr>
<tr class="even">
<td>M2</td>
<td>p</td>
<td>YES</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td></td>
<td></td>
<td>9.5</td>
</tr>
<tr class="odd">
<td>M3</td>
<td>p</td>
<td>YES</td>
<td>X</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>4.1</td>
</tr>
<tr class="even">
<td>M4</td>
<td>p</td>
<td>YES</td>
<td>X</td>
<td>X</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>2.3</td>
</tr>
<tr class="odd">
<td>M5</td>
<td>dp</td>
<td>NO</td>
<td>X</td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td>18.8</td>
</tr>
<tr class="even">
<td>M6</td>
<td>lnp</td>
<td>YES</td>
<td>X</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>7.2</td>
</tr>
</tbody>
</table>
</section>
<section id="case-study-prediction-with-best-model-m4-uncertainty" class="slide level2">
<h2>Case study: Prediction with best model M4: Uncertainty</h2>

<img data-src="images/paste-44.png" class="r-stretch quarto-figure-center" id="fig-1"><p class="caption">
Figure&nbsp;1
</p></section>
<section id="stata-corner" class="slide level2">
<h2><code>Stata</code> Corner</h2>
<p>In Stata, the easiest way to estimate ARIMA models is using <code>arima</code> command:</p>
<ul>
<li>ARIMA(2,2,2) model: <code>arima y, arima(2,2,2)</code></li>
</ul>
<p>Predictions are a bit tricky. You can use <code>predict</code> command with the <code>dynamic</code> option to predict out-of-sample values. But also need to indicate “which” periods to start using the model predictions</p>
<ul>
<li><code>predict yhat, dynamic(ym(2017,1)) [y]</code></li>
</ul>
<p><code>yhat</code> is the new variable, <code>ym(2017,1)</code> indicates the first period of 2017, and <code>[y]</code> indicates that we want to predict the “real” dependent variable. Not the changes or transformations.</p>
<p>No built-in option for CI predictions.</p>
</section></section>
<section>
<section id="vector-autoregression" class="title-slide slide level1 center">
<h1>Vector Autoregression</h1>
<p>When you need more than one variable</p>
</section>
<section id="var" class="slide level2">
<h2>VAR</h2>
<ul>
<li>Better forecasts with the help of other variables, at least for short forecast horizons.</li>
<li>Need forecasts of the <span class="math inline">\(x\)</span> variable as well – we need a model.</li>
<li>Vector autoregression (VAR), is a method that incorporates other variables in time series regressions and can use those other variables for forecasting <span class="math inline">\(y\)</span>.</li>
<li>Technically, you are not “ONLY” forecasting <span class="math inline">\(y\)</span> anymore, but a set of time series regressions.</li>
<li>A set of time series regressions.</li>
</ul>
<p><span class="math display">\[{y_t, x_t, z_t} =W_t= \beta_0 + W_{t-1}\beta_1 + W_{t-2}\beta_2 + \dots + W_{t-p}\beta_p + e_t
\]</span></p>
</section>
<section id="var-simplest-model" class="slide level2">
<h2>VAR: simplest model</h2>
<p>The simplest VAR model has <span class="math inline">\(y\)</span> and one <span class="math inline">\(x\)</span> variable, and it includes one lag of each = VAR(1) model.</p>
<p>It assumes that all data have the same frequency. <span class="math display">\[\begin{align*}
y_t^E &amp;= \beta_{10} + \beta_{11} y_{t-1} + \beta_{12} x_{t-1} \\
x_t^E &amp;= \beta_{20} + \beta_{21} y_{t-1} + \beta_{22} x_{t-1}
\end{align*}
\]</span></p>
</section>
<section id="var-forecast" class="slide level2">
<h2>VAR forecast</h2>
<ul>
<li><p><strong>One-period-ahead</strong> forecast for <span class="math inline">\(y\)</span>, only need estimates from the first one: <span class="math display">\[\hat{y}_{T+1} = \hat{\beta}_{10} + \hat{\beta}_{11} y_T + \hat{\beta}_{12} x_T
\]</span></p></li>
<li><p>For forecasting <span class="math inline">\(y\)</span> further ahead, we do need all coefficient estimates, and forecast values of <span class="math inline">\(x\)</span> as well.</p></li>
<li><p>A two-period-ahead forecast of <span class="math inline">\(y\)</span> from a VAR(1) is</p></li>
</ul>
<p><span class="math display">\[
\hat{y}_{T+2} = \hat{\beta}_{10} + \hat{\beta}_{11} \hat{y}_{T+1} + \hat{\beta}_{12} \hat{x}_{T+1}
\]</span></p>
<p>and <span class="math inline">\(\hat{x}_{T+1}\)</span> and <span class="math inline">\(\hat{y}_{T+1}\)</span> are from the first forecast.</p>
<p>Forecasts for <span class="math inline">\(T + 3, T + 4, etc.,\)</span> are analogous.</p>
</section>
<section id="var-characteristics" class="slide level2">
<h2>VAR characteristics</h2>
<p>There are four important characteristics of a VAR:</p>
<ul>
<li>A VAR has a regression for each of the variables.</li>
<li>The right-hand side of each equation has all variables.</li>
<li>Right-hand-side variables are in lags only.</li>
<li>All right-hand-side variables in all regressions have the same number of lags</li>
</ul>
<p>Note: More often than not, you need the “system” to be stable/stationary. This is a bit more complex than just checking the target variable. (You need to see the Matrix of coefficients)</p>
</section>
<section id="case-study-unemployment-rate" class="slide level2">
<h2>Case study: Unemployment Rate</h2>
<div class="columns">
<div class="column">
<h3 id="u.-rate">U. Rate</h3>
<p><img data-src="images/paste-45.png"></p>
</div><div class="column">
<h3 id="change-in-u.-rate">Change in U. Rate</h3>
<p><img data-src="images/paste-46.png"></p>
</div></div>
</section>
<section id="case-study-employed-population" class="slide level2">
<h2>Case study: Employed Population</h2>
<div class="columns">
<div class="column">
<h3 id="lnemp">ln(emp)</h3>
<p><img data-src="images/paste-47.png"></p>
</div><div class="column">
<h3 id="change-in-lnemp">Change in ln(emp)</h3>
<p><img data-src="images/paste-48.png"></p>
</div></div>
</section>
<section id="case-study-case--shiller-home-price-index---model-selection-2" class="slide level2">
<h2>Case study: Case- Shiller home price index - Model selection 2</h2>
<p>Run the VAR model and compare to previous results.</p>
<table class="caption-top">
<thead>
<tr class="header">
<th>id</th>
<th>target</th>
<th>ARIMA</th>
<th>trend</th>
<th>season</th>
<th>AR</th>
<th>I</th>
<th>MA</th>
<th>RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>M1</td>
<td>p</td>
<td>NO</td>
<td>X</td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td>31.9</td>
</tr>
<tr class="even">
<td>M2</td>
<td>p</td>
<td>YES</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td></td>
<td></td>
<td>9.5</td>
</tr>
<tr class="odd">
<td>M3</td>
<td>p</td>
<td>YES</td>
<td>X</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>4.1</td>
</tr>
<tr class="even">
<td>M4</td>
<td>p</td>
<td>YES</td>
<td>X</td>
<td>X</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>2.3</td>
</tr>
<tr class="odd">
<td>M5</td>
<td>dp</td>
<td>NO</td>
<td>X</td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td>18.8</td>
</tr>
<tr class="even">
<td>M6</td>
<td>lnp</td>
<td>YES</td>
<td>X</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>7.2</td>
</tr>
<tr class="odd">
<td>M7a</td>
<td>dp</td>
<td>VAR</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><strong>7.8</strong></td>
</tr>
<tr class="even">
<td>M7b</td>
<td>dp</td>
<td>VAR</td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><strong>4.5</strong></td>
</tr>
</tbody>
</table>
<ul>
<li>In this case study, VAR did not improve on ARIMA.</li>
</ul>
</section>
<section id="var-in-stata" class="slide level2">
<h2>VAR in <code>Stata</code></h2>
<p>Stata has a feature for the estimation of VAR models called…Var</p>
<p><code>var depvarlist [if] [in] [,lags(#) exog(varlist) Other]</code></p>
<ul>
<li><p><code>depvarlist</code> are all the variables one needs to analyze.</p></li>
<li><p><code>lags(#)</code> indicates how many (and which) lags to use.</p></li>
</ul>
<p>For prediction look into <code>fcast</code>, <code>predict</code> or <code>forecast</code></p>
</section>
<section id="external-validity-in-time-series" class="slide level2">
<h2>External validity in time series</h2>
<ul>
<li><p>External validity is about the stability of patterns in the data</p>
<ul>
<li>Such as trends, seasonality (Do they repeat? or do we need to update?)</li>
</ul></li>
<li><p>Stationarity is what we look for:</p>
<ul>
<li>Distribution of the target, predictors is stable over time</li>
<li>Correlation patterns also stable over time</li>
<li>We can then make predictions of the future!</li>
</ul></li>
<li><p>External validity is massive risk with time series by design: predict for future</p></li>
<li><p>What if we update the model with NEW data. How well would it do?</p></li>
</ul>
</section>
<section id="case-study-case--shiller-home-price-index---model-fit-on-test-sets" class="slide level2">
<h2>Case study: Case- Shiller home price index - model fit on test sets</h2>
<p>Four test set (in work set) with rolling window CV. RMSE in each test set for each model.</p>
<table class="caption-top">
<thead>
<tr class="header">
<th></th>
<th>Fold1</th>
<th>Fold2</th>
<th>Fold3</th>
<th>Fold4</th>
<th>Average</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>M1</td>
<td>14.90</td>
<td>17.58</td>
<td>34.44</td>
<td>48.58</td>
<td>31.9</td>
</tr>
<tr class="even">
<td>M2</td>
<td>14.83</td>
<td>8.39</td>
<td>6.23</td>
<td>5.52</td>
<td>9.5</td>
</tr>
<tr class="odd">
<td>M3</td>
<td>6.68</td>
<td>1.39</td>
<td>3.29</td>
<td>3.22</td>
<td>4.1</td>
</tr>
<tr class="even">
<td><strong>M4</strong></td>
<td>2.22</td>
<td>1.96</td>
<td>2.88</td>
<td>1.20</td>
<td>2.2</td>
</tr>
<tr class="odd">
<td>M5</td>
<td>33.94</td>
<td>9.79</td>
<td>10.44</td>
<td>7.39</td>
<td>18.8</td>
</tr>
<tr class="even">
<td>M6</td>
<td>2.49</td>
<td>4.95</td>
<td>9.22</td>
<td>9.54</td>
<td>7.2</td>
</tr>
<tr class="odd">
<td>M7a</td>
<td>13.30</td>
<td>5.85</td>
<td>3.52</td>
<td>4.28</td>
<td>7.8</td>
</tr>
<tr class="even">
<td>M7b</td>
<td>5.24</td>
<td>2.51</td>
<td>5.18</td>
<td>4.75</td>
<td>4.5</td>
</tr>
</tbody>
</table>
</section>
<section id="case-study-prediction-with-best-model-m4-for-2018" class="slide level2">
<h2>Case study: Prediction with best model M4 for 2018</h2>
<div>
<p><img data-src="images/paste-49.png"></p>
</div>
</section>
<section id="summary" class="slide level2">
<h2>Summary</h2>
<ul>
<li>Time series prediction is both simple and very hard
<ul>
<li>Simple as some basic models work okay</li>
<li>Model trend as first difference or linear trend</li>
<li>Model seasonality, regular events</li>
<li>Some basic method of capturing serial correlation</li>
</ul></li>
<li>Time series prediction model building is also very hard
<ul>
<li>Getting seasonality, holidays, changing patterns right</li>
<li>Getting target variable and ARIMA(p,d,q) selection needs competing models</li>
</ul></li>
<li>Most importantly: external validity is a huge problem
<ul>
<li>Stability may easily break down, and there is nothing we can do.</li>
</ul></li>
</ul>


</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">
<p><em>Rios-Avila and Cia</em></p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1280,

        height: 720,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        // For code content inside modals, clipBoardJS needs to be initialized with a container option
        // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>