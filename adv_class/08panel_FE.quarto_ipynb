{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
        "title: \"Panel data and Fixed Effects (Many FE)\"\n",
        "subtitle: \"Are we seeing double?\"\n",
        "author: Fernando Rios-Avila\n",
        "format:\n",
        "  revealjs: \n",
        "    slide-number: true\n",
        "    width: 1500\n",
        "    height: 900\n",
        "    code-fold: true\n",
        "    echo: true\n",
        "    css: styles.css  \n",
        "    theme: serif\n",
        "  pdf: default \n",
        "execute:\n",
        "  freeze: true   \n",
        "---\n",
        "\n",
        "\n",
        "## Re-Cap: Potential outcome Model {.scrollable}\n",
        "\n",
        "In the ideal world, where we can see all possible outcomes and scenarios of your potential treatments, it will be very simple to estimate treatment effects:\n",
        "\n",
        "$$\n",
        "\\delta_i = Y_i(1)-Y_i(0)\n",
        "$$\n",
        "\n",
        "Why does this work??\n",
        "\n",
        "One way to understand this it to imagine that potential outcomes are a function of all observed and unobserved individual characteristics, plust the treatment Status. \n",
        "\n",
        "$$y_i(D)=y_i(X,u,D) \n",
        "$$\n",
        "\n",
        "So when comparing a person with himself (clones or parallel worlds), we know (or at least expect) that everything else is the same, except for the Treatment Status. \n",
        "\n",
        "Differences between the two states are explained only by the treatment!\n",
        "\n",
        "## The Problem and first Solution RCT  \n",
        "\n",
        "We do not observe both States at the same time. People will either be treated or untreated, not both.\n",
        "\n",
        "So what can we do?\n",
        "\n",
        "> **We need to find good counterfactuals!**\n",
        "\n",
        "One way to do so is via RCT, for example using a lottery!\n",
        "\n",
        "> Why does it work? \n",
        "\n",
        "Potential outcomes will be unrelated to treatment, because treatmet is assigned at random.\n",
        "\n",
        "Here, it also means that $X's$ and $u's$ will be similar across groups (because of random assigment)\n",
        "\n",
        "But...you cannot estimatate individual effects, but at least estimate aggregate effects (ATE = ATT = ATU)\n",
        "\n",
        "## Other Solutions?  \n",
        "\n",
        "So RCTs can be very expensive, and difficult to implement after the fact. In those situations, however, you can use observed data to try answering the same questions!.\n",
        "\n",
        "One option? Something we have done before...Regression Analysis!\n",
        "\n",
        "$$y_i = a_0 + \\delta D_i + X_i\\beta + e_i$$\n",
        "\n",
        "The idea is that you directly control for all confounding factors that could be related to $y_i$ and $d_i$.\n",
        "\n",
        "In other words, you add controls until $D_i$ is exogenous! $E(e_i|D)=0$\n",
        "\n",
        "## Implications to the PO model?  \n",
        "\n",
        "- Assumes all individuals have the same outcome structure ($\\beta s$), except for the TE\n",
        "\n",
        "- The treatment is effect is homogenous (no heterogeneity) \n",
        "\n",
        "- and that functional form is correct (for extrapolation)\n",
        "\n",
        "However, explicitly controlling for covariates, balances characteristics (FWL):\n",
        "\n",
        "$$ \n",
        "\\begin{aligned}\n",
        "D_i &= X\\gamma + v_i \\\\\n",
        "y_i &= a_0 + \\delta v_i + u_i \\\\\n",
        "\\delta &=\\frac{1}{N} \\sum \\frac{D_i - X\\gamma}{var(v_i)} y_i\n",
        "\\end{aligned}\n",
        "$$\n",
        "\n",
        "- Treated units will get positive weights, and controls negative weights, with exceptions because of the LPM.\n",
        "\n",
        "- Weights will \"balance Samples\" to estimate ATE.\n",
        "\n",
        "## Controlling for Unobservables\n",
        "\n",
        "![](resources/fefig.jpg)\n",
        "\n",
        "## What if you can See X's\n",
        "\n",
        "Some times, you may have situations where some covariates cannot be observed (Z_i):\n",
        "$$\n",
        "y_i = \\delta D_i +X_i \\beta + Z_i \\gamma + e_i\n",
        "$$\n",
        "\n",
        "If $Z_i$ is unrelated to $D_i$, you are on the clear. If its unrelated to $Y_i$ you are also ok. But what if that doesn happen? \n",
        "\n",
        "> Then you have a problem!\n",
        "\n",
        "You no longer can use regression, because the potential outcomes will no longer be independent of the treatment.\n",
        "\n",
        "you are dooomed!\n",
        "\n",
        "(when would this happen)\n",
        "\n",
        "## Having access to More Data  \n",
        "\n",
        "Solution?: Say you have access to panel data: Same individuals across time:\n",
        "\n",
        "$$\n",
        "y_{it} = \\delta D_{it} +X_{it} \\beta + Z_{it} \\gamma + e_{it}\n",
        "$$\n",
        "\n",
        "If we can't measure $Z_{it}$, and you estimate this using Pool OLS (just simple OLS), you still need the assumption that:\n",
        "\n",
        "$$E(Z_{it}\\gamma + e_{it}|D_it)=0\n",
        "$$\n",
        "\n",
        "But that doesnt solve the problem if $Z_{it}$ is related to $D_it$. \n",
        "\n",
        "One option, in cases like this, is assuming that individual unobservables are **fixed** across time:\n",
        "\n",
        "$$\n",
        "y_{it} = \\delta D_{it} +X_{it} \\beta + Z_{i} \\gamma + e_{it}\n",
        "$$\n",
        "\n",
        "in which case, it may be possible to estimate Treatment effects\n",
        "\n",
        "## Fixed Effects \n",
        "\n",
        "With panel data and assuming unobservables are fixed across time, estimating TE is \"Easy\". Just add Dummies for each individual!\n",
        "\n",
        "$$\n",
        "y_{it}= \\delta D_{it} +X_{it} \\beta + \\sum d_i \\gamma_i + e_{it}\n",
        "$$\n",
        "\n",
        "Here $d_i \\gamma_i$ is our proxy for **ALL** unobserved factors. OLS can be used to estimate ATEs\n",
        "\n",
        "This happens because we can estimate potential outcome under the same assumptions as before. \n",
        "\n",
        "you could, in fact, consider adding fixed effects for all dimensions you consider important to account for:\n",
        "\n",
        "> City, school, region, age, industry, etc\n",
        "\n",
        "The only limitation...how many dummies can your computer handle? What happens internally?\n",
        "\n",
        "## Fixed Effects: Estimation - The variation within  \n",
        "The obvious approach is using dummies. But that can take you only so far (why?), and may create other problems! (excluded variables)\n",
        "\n",
        "The alternative is using the within estimator. Say we take the means across individuals, and use that to substract information from the original regression:\n",
        "\n",
        "$$\n",
        "\\begin{aligned}\n",
        "y_{it} &= \\delta D_{it} +X_{it} \\beta + Z_{i} \\gamma + e_{it} \\\\\n",
        "\\bar y_i &= \\delta \\bar D_i + \\bar X_i \\beta +  Z_{i} \\gamma + \\bar e_i \\\\\n",
        "y_{it}-\\bar y_i = \\tilde y_{it} &=\\delta \\tilde D_{it} + \\tilde X_{it}\\beta+\\tilde e_{it} \n",
        "\\end{aligned}\n",
        "$$\n",
        "\n",
        "Last equation is easier to estimate (no dummies!) however you need within variation. IF unobserved factors are fixed, they will be \"absorbed\".\n",
        "\n",
        "Also, the SE will have to be adjusted for degrees of freedom. (but nothing else)\n",
        "\n",
        "This is nothing else but the use of FWL and regression on residuals.\n",
        "\n",
        "## Dont Forget Random Effects\n",
        "\n",
        "This approach is more efficient than Fixed effects because you don't estimate fixed effects, just the distribution.\n",
        "\n",
        "So how does this affect the estimation:\n",
        "\n",
        "1. Errors have two components. One time fixed $e_i$, and one time variant $u_{it}$. Then total errors will be correlated with themselves across time\n",
        "$$corr(v_{it}, v_{is}) =  corr(e_i+u_{it}, e_i+u_{is}) = \\sigma^2_e\n",
        "$$\n",
        "2. Apply FGLS to eliminating this source of auto-correlation!\n",
        "$$y_{it}-\\lambda \\bar y_i = (X_{it}-\\lambda \\bar X_it) + v_{it}$$\n",
        "\n",
        "But, you need the assumption that unobservables $e_i$ are unrelated to $X's$. (because we are not directly controlling for them). \n",
        "\n",
        "The advantage, however, is that you do no need within variation!\n",
        "\n",
        "## FE vs RE\n",
        "\n",
        "So there are two ways to Analyze data Panel data.\n",
        "\n",
        "- FE: Uses only within variation, is more consistent, but less efficient (too many dummies)\n",
        "- RE: Uses all variation in data, is less consistent (stronger assumptions), but more efficient!\n",
        "\n",
        "**How to choose?**\n",
        "\n",
        "The Standard approach is to apply a Hausan Test:\n",
        "\n",
        "> H0:$\\beta^{FE} = \\beta^{RE}$ using Chi2\n",
        "\n",
        "If they are not different (H0 cannot be rejected), then choose RE (efficient). If they are different then choose FE (consistent)\n",
        "\n",
        "## More Fixed effects: TWFE - NWFE? \n",
        "\n",
        "With multiple sets of fixed effects (individual, time, cohort, region, etc), you can still use dummies to add them to the model.\n",
        "\n",
        "But, you can apply something similar to the previous approach:\n",
        "\n",
        "$$\n",
        "\\begin{aligned}\n",
        "y_{it} &= \\delta D_{it}+x_{it}\\beta + \\gamma_i + \\gamma_t + e_{it} \\\\\n",
        "\\bar y_i &= \\bar D_i +\\bar x_{i}\\beta + \\gamma_i + E(\\gamma_t|i) + \\bar e_i \\\\\n",
        "\\bar y_t &= \\bar D_t +\\bar x_{t}\\beta + E(\\gamma_i|t) + \\gamma_t + \\bar e_t \\\\\n",
        "\\bar y &= \\bar D +\\bar x\\beta + E(\\gamma_i) + E(\\gamma_t)+ \\bar e \\\\\n",
        "\\tilde y_{it} &= y_{it}-\\bar y_i - \\bar y_t + \\bar y\n",
        "\\end{aligned}\n",
        "$$\n",
        "\n",
        "So one can estimate the following:\n",
        "\n",
        "$$\n",
        "\\tilde y_{it} = \\delta \\tilde D_{it} + \\tilde X_{it} \\beta + \\tilde e_{it}\n",
        "$$\n",
        "\n",
        "This eliminates FE for both time and individual (if panel is balanced)\n",
        "\n",
        "## Second Option:\n",
        "\n",
        "Alternatively, you can just run regressions of residuals:\n",
        "\n",
        "$$\n",
        "w_{it} = \\gamma^w_i+\\gamma^w_t+rw_{it}\n",
        "$$\n",
        "\n",
        "and make regressions using the residuals. (Demeaning also works, but its an iterative process)\n",
        "\n",
        "## Stata Example{.scrollable}"
      ],
      "id": "37c7e44d"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "*| echo: false\n",
        "#delimit;\n",
        "set linesize 150;\n",
        "#delimit cr"
      ],
      "id": "95a51cc8",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "*| echo: true\n",
        "#delimit;\n",
        "frause school93_98, clear;\n",
        "xtset schid year;\n",
        "qui:reg math4 lunch lenrol lrexpp                     ; est sto m1;\n",
        "qui:xtreg math4 lunch lenrol lrexpp                   ; est sto m2;\n",
        "qui:xtreg math4 lunch lenrol lrexpp, fe               ; est sto m3;\n",
        "qui:reghdfe math4 lunch lenrol lrexpp, abs(schid)     ; est sto m4;\n",
        "qui:reghdfe math4 lunch lenrol lrexpp, abs(schid year); est sto m5;\n",
        "esttab m1 m2 m3 m4 m5, mtitle(ols re fe refe1 refe2) compress se b(3);\n",
        "hausman m3 m2;"
      ],
      "id": "9245cbfa",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "## Correlated Random Effects\n",
        "\n",
        "Random effects model may produce inconsistent results, because it assumes unobserved factors are uncorrelated to characteristics. \n",
        "\n",
        "Fixed effects controls for individual effects explicitly, or via demeaning.\n",
        "\n",
        "A 3rd approach is known as CRE model. A more explicit modeling of the unobserved but fixed components.\n",
        "\n",
        "1. Call the unobserved component $a_i$, and say we suspect it may be related with individual characteristics. \n",
        "2. Because $a_i$ is constant over time, it may be reasonable assuming its correlated with individual average characteristics:\n",
        "   $$a_i = a + \\bar X_i \\gamma + r_i\n",
        "   $${#eq-m1}\n",
        "\n",
        "By construction, $r_i$ and $X_{it} \\&  \\bar X_i$ will be uncorrelated. So lets just add that to the main model\n",
        "\n",
        "## CRE\n",
        "\n",
        "Lets add @eq-m1 to our main equation.\n",
        "$$\n",
        "y_i = \\beta X_{it} +  \\theta Z_{i} + \\bar X_i \\gamma + r_i + e_{it}\n",
        "$$\n",
        "\n",
        "This equation can now be estimated using RE, because it already allows controls for the correlation of unobserved factors and the individual effects.\n",
        "\n",
        "You can also estimate the model using *pool* OLS, clustering errors at individual level. \n",
        "\n",
        "**Result**: \n",
        "\n",
        "- you now have a model that allows for time variant and time fixed components, that is consistent as FE (same coefficients).\n",
        "\n",
        "**Uses**: \n",
        "\n",
        "- Simpler way to test for FE vs RE (are the $\\gamma 's$ significant?)\n",
        "- there is no need for within variation for any variable! (just overall variation)\n",
        "\n",
        "## cre in Stata {.scrollable}\n"
      ],
      "id": "356f2b28"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "*| echo: true\n",
        "#delimit cr\n",
        "frause school93_98, clear\n",
        "reghdfe math4 lunch lenrol lrexpp, abs(schid year) cluster(schid)\n",
        "** Experimental\n",
        "cre, abs(schid year): reg math4 lunch lenrol lrexpp, cluster(schid)"
      ],
      "id": "d568a244",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "## Caveats: Not everything is solved using FE\n",
        "\n",
        "- While FE allows you do control for unobserve but time fixed factors, it will Not help you if those factors are time varying.\n",
        "\n",
        "  if $e_{it}$ is different across treated and control groups $D_{it}=0,1$ then TE cannot be estimated.\n",
        "\n",
        "  This could happen if cases of reverse causality or \n",
        "\n",
        "- Because it depends strongly on within variation, it will be more sensitive to measurement errors.  Specifically:\n",
        "\n",
        "$$\\beta^{fe} = \\beta * \\left(1-\\frac{\\sigma_v^2}{(\\sigma^2_v+\\sigma^2_x)(1-\\rho_x)}\\right)\n",
        "$$\n",
        "\n",
        "In other words. when $X$ has strong autocorrelation (Stable treatment), the measurement error effect is far larger!\n",
        "\n",
        "## Caveats: FE makes things harder to analyze\n",
        "\n",
        "- When using a single FE, OLS using within variation to identify the slope coefficients.\n",
        "    How does a change in X's (compared to the average) affect changes in the outcomes (respect to averages)\n",
        "\n",
        "- When using Two Fixed effects (individuals and time) identification becomes tricky:\n",
        "$$\\tilde y_{it} = y_{it}-\\bar y_i - \\bar y_t + \\bar y  $$\n",
        "\n",
        "We are looking for variation across time but also across individuals.\n",
        "\n",
        "> we are using changes in outcome that are different from the average changes in the sample.\n",
        "\n",
        "- with Multiple FE, same story...we are trying to exploit variation across multiple dimensions! Difficult to understand\n",
        "\n",
        "## Caveats: Some times, the variation may be wrong:\n",
        "\n",
        "Consider:\n",
        "\n",
        "$$y_{it} = a_i + a_t + \\delta D_{it} + e_{it}$$\n",
        "\n",
        "If $D_it$ changes only for some people at the same time, we are good.\n",
        "\n",
        "- The variation comes from comparing individuals (before and after) (time variation), who were treated and untreated (individual effects)\n",
        "\n",
        "But if $D_{it}$ changes at different times for different people, we have a problem. \n",
        "\n",
        "- Who is being compared??? \n",
        "  - Those before and after (fine) to those with Status change (D=0 -> D=1) to those whos status do not change! (D=0 to D=0) or (D=1 to D=1)\n",
        "\n",
        "We will discuss this problem again when talking about DID\n",
        "\n",
        "## Income, Schooling, and Ability: \n",
        "### Evidence from a New Sample of Identical Twins\n",
        " by\n",
        "\n",
        "**Orley Ashenfelter** and **Cecilia Rouse**\n",
        "\n",
        "## Motivation: \n",
        "### In search of Returns to Education\n",
        "\n",
        "This paper aims to identify returns of education abstracting from the impact of innate ability.\n",
        "\n",
        "In their framework, ability is mostly explained by genetics, thus to control for it, the authors use a sample \n",
        "of identical twins, to \"absorb\" unobserved genetics using FE.\n",
        "\n",
        "They address some of the problems inherited to FE estimation\n",
        "\n",
        "## The model\n",
        "\n",
        "- The theoretical model described states that all individuals have an optimal level of Schooling, such that maximizes the his/her returns. \n",
        "- However, Total schooling may be affected by measurement or optimization errors. \n",
        "- Schooling will be directly affected by returns to education, but also by the ability of students.\n",
        "\n",
        "In their framework, for the twins setup, (log)earnings will be determined by:\n",
        "\n",
        "$$\n",
        "\\begin{aligned}\n",
        "y_{1j}=A_j + b_j S_{1j} + \\gamma X_j + e_{1j} \\\\\n",
        "y_{2j}=A_j + b_j S_{2j} + \\gamma X_j + e_{2j} \n",
        "\\end{aligned}\n",
        "$$\n",
        "\n",
        "## The model\n",
        "\n",
        "Because ability is related to schooling, they suggest using the following:\n",
        "\n",
        "$$\n",
        "y_{ij}=\\lambda(0.5(S_{1j}+S_{2j}) + b_j S_{1j} + \\gamma X_j + v_j+ e_{ij} \n",
        "$$\n",
        "\n",
        "Which is the equivalent to CRE. Or estimate the fixed effects equivalent:\n",
        "\n",
        "$$y_{1j} - y_{2j} = b(S_{2j}-S_{1j}) + e_{2j} - e_{2j}\n",
        "$$\n",
        "\n",
        "The later is a First difference, rather than FE estimator, but they both identical when T=2.\n",
        "\n",
        "- An additional model the authors use is one where returns to education could be related to ability. \n",
        "- Or where ability is measured/proxied by parents education. (which is fixed across twins)\n",
        "\n",
        "## Data\n",
        "\n",
        "![](resources\\pfe1.png)\n",
        "\n",
        "## OLS\n",
        "\n",
        "![](resources\\pfe2.png)\n",
        "\n",
        "## FE-RE-CRE?\n",
        "\n",
        "![](resources\\pfe3.png){height=800px width=1300px}\n",
        "\n",
        "## Heterogeneity\n",
        "\n",
        "![](resources\\pfe4.png)\n",
        "\n",
        "# Next Class (Friday) Instrumental Variables!"
      ],
      "id": "db936067"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "nbstata",
      "language": "stata",
      "display_name": "Stata (nbstata)",
      "path": "C:\\Users\\Fernando\\AppData\\Roaming\\jupyter\\kernels\\nbstata"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}